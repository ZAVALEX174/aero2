console.log("–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø: –†–∞—Å—á–µ—Ç –≤–æ–∑–¥—É—Ö–∞ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é –ø–æ—Ç–æ–∫–æ–≤");
const APP_CONFIG={GRID_SIZE:20,SNAP_RADIUS:15,MAX_UNDO_STEPS:50,DEFAULT_LINE_COLOR:'#4A00E0',DEFAULT_LINE_WIDTH:5,MAX_IMAGE_SIZE:40,NODE_THRESHOLD:5,NODE_LOCK_DEFAULT:true,MAX_OBJECTS:1000,SPATIAL_GRID_SIZE:100,MAX_CALCULATION_TIME:5000};
let canvas,isDrawingLine=!1,isContinuousLineMode=!1,lineStartPoint=null,previewLine=null,lastLineEndPoint=null,currentEditingLine=null,currentImageData=null,gridVisible=!0,undoStack=[],redoStack=[],contextMenuVisible=!1,autoSplitMode=!0,lineSplitMode='AUTO',altKeyPressed=!1,intersectionPoints=[],intersectionVisuals=[],currentEditingObject=null,currentEditingObjectType=null,isCalculatingAirVolumes=!1,connectionNodes=new Map,nodeLockEnabled=APP_CONFIG.NODE_LOCK_DEFAULT,cachedLines=null,cachedImages=null,cachedAllObjects=null,cacheDirty=!0,spatialGrid=new Map,spatialGridDirty=!0,isUpdatingConnections=!1,isProcessingEvents=!1,isDrawingImage=!1,renderTimeout=null,updateGraphTimeout=null,updateTextsTimeout=null,performanceMetrics={lastRenderTime:0,lastIntersectionTime:0,lastGraphUpdateTime:0,objectCount:0};
const defaultImages=[{id:'fan1',name:'–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä –æ—Å–Ω–æ–≤–Ω–æ–π',icon:'üåÄ',path:'./img/fan.png',type:'fan'},{id:'fan2',name:'–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä',icon:'üåÄ',path:'./img/fan2.png',type:'fan'},{id:'fire',name:'–î–∞—Ç—á–∏–∫ –ø–æ–∂–∞—Ä–Ω—ã–π',icon:'üî•',path:'./img/fire.png',type:'fire'},{id:'fire2',name:'–ü–æ–∂–∞—Ä–Ω—ã–π –≥–∏–¥—Ä–∞–Ω—Ç',icon:'üî•',path:'./img/pozarniigidrant.png',type:'fire'},{id:'fire3',name:'–ü–æ–∂–∞—Ä–Ω—ã–π —Å–∫–ª–∞–¥',icon:'üî•',path:'./img/scladprotivopozar.png',type:'fire'},{id:'valve',name:'–î–≤–µ—Ä—å –ó–∞–∫—Ä—ã—Ç–∞—è',icon:'üîß',path:'./img/dvercloses.png',type:'valve'},{id:'valve2',name:'–î–≤–µ—Ä—å –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∞—è –æ—Ç–∫—Ä—ã—Ç–∞—è',icon:'üîß',path:'./img/dveropenmetall.png',type:'valve'},{id:'valve3',name:'–î–≤–µ—Ä—å —Å –≤–µ–Ω—Ç —Ä–µ—à–æ—Ç–∫–æ–π',icon:'üîß',path:'./img/dverventrech.png',type:'valve'},{id:'valve4',name:'–î–≤–µ—Ä—å –¥–µ—Ä–µ–≤—è–Ω–Ω–∞—è —Å –≤–µ–Ω—Ç –æ–∫–Ω–æ–º',icon:'üîß',path:'./img/dverwentoknowood.png',type:'valve'},{id:'valve5',name:'–ü–µ—Ä–µ–º—ã—á–∫–∞ –±–µ—Ç–æ–Ω–Ω–∞—è',icon:'üîß',path:'./img/petemichkabeton.png',type:'valve'},{id:'valve6',name:'–ü–µ—Ä–µ–º—ã—á–∫–∞ –∫–∏—Ä–ø–∏—á–Ω–∞—è',icon:'üîß',path:'./img/petemichkakirpich.png',type:'valve'},{id:'valve7',name:'–ü–µ—Ä–µ–º—ã—á–∫–∞ –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∞—è',icon:'üîß',path:'./img/petemichkametall.png',type:'valve'},{id:'valve8',name:'–ü–µ—Ä–µ–º—ã—á–∫–∞ –¥–µ—Ä–µ–≤—è–Ω–Ω–∞—è',icon:'üîß',path:'./img/petemichkawood.png',type:'valve'},{id:'valve9',name:'–ü—Ä–æ—Ö–æ–¥',icon:'üîß',path:'./img/prohod.png',type:'valve'},{id:'valve10',name:'–ó–∞–ø–∞—Å–Ω–æ–π –≤—Ö–æ–¥',icon:'üîß',path:'./img/zapasvhod.png',type:'valve'},{id:'pump',name:'–ù–∞—Å–æ—Å –ø–æ–≥—Ä—É–∂–Ω–æ–π',icon:'‚öôÔ∏è',path:'./img/nanospogruznoi.png',type:'pump'},{id:'pump2',name:'–ù–∞—Å–æ—Å–Ω–∞—è —Å—Ç–∞–Ω—Ü–∏—è',icon:'‚öôÔ∏è',path:'./img/nasosnayastancia.png',type:'pump'},{id:'sensor',name:'–°–∞–º–æ—Ö–æ–¥–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ',icon:'üì°',path:'./img/samohodnoe.png',type:'sensor'},{id:'sensor2',name:'–õ—é–¥–∏',icon:'üì°',path:'./img/people.png',type:'sensor'},{id:'sensor3',name:'–¢–µ–ª–µ—Ñ–æ–Ω',icon:'üì°',path:'./img/phone.png',type:'sensor'},{id:'sensor4',name:'–í–∑—Ä—ã–≤–Ω—ã–µ —Ä–∞–±–æ—Ç—ã',icon:'üì°',path:'./img/vzrivnieraboti.png',type:'sensor'},{id:'sensor5',name:'–ú–∞—Å—Å–æ–≤—ã–µ –≤–∑—Ä—ã–≤–Ω—ã–µ —Ä–∞–±–æ—Ç—ã',icon:'üì°',path:'./img/massovievzivniepaboti.png',type:'sensor'},{id:'sensor6',name:'–ú–µ–¥–ø—É–Ω–∫—Ç',icon:'üì°',path:'./img/medpunkt.png',type:'sensor'},{id:'sensor7',name:'–ù–∞–¥—à–∞—Ö—Ç–Ω–æ–µ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ',icon:'üì°',path:'./img/nadshahtnoe.png',type:'sensor'}];
let allImages=[...defaultImages];
try{const e=CanvasRenderingContext2D.prototype,t=Object.getOwnPropertyDescriptor(e,'textBaseline'),n=t.set;Object.defineProperty(e,'textBaseline',{set:function(e){const r='alphabetical'===e?'alphabetic':e;return n.call(this,r)},get:t.get,configurable:!0})}catch(e){console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–∫—Å –¥–ª—è Chrome:",e)}
function roundTo5(e){return null==e?e:Math.round((e+Number.EPSILON)*1e5)/1e5}
function formatTo5(e){return null==e?'0.00000':roundTo5(e).toFixed(5)}
function resetCalculationFlags(){isCalculatingAirVolumes=!1,isDrawingImage=!1,isProcessingEvents=!1,console.log('–§–ª–∞–≥–∏ —Ä–∞—Å—á–µ—Ç–∞ —Å–±—Ä–æ—à–µ–Ω—ã')}
function invalidateCache(){cacheDirty=!0,spatialGridDirty=!0}
function getCachedObjects(){if(!cacheDirty&&cachedAllObjects)return{lines:cachedLines,images:cachedImages,all:cachedAllObjects};const e=performance.now(),t=canvas.getObjects();cachedAllObjects=t,cachedLines=[],cachedImages=[];for(let e=0;e<t.length;e++){const n=t[e];'line'===n.type&&'grid-line'!==n.id&&!n.isPreview?cachedLines.push(n):'image'===n.type&&n.properties&&cachedImages.push(n)}return cacheDirty=!1,performanceMetrics.objectCount=t.length;const n=performance.now();return n-e>10&&console.warn(`–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–Ω—è–ª–æ ${(n-e).toFixed(2)}ms`),{lines:cachedLines,images:cachedImages,all:cachedAllObjects}}
function getCachedLines(){return!cacheDirty&&cachedLines?cachedLines:(getCachedObjects(),cachedLines)}
function getCachedImages(){return!cacheDirty&&cachedImages?cachedImages:(getCachedObjects(),cachedImages)}
function updateSpatialGrid(){if(!spatialGridDirty)return;const e=performance.now();spatialGrid.clear();const t=getCachedLines();for(let n=0;n<t.length;n++){const r=t[n],i=Math.min(r.x1,r.x2),o=Math.max(r.x1,r.x2),s=Math.min(r.y1,r.y2),a=Math.max(r.y1,r.y2),l=Math.floor(i/APP_CONFIG.SPATIAL_GRID_SIZE),c=Math.floor(o/APP_CONFIG.SPATIAL_GRID_SIZE),u=Math.floor(s/APP_CONFIG.SPATIAL_GRID_SIZE),d=Math.floor(a/APP_CONFIG.SPATIAL_GRID_SIZE);for(let e=l;e<=c;e++)for(let t=u;t<=d;t++){const r=e+','+t;spatialGrid.has(r)||spatialGrid.set(r,[]),spatialGrid.get(r).push(n)}}spatialGridDirty=!1,performanceMetrics.lastGraphUpdateTime=performance.now()-e}
function findLinesInArea(e,t,n=APP_CONFIG.SNAP_RADIUS){updateSpatialGrid();const r=Math.floor(e/APP_CONFIG.SPATIAL_GRID_SIZE),i=Math.floor(t/APP_CONFIG.SPATIAL_GRID_SIZE),o=getCachedLines(),s=[],a=new Set;for(let e=-1;e<=1;e++)for(let l=-1;l<=1;l++){const c=r+e+','+(i+l),u=spatialGrid.get(c);if(u)for(const c of u)if(!a.has(c)){a.add(c);const u=o[c],d=findClosestPointOnLine({x:e,y:t},u),p=Math.sqrt(Math.pow(e-d.x,2)+Math.pow(t-d.y,2));p<n&&s.push({line:u,point:d,param:d.param,distance:p})}}return s.sort((e,t)=>e.distance-t.distance),s}
function scheduleRender(){renderTimeout&&cancelAnimationFrame(renderTimeout),renderTimeout=requestAnimationFrame(()=>{canvas.renderAll(),renderTimeout=null})}
function debounceFunction(e,t){let n;return function(...r){clearTimeout(n),n=setTimeout(()=>e(...r),t)}}
function throttleFunction(e,t){let n;return function(){const r=arguments,i=this;n||(e.apply(i,r),n=!0,setTimeout(()=>n=!1,t))}}
document.addEventListener('DOMContentLoaded',function(){initializeCanvas(),updateImageLibrary(),updateStatus(),initializeModals(),setupKeyboardShortcuts(),setupAltKeyTracking();const e=document.getElementById('nodeLockBtn');e&&(e.innerHTML=nodeLockEnabled?'<span>üîí</span> –£–∑–ª—ã: –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–´':'<span>üîì</span> –£–∑–ª—ã: –†–ê–ó–ë–õ–û–ö–ò–†–û–í–ê–ù–´',e.addEventListener('click',toggleNodeLock)),document.getElementById('calculateAirBtn')?.addEventListener('click',function(){if(!isCalculatingAirVolumes){console.log('–ó–∞–ø—É—Å–∫ —Ä–∞—Å—á–µ—Ç–∞ –æ–±—ä–µ–º–æ–≤ –≤–æ–∑–¥—É—Ö–∞ –ø–æ –∫–ª–∏–∫—É –∫–Ω–æ–ø–∫–∏...');confirm('–†–∞–∑–±–∏—Ç—å –≤—Å–µ –ª–∏–Ω–∏–∏ –ø–µ—Ä–µ–¥ —Ä–∞—Å—á–µ—Ç–æ–º –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞?')&&splitAllLinesBeforeCalculation();calculateAirVolumesForAllLines(!0)}else showNotification('–†–∞—Å—á–µ—Ç —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...','warning')}),document.getElementById('analyzePointsBtn')?.addEventListener('click',function(){console.log('=== –ó–ê–ü–£–°–ö –ê–ù–ê–õ–ò–ó–ê –¢–û–ß–ï–ö –ü–ï–†–ï–°–ï–ß–ï–ù–ò–Ø ==='),analyzeIntersectionPoints()});const t=document.createElement('button');t.innerHTML='<span>üß™</span> –°–ª–æ–∂–Ω—ã–π —Ç–µ—Å—Ç',t.className='toolbar-btn',t.title='–°–æ–∑–¥–∞—Ç—å —Å–ª–æ–∂–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π',t.onclick=createTestScenarioComplex,document.querySelector('.toolbar')?.appendChild(t);const n=document.createElement('button');n.innerHTML='<span>‚öñÔ∏è</span> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å',n.className='toolbar-btn',n.title='–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ—Ç–æ–∫–æ–≤ –≤ —Å–µ—Ç–∏',n.onclick=checkFlowBalance,document.querySelector('.toolbar')?.appendChild(n),window.addEventListener('resize',handleResize),console.log('–†–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —á–µ—Ä—Ç–µ–∂–µ–π –∑–∞–≥—Ä—É–∂–µ–Ω!'),setInterval(updatePerformanceMetrics,5e3)});
function updatePerformanceMetrics(){let e=document.getElementById('performanceMetrics');e||(e=document.createElement('div'),e.id='performanceMetrics',e.style.cssText='position:fixed;bottom:10px;right:10px;background:rgba(0,0,0,0.7);color:white;padding:5px;font-size:10px;z-index:1000;border-radius:3px;',document.body.appendChild(e));const t=getCachedLines().length,n=getCachedImages().length;e.innerHTML=`
    üìä –û–±—ä–µ–∫—Ç–æ–≤: ${performanceMetrics.objectCount}<br>
    üìè –õ–∏–Ω–∏–π: ${t}<br>
    üè≠ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: ${n}<br>
    ‚ö° –ì—Ä–∞—Ñ: ${performanceMetrics.lastGraphUpdateTime.toFixed(1)}ms<br>
    ‚úÇÔ∏è –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è: ${performanceMetrics.lastIntersectionTime.toFixed(1)}ms
  `}
function initializeCanvas(){canvas=new fabric.Canvas('fabric-canvas',{backgroundColor:'#ffffff',preserveObjectStacking:!0,selection:!0,selectionColor:'rgba(74, 0, 224, 0.3)',selectionBorderColor:'#4A00E0',selectionLineWidth:2,renderOnAddRemove:!0,skipOffscreen:!0,enableRetinaScaling:!1}),updateCanvasSize(),drawGrid(APP_CONFIG.GRID_SIZE),setupCanvasEvents()}
function updateCanvasSize(){if(!canvas)return;const e=document.getElementById('canvas-wrapper');if(!e)return;const t=e.clientWidth,n=e.clientHeight;canvas.setDimensions({width:t,height:n}),gridVisible&&drawGrid(APP_CONFIG.GRID_SIZE),scheduleRender()}
function handleResize(){debounceFunction(updateCanvasSize,250)}
function drawGrid(e=APP_CONFIG.GRID_SIZE){const t=canvas?canvas.getObjects().filter(e=>'grid-group'===e.id):[];t.forEach(e=>canvas.remove(e));if(!gridVisible||!canvas)return;const n=canvas.width||1200,r=canvas.height||700,i=[];for(let t=0;t<=n;t+=e)i.push(new fabric.Line([t,0,t,r],{stroke:'rgba(224, 224, 224, 0.5)',strokeWidth:1,selectable:!1,evented:!1,id:'grid-line'}));for(let t=0;t<=r;t+=e)i.push(new fabric.Line([0,t,n,t],{stroke:'rgba(224, 224, 224, 0.5)',strokeWidth:1,selectable:!1,evented:!1,id:'grid-line'}));const o=new fabric.Group(i,{selectable:!1,evented:!1,id:'grid-group'});canvas.add(o),canvas.sendToBack(o),canvas.renderAll()}
function toggleGrid(){gridVisible=!gridVisible;const e=document.getElementById('gridToggleBtn');gridVisible?(e.innerHTML='<span>üî≤</span> –°–µ—Ç–∫–∞ (–í–ö–õ)',drawGrid(APP_CONFIG.GRID_SIZE),showNotification('–°–µ—Ç–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞','success')):(e.innerHTML='<span>üî≤</span> –°–µ—Ç–∫–∞ (–í–´–ö–õ)',drawGrid(APP_CONFIG.GRID_SIZE),showNotification('–°–µ—Ç–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞','info')),canvas.renderAll()}
function snapToGrid(e,t=APP_CONFIG.GRID_SIZE){return roundTo5(Math.round(e/t)*t)}
function getObjectCenter(e){const t=roundTo5(e.width*e.scaleX),n=roundTo5(e.height*e.scaleY);return{x:roundTo5(e.left),y:roundTo5(e.top),width:t,height:n}}
function getObjectRect(e){const t=roundTo5(e.width*e.scaleX),n=roundTo5(e.height*e.scaleY);return{left:roundTo5(e.left-t/2),right:roundTo5(e.left+t/2),top:roundTo5(e.top-n/2),bottom:roundTo5(e.top+n/2)}}
function findClosestPointOnLine(e,t){const n=t.x1,r=t.y1,i=t.x2,o=t.y2,s=roundTo5(e.x-n),a=roundTo5(e.y-r),l=roundTo5(i-n),c=roundTo5(o-r),u=roundTo5(s*l+a*c),d=roundTo5(l*l+c*c);let p=-1;0!==d&&(p=roundTo5(u/d));let f,h;if(p<0)f=n,h=r;else if(p>1)f=i,h=o;else f=roundTo5(n+p*l),h=roundTo5(r+p*c);const m=roundTo5(f-e.x),g=roundTo5(h-e.y),v=roundTo5(Math.sqrt(m*m+g*g));return{x:roundTo5(f),y:roundTo5(h),param:p,distance:v}}
function findClosestPointOnObjectEdge(e,t){if(!e||!t)return null;const n=getObjectRect(e),r=getObjectCenter(e);if('image'===e.type||'rect'===e.type){const i=n.left,o=n.right,s=n.top,a=n.bottom,l=t.x>=i&&t.x<=o&&t.y>=s&&t.y<=a;if(l){const e=roundTo5(Math.abs(t.x-i)),n=roundTo5(Math.abs(t.x-o)),r=roundTo5(Math.abs(t.y-s)),a=roundTo5(Math.abs(t.y-bottom)),l=roundTo5(Math.min(e,n,r,a));if(l===e)return{x:roundTo5(i),y:roundTo5(t.y),edge:'left'};if(l===n)return{x:roundTo5(o),y:roundTo5(t.y),edge:'right'};if(l===r)return{x:roundTo5(t.x),y:roundTo5(s),edge:'top'};return{x:roundTo5(t.x),y:roundTo5(a),edge:'bottom'}}let c=roundTo5(Math.max(i,Math.min(t.x,o))),u=roundTo5(Math.max(s,Math.min(t.y,a)));const d=roundTo5(Math.abs(t.x-i)),p=roundTo5(Math.abs(t.x-o)),f=roundTo5(Math.abs(t.y-s)),h=roundTo5(Math.abs(t.y-a)),m=roundTo5(Math.min(d,p,f,h));return(m===d||m===p)&&(u=roundTo5(t.y)),(m===f||m===h)&&(c=roundTo5(t.x)),c=roundTo5(Math.max(i,Math.min(c,o))),u=roundTo5(Math.max(s,Math.min(u,a))),{x:c,y:u,edge:'nearest'}}return{x:roundTo5(Math.max(n.left,Math.min(t.x,n.right))),y:roundTo5(Math.max(n.top,Math.min(t.y,n.bottom))),edge:'center'}}
function buildConnectionGraph(){if(isProcessingEvents)return;isProcessingEvents=!0;const e=performance.now();try{connectionNodes.clear();const t=getCachedLines(),n=new Map;t.forEach(e=>{const t=`${roundTo5(e.x1)}_${roundTo5(e.y1)}`,r=`${roundTo5(e.x2)}_${roundTo5(e.y2)}`;n.has(t)||n.set(t,{x:roundTo5(e.x1),y:roundTo5(e.y1),lines:[],locked:nodeLockEnabled});const i=n.get(t);let o=!1;for(let t=0;t<i.lines.length;t++)if(i.lines[t].line.id===e.id){o=!0;break}o||i.lines.push({line:e,isStart:!0,originalX:roundTo5(e.x1),originalY:roundTo5(e.y1)}),n.has(r)||n.set(r,{x:roundTo5(e.x2),y:roundTo5(e.y2),lines:[],locked:nodeLockEnabled});const s=n.get(r);o=!1;for(let t=0;t<s.lines.length;t++)if(s.lines[t].line.id===e.id){o=!0;break}o||s.lines.push({line:e,isStart:!1,originalX:roundTo5(e.x2),originalY:roundTo5(e.y2})});for(const[e,t]of n.entries())t.lines.length>1&&connectionNodes.set(e,t);const r=performance.now();r-e>50&&console.warn(`–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∞ –∑–∞–Ω—è–ª–æ ${(r-e).toFixed(2)}ms`)}finally{isProcessingEvents=!1}}
function updateConnectionGraph(){isUpdatingConnections||(isUpdatingConnections=!0,updateGraphTimeout&&clearTimeout(updateGraphTimeout),updateGraphTimeout=setTimeout(()=>{try{buildConnectionGraph(),bringIntersectionPointsToFront()}catch(e){console.error('–û—à–∏–±–∫–∞ –≤ updateConnectionGraph:',e)}finally{isUpdatingConnections=!1,updateGraphTimeout=null}},100))}
function toggleNodeLock(){nodeLockEnabled=!nodeLockEnabled,connectionNodes.forEach(e=>{e.locked=nodeLockEnabled});const e=document.getElementById('nodeLockBtn');e&&(e.innerHTML=nodeLockEnabled?'<span>üîí</span> –£–∑–ª—ã: –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù–´':'<span>üîì</span> –£–∑–ª—ã: –†–ê–ó–ë–õ–û–ö–ò–†–û–í–ê–ù–´'),showNotification(nodeLockEnabled?'–£–∑–ª—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã - –ª–∏–Ω–∏–∏ –Ω–µ–ª—å–∑—è —Ä–∞–∑–¥–µ–ª—è—Ç—å':'–£–∑–ª—ã —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã - –º–æ–∂–Ω–æ —Ä–∞–∑–¥–µ–ª—è—Ç—å –ª–∏–Ω–∏–∏',nodeLockEnabled?'warning':'info'),updateConnectionGraph(),scheduleRender()}
function isPointInLockedNode(e,t,n=APP_CONFIG.NODE_THRESHOLD){for(const[r,i]of connectionNodes.entries())if(i.locked){const r=Math.sqrt(Math.pow(e-i.x,2)+Math.pow(t-i.y,2));if(r<n)return{node:i,distance:r}}return null}
function createOrUpdateAirVolumeText(e){if(e.airVolumeText)try{canvas.remove(e.airVolumeText)}catch(e){}e.airVolumeText=null;if(!e.properties||void 0===e.properties.airVolume||null===e.properties.airVolume)return;try{const t=(e.x1+e.x2)/2,n=(e.y1+e.y2)/2,r=Math.atan2(e.y2-e.y1,e.x2-e.x1),i=r*(180/Math.PI),o=25,s=Math.sin(r)*o,a=-Math.cos(r)*o,l=roundTo5(e.properties.airVolume),c=l.toFixed(3),u={left:t+s,top:n+a,fontSize:12,fontFamily:'Arial, sans-serif',fill:'#2d3436',fontWeight:'bold',textBackgroundColor:'rgba(255, 255, 255, 0.9)',padding:4,selectable:!1,evented:!1,originX:'center',originY:'center',angle:i,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,hasControls:!1,hasBorders:!1},d=new fabric.Text(c+' –º¬≥/—Å',u);e.airVolumeText=d,canvas.add(d),d.bringToFront()}catch(t){console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ –æ–±—ä–µ–º–∞ –≤–æ–∑–¥—É—Ö–∞:',t)}}
function updateAllAirVolumeTexts(){updateTextsTimeout&&clearTimeout(updateTextsTimeout),updateTextsTimeout=setTimeout(()=>{const e=getCachedLines();let t=0;for(let n=0;n<e.length;n++){const r=e[n];try{r.properties&&void 0!==r.properties.airVolume&&(createOrUpdateAirVolumeText(r),t++)}catch(e){console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ –ª–∏–Ω–∏–∏:',e,r)}}scheduleRender(),updateTextsTimeout=null},100)}
function removeAirVolumeText(e){e.airVolumeText&&(canvas.remove(e.airVolumeText),e.airVolumeText=null)}
function calculateLinePerimeter(e){return roundTo5(3.8*Math.sqrt(e))}
function calculateAirResistance(e,t,n,r){return 0===r?0:roundTo5(e*t*n/r)}
function calculateAllLineProperties(e){if(!e.properties)return;const t=e.properties;void 0!==t.crossSectionalArea&&(t.perimeter=calculateLinePerimeter(t.crossSectionalArea)),void 0!==t.roughnessCoefficient&&void 0!==t.perimeter&&void 0!==t.passageLength&&void 0!==t.crossSectionalArea&&(t.airResistance=calculateAirResistance(t.roughnessCoefficient,t.perimeter,t.passageLength,t.crossSectionalArea));return t}
function normalizeLineProperties(e){if(!e.properties)return;const t=e.properties;void 0!==t.L&&(t.passageLength=roundTo5(t.L),delete t.L),void 0!==t.K&&(t.crossSectionalArea=roundTo5(t.K),delete t.K),void 0!==t.I&&(t.roughnessCoefficient=roundTo5(t.I),delete t.I),calculateAllLineProperties(e),e.set('properties',t)}
function generateLineId(){return'line_'+Date.now()+'_'+Math.random().toString(36).substr(2,9)}
function splitLineAtPoint(e,t){const n=isPointInLockedNode(t.x,t.y);if(n&&n.node.locked)return showNotification('–ù–µ–ª—å–∑—è —Ä–∞–∑–¥–µ–ª–∏—Ç—å –ª–∏–Ω–∏—é –≤ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —É–∑–ª–µ!','error'),null;const r=findClosestPointOnLine(t,e);if(r.distance>10)return null;const i=roundTo5(t.x-e.x1),o=roundTo5(t.y-e.y1),s=roundTo5(t.x-e.x2),a=roundTo5(t.y-e.y2),l=roundTo5(Math.sqrt(i*i+o*o)),c=roundTo5(Math.sqrt(s*s+a*a));if(l<5||c<5)return null;const u=roundTo5(Math.sqrt(Math.pow(e.x2-e.x1,2)+Math.pow(e.y2-e.y1,2)));if(u<10)return null;normalizeLineProperties(e);const d=e.properties||{},p=roundTo5(l/u),f=roundTo5(c/u),h=generateLineId(),m=generateLineId(),g=JSON.parse(JSON.stringify(d)),v=JSON.parse(JSON.stringify(d));g.name=(d.name||'–õ–∏–Ω–∏—è')+' (—á–∞—Å—Ç—å 1)',v.name=(d.name||'–õ–∏–Ω–∏—è')+' (—á–∞—Å—Ç—å 2)',g.length=l,v.length=c,g.passageLength=roundTo5((d.passageLength||.5)*p),v.passageLength=roundTo5((d.passageLength||.5)*f),d.crossSectionalArea&&d.roughnessCoefficient&&(g.airResistance=calculateAirResistance(d.roughnessCoefficient,calculateLinePerimeter(d.crossSectionalArea),g.passageLength,d.crossSectionalArea),v.airResistance=calculateAirResistance(d.roughnessCoefficient,calculateLinePerimeter(d.crossSectionalArea),v.passageLength,d.crossSectionalArea)),void 0!==d.airVolume&&(e.lineStartsFromObject&&e.startObject?(g.airVolume=roundTo5(d.airVolume),v.airVolume=0):(g.airVolume=roundTo5(d.airVolume*p),v.airVolume=roundTo5(d.airVolume*f))),delete g.startsFromObject,delete v.startsFromObject;const y=new fabric.Line([e.x1,e.y1,t.x,t.y],{stroke:e.stroke,strokeWidth:e.strokeWidth,strokeDashArray:e.strokeDashArray,fill:!1,strokeLineCap:'round',hasControls:!0,hasBorders:!0,lockRotation:!1,id:h,properties:g}),b=new fabric.Line([t.x,t.y,e.x2,e.y2],{stroke:e.stroke,strokeWidth:e.strokeWidth,strokeDashArray:e.strokeDashArray,fill:!1,strokeLineCap:'round',hasControls:!0,hasBorders:!0,lockRotation:!1,id:m,properties:v});return e.lineStartsFromObject&&e.startObject&&e.x1===y.x1&&e.y1===y.y1&&(y.lineStartsFromObject=!0,y.startObject=e.startObject,y.properties&&(y.properties.startsFromObject={objectId:e.startObject.id||e.startObject._id,objectType:e.startObject.type,objectName:e.startObject.properties?.name||'–û–±—ä–µ–∫—Ç'})),{line1:y,line2:b}}
function calculateAirVolumesForAllLines(e){if(!e)return console.log('–†–∞—Å—á–µ—Ç –≤—ã–∑–≤–∞–Ω –Ω–µ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º'),!1;if(isCalculatingAirVolumes)return showNotification('–†–∞—Å—á–µ—Ç —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...','warning'),!1;isCalculatingAirVolumes=!0,console.log('=== –ù–ê–ß–ò–ù–ê–ï–ú –†–ê–°–ß–ï–¢ –í–û–ó–î–£–®–ù–´–• –ü–û–¢–û–ö–û–í ===');try{const t=getCachedLines(),n=getCachedImages();t.forEach(e=>{e.properties&&(e.properties.airVolume=0)});const r=buildFlowGraph(t,n),i=findAirSources(r);if(0===i.length)return showNotification('–ù–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –≤–æ–∑–¥—É—Ö–∞! –î–æ–±–∞–≤—å—Ç–µ –æ–±—ä–µ–∫—Ç—ã —Å –æ–±—ä–µ–º–æ–º –≤–æ–∑–¥—É—Ö–∞ > 0','warning'),isCalculatingAirVolumes=!1,!1;console.log(`–ù–∞–π–¥–µ–Ω–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤: ${i.length}`),i.forEach((e,t)=>{console.log(`  –ò—Å—Ç–æ—á–Ω–∏–∫ ${t+1}: —É–∑–µ–ª ${e.nodeId}, –æ–±—ä–µ–º ${e.volume.toFixed(3)} –º¬≥/—Å`)});const o=calculateFlowsFromSources(r,i);applyFlowResults(t,o);const s=checkNetworkBalance(t);updateAllAirVolumeTexts(),scheduleRender(),updatePropertiesPanel();const a=calculateTotalFlow(t);return console.log(`\n=== –†–ê–°–ß–ï–¢ –ó–ê–í–ï–†–®–ï–ù ===`),console.log(`–°—É–º–º–∞—Ä–Ω—ã–π –ø–æ—Ç–æ–∫: ${a.toFixed(3)} –º¬≥/—Å`),console.log(`–ù–µ—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É–∑–ª–æ–≤: ${s.unbalancedCount}`),0===s.unbalancedCount?showNotification(`–†–∞—Å—á–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! –°—É–º–º–∞—Ä–Ω—ã–π –ø–æ—Ç–æ–∫: ${a.toFixed(3)} –º¬≥/—Å`,'success'):showNotification(`–†–∞—Å—á–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω, –Ω–æ –µ—Å—Ç—å ${s.unbalancedCount} –Ω–µ—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É–∑–ª–æ–≤`,'warning'),!0}catch(e){return console.error('–û–®–ò–ë–ö–ê –≤ calculateAirVolumesForAllLines:',e),showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ: '+e.message,'error'),!1}finally{isCalculatingAirVolumes=!1}}
function buildFlowGraph(e,t){const n=new Map,r=new Map;return e.forEach(e=>{const t=`${roundTo5(e.x1)}_${roundTo5(e.y1)}`,i=`${roundTo5(e.x2)}_${roundTo5(e.y2)}`;n.has(t)||n.set(t,{id:t,x:roundTo5(e.x1),y:roundTo5(e.y1),incomingEdges:[],outgoingEdges:[],objects:[],totalIncomingFlow:0,totalOutgoingFlow:0,processed:!1,distance:1/0}),n.has(i)||n.set(i,{id:i,x:roundTo5(e.x2),y:roundTo5(e.y2),incomingEdges:[],outgoingEdges:[],objects:[],totalIncomingFlow:0,totalOutgoingFlow:0,processed:!1,distance:1/0});const o=n.get(t),s=n.get(i),a={id:e.id,line:e,fromNode:t,toNode:i,resistance:e.properties?.airResistance||1,length:Math.sqrt(Math.pow(e.x2-e.x1,2)+Math.pow(e.y2-e.y1,2)),flow:0};r.set(e.id,a),o.outgoingEdges.push(a),s.incomingEdges.push(a)}),t.forEach(e=>{const t=getObjectCenter(e),i=e.properties?.airVolume||0,o=e.properties?.airResistance||1;let s=null,a=1/0;n.forEach((e,t)=>{const l=Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2));l<a&&l<50&&(a=l,s=e)}),s&&s.objects.push({object:e,name:e.properties?.name||'–û–±—ä–µ–∫—Ç',airVolume:i,airResistance:o})}),{nodes:n,edges:r}}
function findAirSources(e){const t=[];return e.nodes.forEach((n,r)=>{const i=n.objects.some(e=>e.airVolume>0);if(i){let i=0;n.objects.forEach(e=>{e.airVolume>0&&(i+=e.airVolume)}),t.push({nodeId:r,node:n,volume:i,type:'object'}),n.objects.forEach(e=>{e.airResistance>1&&e.airVolume>0&&(i/=e.airResistance)}),console.log(`–ò—Å—Ç–æ—á–Ω–∏–∫ –≤ —É–∑–ª–µ ${r}: –æ–±—ä–µ–º ${i.toFixed(3)} –º¬≥/—Å`)}else 0===n.incomingEdges.length&&n.outgoingEdges.length>0&&t.push({nodeId:r,node:n,volume:0,type:'network_start'})}),t}
function calculateFlowsFromSources(e,t){const n=new Map,r=new Map;e.nodes.forEach((e,t)=>{r.set(t,1/0),e.processed=!1});const i=[];t.forEach(e=>{r.set(e.nodeId,0),i.push({nodeId:e.nodeId,node:e.node,incomingVolume:e.volume})}),i.sort((e,t)=>t.incomingVolume-e.incomingVolume),console.log('\n=== –ü–û–†–Ø–î–û–ö –û–ë–†–ê–ë–û–¢–ö–ò –£–ó–õ–û–í ===');while(i.length>0){const o=i.shift(),s=o.nodeId,a=o.node,l=o.incomingVolume;if(a.processed){console.log(`–£–∑–µ–ª ${s} —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ—Ç–æ–∫ ${l.toFixed(3)}`);a.outgoingEdges.forEach(e=>{const t=n.get(e.id)||0,r=a.outgoingEdges.reduce((e,t)=>e+(n.get(t.id)||0),0);if(r>0){const i=t/r,o=l*i;n.set(e.id,t+o)}});continue}a.processed=!0,console.log(`\n–û–±—Ä–∞–±–æ—Ç–∫–∞ —É–∑–ª–∞ ${s}: –¥–æ—Å—Ç—É–ø–Ω—ã–π –æ–±—ä–µ–º = ${l.toFixed(3)} –º¬≥/—Å`),console.log(`  –í—Ö–æ–¥—è—â–∏—Ö –ª–∏–Ω–∏–π: ${a.incomingEdges.length}, –ò—Å—Ö–æ–¥—è—â–∏—Ö: ${a.outgoingEdges.length}`);if(0===a.outgoingEdges.length){console.log(`  –£–∑–µ–ª ${s} - —Ç—É–ø–∏–∫, –ø–æ—Ç–æ–∫ –Ω–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è`);continue}let c=1;a.objects.forEach(e=>{e.airResistance>1&&(c/=e.airResistance,console.log(`  –£—á–∏—Ç—ã–≤–∞–µ–º —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ ${e.name}: ${e.airResistance}`))}),l*=c;if(1===a.outgoingEdges.length){const e=a.outgoingEdges[0],t=l;n.set(e.id,(n.get(e.id)||0)+t),console.log(`  –û–¥–Ω–∞ –∏—Å—Ö–æ–¥—è—â–∞—è –ª–∏–Ω–∏—è: –ø–æ—Ç–æ–∫ ${t.toFixed(3)} –º¬≥/—Å`);const r=e.toNode,o=e.nodes.get(r);o&&(r.set(r,Math.min(r.get(s)+1,r.get(r))),i.push({nodeId:r,node:o,incomingVolume:t}))}else if(a.outgoingEdges.length>1){let e=0,t=[];a.outgoingEdges.forEach(r=>{const i=r.resistance>0?1/r.resistance:1;e+=i,t.push({edge:r,conductivity:i})}),console.log(`  –°—É–º–º–∞—Ä–Ω–∞—è –ø—Ä–æ–≤–æ–¥–∏–º–æ—Å—Ç—å: ${e.toFixed(3)}`),t.forEach(o=>{const c=l*(o.conductivity/e);n.set(o.edge.id,(n.get(o.edge.id)||0)+c),console.log(`  –õ–∏–Ω–∏—è ${o.edge.id}: –ø–æ—Ç–æ–∫ ${c.toFixed(3)} –º¬≥/—Å (–ø—Ä–æ–≤–æ–¥–∏–º–æ—Å—Ç—å ${o.conductivity.toFixed(3)})`);const u=o.edge.toNode,d=a.nodes.get(u);d&&(r.set(u,Math.min(r.get(s)+1,r.get(u))),i.push({nodeId:u,node:d,incomingVolume:c}))})}}return n}
function applyFlowResults(e,t){let n=0;return e.forEach(e=>{const r=t.get(e.id);if(void 0!==r){e.properties||(e.properties={});const i=e.properties.airVolume||0,o=roundTo5(r);Math.abs(i-o)>.001&&(e.properties.airVolume=o,e.set('properties',e.properties),n++)}}),console.log(`\n–û–±–Ω–æ–≤–ª–µ–Ω–æ ${n} –ª–∏–Ω–∏–π –∏–∑ ${e.length}`),n}
function checkNetworkBalance(e){console.log('\n=== –ü–†–û–í–ï–†–ö–ê –ë–ê–õ–ê–ù–°–ê ===');const t=new Map;let n=0,r=0;e.forEach(e=>{const i=`${roundTo5(e.x1)}_${roundTo5(e.y1)}`,o=`${roundTo5(e.x2)}_${roundTo5(e.y2)}`,s=e.properties?.airVolume||0;r+=s,t.has(i)||t.set(i,{incoming:0,outgoing:0,id:i}),t.has(o)||t.set(o,{incoming:0,outgoing:0,id:o}),t.get(i).outgoing+=s,t.get(o).incoming+=s}),console.log(`–û–±—â–∏–π –ø–æ—Ç–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ: ${r.toFixed(3)} –º¬≥/—Å`),t.forEach((e,t)=>{const r=Math.abs(e.incoming-e.outgoing);r>.001&&(console.log(`üî¥ –£–∑–µ–ª ${t}: —Ä–∞–∑–±–∞–ª–∞–Ω—Å ${r.toFixed(4)}`),console.log(`   –í—Ö–æ–¥—è—â–∏–µ: ${e.incoming.toFixed(4)}, –ò—Å—Ö–æ–¥—è—â–∏–µ: ${e.outgoing.toFixed(4)}`),n++)}),0===n?console.log('‚úÖ –í—Å–µ —É–∑–ª—ã —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω—ã!'):console.log(`‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ ${n} –Ω–µ—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É–∑–ª–æ–≤`),{unbalancedCount:n,totalFlow:r}}
function calculateTotalFlow(e){let t=0;return e.forEach(e=>{e.properties?.airVolume&&(t+=e.properties.airVolume)}),roundTo5(t)}
function checkFlowBalance(){const e=getCachedLines(),t=checkNetworkBalance(e);return 0===t.unbalancedCount?showNotification(`–ë–∞–ª–∞–Ω—Å —Å–æ–±–ª—é–¥–µ–Ω! –û–±—â–∏–π –ø–æ—Ç–æ–∫: ${t.totalFlow.toFixed(3)} –º¬≥/—Å`,'success'):showNotification(`–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ ${t.unbalancedCount} –Ω–µ—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É–∑–ª–æ–≤`,'warning'),t.unbalancedCount}
function createTestScenarioComplex(){clearCanvas(),console.log('–°–æ–∑–¥–∞–Ω–∏–µ —Å–ª–æ–∂–Ω–æ–≥–æ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è...');const e=[{x:100,y:100,volume:10,name:'–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä 1'},{x:400,y:300,volume:5,name:'–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä 2'},{x:700,y:100,volume:8,name:'–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä 3'}],t=[{x1:100,y1:100,x2:200,y2:100,name:'–õ–∏–Ω–∏—è 1-2'},{x1:200,y1:100,x2:200,y2:200,name:'–õ–∏–Ω–∏—è 2-3'},{x1:200,y1:100,x2:300,y2:100,name:'–õ–∏–Ω–∏—è 2-4'},{x1:200,y1:200,x2:300,y2:100,name:'–õ–∏–Ω–∏—è 3-4'},{x1:400,y1:300,x2:400,y2:200,name:'–õ–∏–Ω–∏—è 5-6'},{x1:400,y1:200,x2:300,y2:100,name:'–õ–∏–Ω–∏—è 6-4'},{x1:400,y1:300,x2:500,y2:300,name:'–õ–∏–Ω–∏—è 5-7'},{x1:700,y1:100,x2:600,y2:100,name:'–õ–∏–Ω–∏—è 8-9'},{x1:600,y1:100,x2:500,y2:300,name:'–õ–∏–Ω–∏—è 9-7'},{x1:500,y1:300,x2:300,y2:100,name:'–õ–∏–Ω–∏—è 7-4'},{x1:300,y1:100,x2:400,y2:100,name:'–õ–∏–Ω–∏—è 4-10'},{x1:400,y1:100,x2:500,y2:100,name:'–õ–∏–Ω–∏—è 10-11'},{x1:500,y1:100,x2:600,y2:100,name:'–õ–∏–Ω–∏—è 11-9'}];e.forEach((n,r)=>{fabric.Image.fromURL('./img/fan.png',function(i){i.set({left:n.x,top:n.y,scaleX:.5,scaleY:.5,properties:{name:n.name,type:'fan',airVolume:n.volume,airResistance:1}}),canvas.add(i),0===r&&(lineObj=new fabric.Line([n.x,n.y,t[0].x2,t[0].y2],{stroke:'#4A00E0',strokeWidth:5,properties:{name:t[0].name,airResistance:1+2*Math.random(),airVolume:0},id:'line_'+Date.now()+'_'+r}),canvas.add(lineObj),lineObj.lineStartsFromObject=!0,lineObj.startObject=i)})}),setTimeout(()=>{const n=[...t.slice(1)];n.sort(()=>.5-Math.random()),n.forEach((e,t)=>{setTimeout(()=>{const r=new fabric.Line([e.x1,e.y1,e.x2,e.y2],{stroke:'#4A00E0',strokeWidth:5,properties:{name:e.name,airResistance:1+2*Math.random(),airVolume:0},id:'line_'+Date.now()+'_'+(t+3)});canvas.add(r),t===n.length-1&&setTimeout(()=>{invalidateCache(),updateConnectionGraph(),showNotification('–°–ª–æ–∂–Ω—ã–π —Ç–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π —Å–æ–∑–¥–∞–Ω. –ù–∞–∂–º–∏—Ç–µ "–†–∞—Å—á–µ—Ç –≤–æ–∑–¥—É—Ö–∞"','success')},500)},50*t)})},1e3)}
function splitAllLinesBeforeCalculation(){return console.log('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –≤—Å–µ—Ö –ª–∏–Ω–∏–π –ø–µ—Ä–µ–¥ —Ä–∞—Å—á–µ—Ç–æ–º...'),splitAllLines(),splitAllLinesAtObjectCenters(),updateConnectionGraph(),showNotification('–í—Å–µ –ª–∏–Ω–∏–∏ —Ä–∞–∑–±–∏—Ç—ã –ø–µ—Ä–µ–¥ —Ä–∞—Å—á–µ—Ç–æ–º','info'),!0}
function setupCanvasEvents(){canvas&&(canvas.on('mouse:down',handleCanvasMouseDown),canvas.on('mouse:move',throttleFunction(handleCanvasMouseMove,16)),canvas.on('mouse:out',handleCanvasMouseOut),canvas.on('mouse:dblclick',handleCanvasDoubleClick),canvas.on('selection:created',updatePropertiesPanel),canvas.on('selection:updated',updatePropertiesPanel),canvas.on('selection:cleared',updatePropertiesPanel),canvas.on('object:added',handleObjectAdded),canvas.on('object:modified',handleObjectModified),canvas.on('object:removed',handleObjectRemoved))}
function findLineAtPoint(e,t=APP_CONFIG.SNAP_RADIUS){const n=findLinesInArea(e.x,e.y,t);if(n.length>0){const r=n[0],i=r.param<.05||r.param>.95;return{line:r.line,point:r.point,param:r.param,isEnd:i}}return null}
function handleCanvasMouseDown(e){const t=canvas.getPointer(e.e);if(e.e.shiftKey&&currentImageData)return void setTimeout(()=>{addImageAtPosition(t.x,t.y)},10);if(isDrawingLine)return void handleLineDrawingStart(e,t);if(2===e.e.button){const n=canvas.getActiveObject();n&&showContextMenu(t.x,t.y),e.e.preventDefault()}if(!isDrawingLine&&e.target&&'line'===e.target.type&&0===e.e.button){const n=canvas.getPointer(e.e),r=e.target,i=Math.hypot(n.x-r.x1,n.y-r.y1),o=Math.hypot(n.x-r.x2,n.y-r.y2),s=15;i<s||o<s?(lineDragState.pending=!0,lineDragState.pendingEnd=i<o?'start':'end'):(lineDragState.pending=!0,lineDragState.pendingEnd='whole'),lineDragState.pendingLine=r}}
function handleLineDrawingStart(e,t){if(!lineStartPoint){let n,r,i=null;if(altKeyPressed&&e.target){const o=e.target,s=findClosestPointOnObjectEdge(o,t);s&&(i={x:roundTo5(s.x),y:roundTo5(s.y),object:o,edgePoint:!0},n=roundTo5(s.x),r=roundTo5(s.y))}i||(n=roundTo5(snapToGrid(t.x,APP_CONFIG.GRID_SIZE)),r=roundTo5(snapToGrid(t.y,APP_CONFIG.GRID_SIZE)));const o=isPointInLockedNode(n,r);if(o&&(n=o.node.x,r=o.node.y,getCachedImages().forEach(e=>{const t=getObjectCenter(e),n=Math.sqrt(Math.pow(t.x-o.node.x,2)+Math.pow(t.y-o.node.y,2));n<30&&objectsAtNode.push(e)}),objectsAtNode.length>0&&!i&&(i={x:n,y:r,object:objectsAtNode[0],edgePoint:!0})),!altKeyPressed&&'MANUAL'!==lineSplitMode&&!o){const o=findLineAtPoint(t);if(o&&!o.isEnd){const s=splitLineAtPoint(o.line,o.point);if(s){saveToUndoStack(),canvas.remove(o.line),removeAirVolumeText(o.line),canvas.add(s.line1),canvas.add(s.line2),createOrUpdateAirVolumeText(s.line1),createOrUpdateAirVolumeText(s.line2),lineStartPoint={x:o.point.x,y:o.point.y,lineSplit:!0},previewLine=new fabric.Line([lineStartPoint.x,lineStartPoint.y,n,r],{stroke:APP_CONFIG.DEFAULT_LINE_COLOR,strokeWidth:2,strokeDashArray:[5,5],selectable:!1,evented:!1,id:'preview-line',isPreview:!0}),canvas.add(previewLine);return void setTimeout(()=>{invalidateCache(),updateConnectionGraph(),updateAllAirVolumeTexts()},50)}lineStartPoint={x:n,y:r,...i||{}}}else o&&o.isEnd?lineStartPoint={x:o.point.x,y:o.point.y,...i||{}}:lineStartPoint={x:n,y:r,...i||{}}}else lineStartPoint={x:n,y:r,...i||{}};previewLine=new fabric.Line([lineStartPoint.x,lineStartPoint.y,n,r],{stroke:APP_CONFIG.DEFAULT_LINE_COLOR,strokeWidth:2,strokeDashArray:[5,5],selectable:!1,evented:!1,id:'preview-line',isPreview:!0}),canvas.add(previewLine)}else handleLineDrawingEnd(e,t)}
function handleLineDrawingEnd(e,t){let n,r,i=null;if(altKeyPressed&&e.target){const o=e.target,s=findClosestPointOnObjectEdge(o,t);s&&(i={x:roundTo5(s.x),y:roundTo5(s.y),object:o,edgePoint:!0},n=roundTo5(s.x),r=roundTo5(s.y))}i||(n=roundTo5(snapToGrid(t.x,APP_CONFIG.GRID_SIZE)),r=roundTo5(snapToGrid(t.y,APP_CONFIG.GRID_SIZE)));const o=isPointInLockedNode(n,r);if(o&&(n=o.node.x,r=o.node.y,console.log('–ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É —É–∑–ª—É')),!altKeyPressed&&!o){const e=findLineAtPoint({x:n,y:r});if(e&&!e.isEnd){const t=splitLineAtPoint(e.line,e.point);t&&(saveToUndoStack(),canvas.remove(e.line),removeAirVolumeText(e.line),canvas.add(t.line1),canvas.add(t.line2),createOrUpdateAirVolumeText(t.line1),createOrUpdateAirVolumeText(t.line2),n=e.point.x,r=e.point.y)}}const s=roundTo5(Math.sqrt(Math.pow(n-lineStartPoint.x,2)+Math.pow(r-lineStartPoint.y,2))),a=generateLineId(),l=roundTo5(parseFloat(document.getElementById('propertyPassageLength')?.value)||.5),c=roundTo5(parseFloat(document.getElementById('propertyRoughnessCoefficient')?.value)||.015),u=roundTo5(parseFloat(document.getElementById('propertyCrossSectionalArea')?.value)||10),d=calculateLinePerimeter(u),p=calculateAirResistance(c,d,l,u);let f=0;lineStartPoint.object&&lineStartPoint.object.properties&&void 0!==lineStartPoint.object.properties.airVolume&&(f=roundTo5(lineStartPoint.object.properties.airVolume));const h=new fabric.Line([lineStartPoint.x,lineStartPoint.y,n,r],{stroke:APP_CONFIG.DEFAULT_LINE_COLOR,strokeWidth:APP_CONFIG.DEFAULT_LINE_WIDTH,fill:!1,strokeLineCap:'round',hasControls:!0,hasBorders:!0,lockRotation:!1,id:a,properties:{name:`–õ–∏–Ω–∏—è ${getCachedLines().length+1}`,passageLength:l,roughnessCoefficient:c,crossSectionalArea:u,airResistance:p,airVolume:f,perimeter:d,length:s,startPoint:{x:lineStartPoint.x,y:lineStartPoint.y},endPoint:{x:n,y:r}}});lineStartPoint.object&&(h.lineStartsFromObject=!0,h.startObject=lineStartPoint.object,h.properties.startsFromObject={objectId:lineStartPoint.object.id||lineStartPoint.object._id,objectType:lineStartPoint.object.type,objectName:lineStartPoint.object.properties?.name||'–û–±—ä–µ–∫—Ç',edgePoint:lineStartPoint.edgePoint||!1},setTimeout(()=>createIntersectionPointForLineStart(h),10)),previewLine&&(canvas.remove(previewLine),previewLine=null),canvas.add(h),canvas.setActiveObject(h),calculateAllLineProperties(h),invalidateCache(),buildConnectionGraph(),updateAllAirVolumeTexts(),scheduleRender(),updatePropertiesPanel(),updateStatus(),isContinuousLineMode?(lineStartPoint={x:n,y:r},e.target&&altKeyPressed?(lineStartPoint.object=e.target,lineStartPoint.edgePoint=!0):(isPointInLockedNode(n,r)&&(objectsAtNode=[],getCachedImages().forEach(e=>{const t=getObjectCenter(e),n=Math.sqrt(Math.pow(t.x-lineStartPoint.x,2)+Math.pow(t.y-lineStartPoint.y,2));n<30&&objectsAtNode.push(e)}),objectsAtNode.length>0&&(lineStartPoint.object=objectsAtNode[0],lineStartPoint.edgePoint=!0)),previewLine=new fabric.Line([lineStartPoint.x,lineStartPoint.y,n,r],{stroke:APP_CONFIG.DEFAULT_LINE_COLOR,strokeWidth:2,strokeDashArray:[5,5],selectable:!1,evented:!1,id:'preview-line',isPreview:!0}),canvas.add(previewLine),setTimeout(()=>{const e=getCachedLines(),t=e[e.length-1];t&&t.properties&&console.log(`–°–æ–∑–¥–∞–Ω–∞ –ª–∏–Ω–∏—è ${t.id} —Å –æ–±—ä–µ–º–æ–º ${t.properties.airVolume}`)},50)):deactivateAllModes()}
function handleCanvasMouseMove(e){if(!isDrawingLine||!lineStartPoint)return;const t=canvas.getPointer(e.e),n=roundTo5(snapToGrid(t.x,APP_CONFIG.GRID_SIZE)),r=roundTo5(snapToGrid(t.y,APP_CONFIG.GRID_SIZE)),i=canvas.getObjects().find(e=>'preview-line'===e.id);i?(i.set({x2:n,y2:r}),i.setCoords()):lineStartPoint&&new fabric.Line([lineStartPoint.x,lineStartPoint.y,n,r],{stroke:APP_CONFIG.DEFAULT_LINE_COLOR,strokeWidth:2,strokeDashArray:[5,5],selectable:!1,evented:!1,id:'preview-line',isPreview:!0});canvas.add(newPreviewLine),requestAnimationFrame(()=>{canvas.requestRenderAll()})}
function handleCanvasMouseOut(){altKeyPressed&&isDrawingLine&&(canvas.forEachObject(e=>{'line'!==e.type&&'grid-group'!==e.id&&'grid-line'!==e.id&&(e.set('stroke',null),e.set('strokeWidth',0))}),scheduleRender())}
function handleCanvasDoubleClick(e){e.target&&(canvas.setActiveObject(e.target),showObjectPropertiesModal())}
function handleObjectAdded(e){e.target&&'intersection-point'!==e.target.id&&'intersection-point-label'!==e.target.id&&'air-volume-text'!==e.target.id&&(invalidateCache(),setTimeout(()=>{bringIntersectionPointsToFront(),updateAllAirVolumeTexts()},100))}
function handleObjectModified(e){e.target&&'line'===e.target.type&&(e.target.properties&&calculateAllLineProperties(e.target),createOrUpdateAirVolumeText(e.target),invalidateCache(),setTimeout(()=>{updateConnectionGraph()},100))}
function handleObjectRemoved(e){e.target&&'line'===e.target.type&&removeAirVolumeText(e.target),invalidateCache(),setTimeout(()=>{updateConnectionGraph()},100)}
function activateLineDrawing(){deactivateAllModes(),cleanupPreviewLines(),isDrawingLine=!0,canvas.defaultCursor='crosshair',canvas.selection=!1,canvas.forEachObject(e=>{'grid-group'!==e.id&&'grid-line'!==e.id&&(e.selectable=!1)}),showNotification('–†–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è –ª–∏–Ω–∏–∏. –ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –Ω–∞—á–∞–ª–∞, –∑–∞—Ç–µ–º –¥–ª—è –∫–æ–Ω—Ü–∞. ESC –¥–ª—è –æ—Ç–º–µ–Ω—ã.','info')}
function cleanupPreviewLines(){canvas.getObjects().filter(e=>'preview-line'===e.id).forEach(e=>{canvas.remove(e)})}
function deactivateAllModes(){isDrawingLine=!1;const e=canvas.getObjects().find(e=>'preview-line'===e.id);e&&canvas.remove(e),previewLine=null,lineStartPoint=null,lastLineEndPoint=null,canvas.defaultCursor='default',canvas.selection=!0,canvas.forEachObject(e=>{'grid-group'!==e.id&&'grid-line'!==e.id&&(e.selectable=!0)}),updateStatus()}
function toggleContinuousMode(){isContinuousLineMode=!isContinuousLineMode;const e=document.getElementById('continuousModeBtn');isContinuousLineMode?(e.innerHTML='<span>üîó</span> –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π (–í–ö–õ)',showNotification('–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω','success')):(e.innerHTML='<span>üîó</span> –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π (–í–´–ö–õ)',showNotification('–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π —Ä–µ–∂–∏–º –≤—ã–∫–ª—é—á–µ–Ω','info'))}
function toggleAutoSplitMode(){autoSplitMode=!autoSplitMode;const e=document.getElementById('autoSplitBtn');autoSplitMode?(e.innerHTML='<span>‚ö°</span> –ê–≤—Ç–æ—Ä–∞–∑–±–∏–≤–∫–∞ (–í–ö–õ)',showNotification('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ª–∏–Ω–∏–π –≤–∫–ª—é—á–µ–Ω–æ','success')):(e.innerHTML='<span>‚ö°</span> –ê–≤—Ç–æ—Ä–∞–∑–±–∏–≤–∫–∞ (–í–´–ö–õ)',showNotification('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ª–∏–Ω–∏–π –æ—Ç–∫–ª—é—á–µ–Ω–æ','info'))}
function toggleLineSplitMode(){lineSplitMode='AUTO'===lineSplitMode?(lineSplitMode='MANUAL',document.getElementById('lineSplitModeBtn').innerHTML='<span>üéØ</span> –†–µ–∂–∏–º: –†–£–ß–ù–û–ô',showNotification('–†–µ–∂–∏–º —Ä–∞–∑–±–∏–µ–Ω–∏—è: –†–£–ß–ù–û–ô','info')):(lineSplitMode='AUTO',document.getElementById('lineSplitModeBtn').innerHTML='<span>üéØ</span> –†–µ–∂–∏–º: –ê–í–¢–û',showNotification('–†–µ–∂–∏–º —Ä–∞–∑–±–∏–µ–Ω–∏—è: –ê–í–¢–û','info'))}
function updateImageLibrary(){const e=document.getElementById('imageLibraryGrid');if(!e)return;e.innerHTML='',allImages.forEach(t=>{const n=document.createElement('button');n.className='image-item',n.innerHTML=`<img src="${t.path}" alt="${t.name}" loading="lazy"><div class="image-item-name">${t.name}</div>`,n.onclick=()=>activateImagePlacementMode(t),e.appendChild(n)})}
function activateImagePlacementMode(e){deactivateAllModes(),currentImageData=e,document.querySelectorAll('.image-item').forEach(e=>e.classList.remove('active')),event&&event.target&&event.target.closest('.image-item').classList.add('active'),canvas.defaultCursor='crosshair',canvas.selection=!1,showNotification(`–†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: ${e.name}. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Ö–æ–ª—Å—Ç –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è.`,'info')}
function addImageAtPosition(e,t){if(!currentImageData)return void showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ!','error');isDrawingImage=!0,fabric.Image.fromURL(currentImageData.path,function(n){const r=n.width||100,i=n.height||100,o=roundTo5(Math.min(APP_CONFIG.MAX_IMAGE_SIZE/r,APP_CONFIG.MAX_IMAGE_SIZE/i,1)),s={name:currentImageData.name,type:currentImageData.type||'default',imageId:currentImageData.id,imagePath:currentImageData.path,width:roundTo5(r*o),height:roundTo5(i*o),airVolume:null,airResistance:null};n.set({left:roundTo5(snapToGrid(e,APP_CONFIG.GRID_SIZE)),top:roundTo5(snapToGrid(t,APP_CONFIG.GRID_SIZE)),scaleX:o,scaleY:o,hasControls:!0,hasBorders:!0,lockUniScaling:!1,selectable:!0,originX:'center',originY:'center',properties:s}),saveToUndoStack(),canvas.add(n),canvas.setActiveObject(n),canvas.renderAll(),autoSplitMode&&setTimeout(()=>{splitLinesAtImagePosition(n),canvas.renderAll()},50),updatePropertiesPanel(),updateStatus(),showNotification(`${currentImageData.name} –¥–æ–±–∞–≤–ª–µ–Ω`,'success'),setTimeout(()=>{isDrawingImage=!1},100)},{crossOrigin:'anonymous'})}
function findAllIntersections(){const e=performance.now(),t=getCachedLines(),n=getCachedImages(),r=[];for(let e=0;e<t.length;e++)for(let n=e+1;n<t.length;n++){const i=lineIntersection(t[e],t[n]);i&&r.push(i)}for(let e=0;e<t.length;e++){const i=t[e];for(let e=0;e<n.length;e++){const o=n[e],s=getObjectCenter(o),a=findClosestPointOnLine(s,i);if(a.param>=0&&a.param<=1){const e=roundTo5(Math.sqrt(Math.pow(a.x-s.x,2)+Math.pow(a.y-s.y,2))),t=roundTo5(Math.max(o.width*o.scaleX,o.height*o.scaleY)/2);e<=t&&r.push({x:roundTo5(a.x),y:roundTo5(a.y),line1:i,object:o,type:'object-center',param:roundTo5(a.param),distance:e})}}}return performanceMetrics.lastIntersectionTime=performance.now()-e,r}
function lineIntersection(e,t){if(e===t)return null;const n=e.x1,r=e.y1,i=e.x2,o=e.y2,s=t.x1,a=t.y1,l=t.x2,c=t.y2,u=(c-a)*(i-n)-(l-s)*(o-r);if(Math.abs(u)<1e-6)return null;const d=((l-s)*(r-a)-(c-a)*(n-s))/u,p=((i-n)*(r-a)-(o-r)*(n-s))/u;if(d>=0&&d<=1&&p>=0&&p<=1){const e=n+d*(i-n),t=r+d*(o-r);return{x:roundTo5(e),y:roundTo5(t),ua:roundTo5(d),ub:roundTo5(p),line1:e,line2:t,type:'line-line'}}return null}
function splitAllLines(){const e=performance.now();clearIntersectionPoints();const t=findAllIntersections();intersectionPoints=t,t.forEach((e,t)=>{createIntersectionPoint(e.x,e.y,t,e)});const n=[...getCachedLines()],r=[],i=[];n.forEach(e=>{const n=[];t.forEach(t=>{if(t.line1===e||t.line2===e){const r=`${roundTo5(t.x)}_${roundTo5(t.y)}`,i=Math.sqrt(Math.pow(t.x-e.x1,2)+Math.pow(t.y-e.y1,2));n.some(e=>e.key===r)||n.push({x:t.x,y:t.y,key:r,distance:i})}}),n.length>0&&(n.sort((e,t)=>e.distance-t.distance);let o={x:e.x1,y:e.y1},s=[];for(const t of n){const n=Math.sqrt(Math.pow(t.x-o.x,2)+Math.pow(t.y-o.y,2));if(n>5){const i=n/e.properties?.length||1,l=JSON.parse(JSON.stringify(e.properties||{}));l.length=n,l.passageLength=roundTo5((e.properties?.passageLength||.5)*i),l.airVolume=roundTo5((e.properties?.airVolume||0)*i),delete l.startsFromObject;const c=generateLineId(),u=new fabric.Line([o.x,o.y,t.x,t.y],{stroke:e.stroke,strokeWidth:e.strokeWidth,properties:l,id:c});s.push(u),o={x:t.x,y:t.y}}}const a=Math.sqrt(Math.pow(e.x2-o.x,2)+Math.pow(e.y2-o.y,2));if(a>5){const t=a/e.properties?.length||1,n=JSON.parse(JSON.stringify(e.properties||{}));n.length=a,n.passageLength=roundTo5((e.properties?.passageLength||.5)*t),n.airVolume=roundTo5((e.properties?.airVolume||0)*t),delete n.startsFromObject;const r=generateLineId(),l=new fabric.Line([o.x,o.y,e.x2,e.y2],{stroke:e.stroke,strokeWidth:e.strokeWidth,properties:n,id:r});s.push(l)}s.length>1&&(i.push(e),s.forEach(e=>r.push(e)))}),i.length>0?(saveToUndoStack(),i.forEach(e=>{canvas.remove(e),removeAirVolumeText(e)}),r.forEach(e=>{canvas.add(e),createOrUpdateAirVolumeText(e)}),invalidateCache(),setTimeout(()=>{updateConnectionGraph(),updateAllAirVolumeTexts()},100),scheduleRender(),bringIntersectionPointsToFront(),performanceMetrics.lastIntersectionTime=performance.now()-e,showNotification(`–†–∞–∑–¥–µ–ª–µ–Ω–æ ${i.length} –ª–∏–Ω–∏–π –Ω–∞ ${r.length} —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –∑–∞ ${(performance.now()-e).toFixed(0)}ms`,'success')):showNotification('–õ–∏–Ω–∏–π –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ','info')}
function splitAllLinesAtObjectCenters(){const e=getCachedLines(),t=getCachedImages();let n=0;e.forEach(r=>{const i=[];t.forEach(e=>{const t=getObjectCenter(e),o=findClosestPointOnLine(t,r);if(o.param>=0&&o.param<=1){const n=roundTo5(Math.max(e.width*e.scaleX,e.height*e.scaleY)/2),s=roundTo5(Math.sqrt(Math.pow(o.x-t.x,2)+Math.pow(o.y-t.y,2)));s<=n&&i.push({point:o,image:e})}}),i.sort((e,t)=>{const n=Math.sqrt(Math.pow(e.point.x-r.x1,2)+Math.pow(e.point.y-r.y1,2)),i=Math.sqrt(Math.pow(t.point.x-r.x1,2)+Math.pow(t.point.y-r.y1,2));return n-i});let o=r,s={x:r.x1,y:r.y1};for(const t of i){const i=isPointInLockedNode(t.point.x,t.point.y);if(i&&i.node.locked)continue;const a=splitLineAtPoint(o,{x:roundTo5(t.point.x),y:roundTo5(t.point.y)});a&&(saveToUndoStack(),canvas.remove(o),removeAirVolumeText(o),a.line1.set({x1:s.x,y1:s.y,x2:t.point.x,y2:t.point.y}),canvas.add(a.line1),canvas.add(a.line2),createOrUpdateAirVolumeText(a.line1),createOrUpdateAirVolumeText(a.line2),o=a.line2,s={x:t.point.x,y:t.point.y},n++)}}),setTimeout(()=>{updateConnectionGraph(),clearIntersectionPoints();const e=findAllIntersections();e.forEach((e,t)=>createIntersectionPoint(e.x,e.y,t,e)),bringIntersectionPointsToFront()},100),canvas.renderAll(),n>0?showNotification(`–†–∞–∑–¥–µ–ª–µ–Ω–æ ${n} –ª–∏–Ω–∏–π –ø–æ —Ü–µ–Ω—Ç—Ä–∞–º –æ–±—ä–µ–∫—Ç–æ–≤`,'success'):showNotification('–õ–∏–Ω–∏–π –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –ø–æ —Ü–µ–Ω—Ç—Ä–∞–º –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ','info')}
function splitLinesAtImagePosition(e){const t=getCachedLines();let n=0;t.forEach(r=>{const i=getObjectCenter(e),o=findClosestPointOnLine(i,r);if(o.param>=0&&o.param<=1){const t=roundTo5(Math.max(e.width*e.scaleX,e.height*e.scaleY)/2),s=roundTo5(Math.sqrt(Math.pow(o.x-i.x,2)+Math.pow(o.y-i.y,2)));if(s<=t){const t=isPointInLockedNode(o.x,o.y);if(t&&t.node.locked)return;const i=splitLineAtPoint(r,{x:roundTo5(o.x),y:roundTo5(o.y)});i&&(saveToUndoStack(),canvas.remove(r),removeAirVolumeText(r),canvas.add(i.line1),canvas.add(i.line2),createOrUpdateAirVolumeText(i.line1),createOrUpdateAirVolumeText(i.line2),n++)}}}),setTimeout(()=>{updateConnectionGraph(),updateAllAirVolumeTexts()},100),canvas.renderAll(),n>0&&showNotification(`–†–∞–∑–¥–µ–ª–µ–Ω–æ ${n} –ª–∏–Ω–∏–π –ø–æ —Ü–µ–Ω—Ç—Ä—É –æ–±—ä–µ–∫—Ç–æ–≤`,'success')}
function createIntersectionPoint(e,t,n,r,i='#ff4757'){const o=intersectionVisuals.find(t=>Math.abs(t.circle.left+6-e)<.1&&Math.abs(t.circle.top+6-t)<.1);if(o)return o.circle;const s=new fabric.Circle({left:roundTo5(e-6),top:roundTo5(t-6),radius:6,fill:i,stroke:i,strokeWidth:1,selectable:!0,hasControls:!1,hasBorders:!1,evented:!0,originX:'center',originY:'center',id:'intersection-point',pointIndex:n,pointData:r,hoverCursor:'pointer'}),a=new fabric.Text((n+1).toString(),{left:roundTo5(e),top:roundTo5(t),fontSize:10,fill:'white',fontWeight:'bold',selectable:!1,evented:!1,originX:'center',originY:'center',id:'intersection-point-label'});return s.on('mousedown',function(n){if(n.e.altKey);else{n.e.preventDefault(),n.e.stopPropagation();const i=collectPointInfo(e,t);this.pointData&&(this.pointData.type&&(i.type=this.pointData.type),this.pointData.line1&&(i.line1=this.pointData.line1),this.pointData.line2&&(i.line2=this.pointData.line2),this.pointData.object&&(i.object=this.pointData.object),this.pointData.edgePoint&&(i.edgePoint=this.pointData.edgePoint)),console.log('–û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ç–æ—á–∫–∏:',i),showIntersectionPointInfoModal(i)}return!1}),s.set({selectable:!0,hasControls:!1,hasBorders:!1,lockMovementX:!1,lockMovementY:!1}),canvas.add(s),canvas.add(a),s.bringToFront(),a.bringToFront(),intersectionVisuals.push({circle:s,text:a}),s}
function collectPointInfo(e,t){const n=getCachedLines(),r=getCachedImages(),i=[],o=[];return n.forEach(n=>{const s=findClosestPointOnLine({x:e,y:t},n);if(s.distance<10){const a=Math.sqrt(Math.pow(e-n.x1,2)+Math.pow(t-n.y1,2)),l=Math.sqrt(Math.pow(e-n.x2,2)+Math.pow(t-n.y2,2)),c=a<8,u=l<8;i.push({line:n,isStart:c,isEnd:u,distance:s.distance,param:s.param,airVolume:n.properties?.airVolume||0,airResistance:n.properties?.airResistance||0,name:n.properties?.name||'–õ–∏–Ω–∏—è'})}}),r.forEach(n=>{const s=getObjectCenter(n),a=Math.sqrt(Math.pow(e-s.x,2)+Math.pow(t-s.y,2)),l=getObjectRect(n),c=e>=l.left&&e<=l.right&&t>=l.top&&t<=l.bottom;(a<35||c)&&o.push({object:n,name:n.properties?.name||'–û–±—ä–µ–∫—Ç',type:n.properties?.type||'–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω',airVolume:n.properties?.airVolume||0,airResistance:n.properties?.airResistance||0,distance:a,isInside:c})}),{x:e,y:t,linesInPoint:i,objectsInPoint:o,totalLines:i.length,totalObjects:o.length,linesStarting:i.filter(e=>e.isStart).length,linesEnding:i.filter(e=>e.isEnd).length}}
function createIntersectionPointModal(){const e=document.getElementById('intersectionPointModal');e&&e.remove();const t=`
    <div id="intersectionPointModal" class="modal">
      <div class="modal-content" style="max-width: 600px; max-height: 80vh;">
        <div class="modal-header">
          <h3>üîç –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ—á–∫–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è</h3>
          <button class="close-btn" onclick="closeIntersectionPointModal()">√ó</button>
        </div>
        <div id="intersectionPointInfoContent" class="modal-body" style="overflow-y: auto;">
          <div class="loading">
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ—á–∫–µ...</p>
          </div>
        </div>
        <div class="modal-footer">
          <button onclick="closeIntersectionPointModal()" class="btn btn-secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
          <button onclick="calculateAirVolumeAtPoint(${Date.now()})" class="btn btn-primary">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –≤–æ–∑–¥—É—Ö</button>
        </div>
      </div>
    </div>
  `;if(document.body.insertAdjacentHTML('beforeend',t),!document.querySelector('#intersection-point-styles')){const e=document.createElement('style');e.id='intersection-point-styles',e.textContent=`
      .point-info h4 {
        margin-top: 20px;
        margin-bottom: 10px;
        color: #4A00E0;
        border-bottom: 2px solid #eee;
        padding-bottom: 5px;
      }
      .point-info p {
        margin: 5px 0;
      }
      .lines-list, .objects-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .lines-list li, .objects-list li {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
      }
      .detail {
        color: #6c757d;
        font-size: 0.9em;
      }
      .point-summary {
        background: #e3f2fd;
        border-left: 4px solid #4A00E0;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .point-coordinates {
        background: #f3e5f5;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
      }
      .no-data {
        color: #6c757d;
        font-style: italic;
        text-align: center;
        padding: 20px;
      }
      .loading {
        text-align: center;
        padding: 40px;
        color: #6c757d;
      }
    `,document.head.appendChild(e)}return document.getElementById('intersectionPointModal')}
function showIntersectionPointInfoModal(e){console.log('–î–∞–Ω–Ω—ã–µ —Ç–æ—á–∫–∏:',e);let t=document.getElementById('intersectionPointModal'),n=document.getElementById('intersectionPointInfoContent');if(!t||!n)console.log('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, —Å–æ–∑–¥–∞–µ–º...'),t=createIntersectionPointModal(),n=document.getElementById('intersectionPointInfoContent'),(!t||!n)&&(console.error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ!'),alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.'),void 0);if(!e||!e.linesInPoint&&!e.objectsInPoint)return n.innerHTML=`
      <div class="point-info">
        <div class="no-data">
          <h4>‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</h4>
          <p>–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ—á–∫–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è</p>
          <p>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${e?.x||'?'}, ${e?.y||'?'}</p>
        </div>
      </div>
    `,void(t.style.display='flex');const{x:r,y:i}=e;let o=`
    <div class="point-info">
      <div class="point-summary">
        <h4>üìä –°–≤–æ–¥–∫–∞ –ø–æ —Ç–æ—á–∫–µ</h4>
        <p><strong>–í—Å–µ–≥–æ –ª–∏–Ω–∏–π:</strong> ${e.totalLines||0}</p>
        <p><strong>–õ–∏–Ω–∏–π –Ω–∞—á–∞–ª–æ–º:</strong> ${e.linesStarting||0}</p>
        <p><strong>–õ–∏–Ω–∏–π –∫–æ–Ω—Ü–æ–º:</strong> ${e.linesEnding||0}</p>
        <p><strong>–û–±—ä–µ–∫—Ç–æ–≤ –≤ —Ç–æ—á–∫–µ:</strong> ${e.totalObjects||0}</p>
      </div>
      
      <div class="point-coordinates">
        <h4>üìå –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–∫–∏</h4>
        <p><strong>X:</strong> ${formatTo5(r||0)}</p>
        <p><strong>Y:</strong> ${formatTo5(i||0)}</p>
      </div>
  `;e.linesInPoint&&e.linesInPoint.length>0?(o+=`
      <h4>üìè –õ–∏–Ω–∏–∏ –≤ —Ç–æ—á–∫–µ (${e.linesInPoint.length})</h4>
      <ul class="lines-list">
    `,e.linesInPoint.forEach((t,n)=>{const r=t.line,i=r.properties||{},o=roundTo5(Math.sqrt(Math.pow(r.x2-r.x1,2)+Math.pow(r.y2-r.y1,2)));o+=`
        <li>
          <strong>${n+1}. ${t.name||'–õ–∏–Ω–∏—è –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</strong><br>
          <span class="detail">${t.isStart?'‚úÖ –ù–ê–ß–ê–õ–û –ª–∏–Ω–∏–∏':t.isEnd?'‚≠ï –ö–û–ù–ï–¶ –ª–∏–Ω–∏–∏':'üìç –ù–ê –õ–ò–ù–ò–ò (–ø–∞—Ä–∞–º–µ—Ç—Ä: '+t.param.toFixed(2)+')'}</span><br>
          <span class="detail">–î–ª–∏–Ω–∞: ${formatTo5(o)} px</span><br>
          <span class="detail">–û–±—ä–µ–º –≤–æ–∑–¥—É—Ö–∞: <strong>${formatTo5(t.airVolume||0)} –º¬≥/—Å</strong></span><br>
          <span class="detail">–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ: ${formatTo5(t.airResistance||0)}</span>
        </li>
      `}),o+='</ul>'):o+='<h4>üìè –õ–∏–Ω–∏–∏ –≤ —Ç–æ—á–∫–µ</h4><p class="no-data">–ù–µ—Ç –ª–∏–Ω–∏–π, –ø—Ä–æ—Ö–æ–¥—è—â–∏—Ö —á–µ—Ä–µ–∑ —ç—Ç—É —Ç–æ—á–∫—É</p>';if(e.objectsInPoint&&e.objectsInPoint.length>0){o+=`
      <h4>üè≠ –û–±—ä–µ–∫—Ç—ã –≤ —Ç–æ—á–∫–µ (${e.objectsInPoint.length})</h4>
      <ul class="objects-list">
    `;e.objectsInPoint.forEach((e,t)=>{o+=`
        <li>
          <strong>${t+1}. ${e.name||'–û–±—ä–µ–∫—Ç –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</strong><br>
          <span class="detail">–¢–∏–ø: ${e.type||'–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}</span><br>
          <span class="detail">–û–±—ä–µ–º –≤–æ–∑–¥—É—Ö–∞: <strong>${formatTo5(e.airVolume||0)} –º¬≥/—Å</strong></span><br>
          <span class="detail">–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ: ${formatTo5(e.airResistance||0)}</span><br>
          <span class="detail">${e.isInside?'üìç –¢–æ—á–∫–∞ –í–ù–£–¢–†–ò –æ–±—ä–µ–∫—Ç–∞':'üìç –¢–æ—á–∫–∞ –†–Ø–î–û–ú —Å –æ–±—ä–µ–∫—Ç–æ–º'}</span>
        </li>
      `}),o+='</ul>'}else o+='<h4>üè≠ –û–±—ä–µ–∫—Ç—ã –≤ —Ç–æ—á–∫–µ</h4><p class="no-data">–ù–µ—Ç –æ–±—ä–µ–∫—Ç–æ–≤ –≤ —ç—Ç–æ–π —Ç–æ—á–∫–µ</p>';if(e.type&&(o+=`
      <h4>‚ÑπÔ∏è –¢–∏–ø –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è</h4>
      <p>
    `,'object-center'===e.type?o+='–û–±—ä–µ–∫—Ç –Ω–∞ –ª–∏–Ω–∏–∏ (—Ü–µ–Ω—Ç—Ä –æ–±—ä–µ–∫—Ç–∞)':'object-edge'===e.type?o+='–¢–æ—á–∫–∞ –Ω–∞ –∫—Ä–∞—é –æ–±—ä–µ–∫—Ç–∞':e.line1&&e.line2?o+='–ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –¥–≤—É—Ö –ª–∏–Ω–∏–π':o+=e.type||'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è',o+='</p>'),e.linesInPoint&&e.linesInPoint.length>0){let t=0,n=0;e.linesInPoint.forEach(e=>{e.isStart?n+=e.airVolume||0:e.isEnd&&(t+=e.airVolume||0)});const r=roundTo5(t-n);o+=`
      <div class="point-summary">
        <h4>üí® –ë–∞–ª–∞–Ω—Å –≤–æ–∑–¥—É—Ö–∞ –≤ —Ç–æ—á–∫–µ</h4>
        <p><strong>–í—Ö–æ–¥—è—â–∏–π –ø–æ—Ç–æ–∫:</strong> ${formatTo5(t)} –º¬≥/—Å</p>
        <p><strong>–ò—Å—Ö–æ–¥—è—â–∏–π –ø–æ—Ç–æ–∫:</strong> ${formatTo5(n)} –º¬≥/—Å</p>
        <p><strong>–ë–∞–ª–∞–Ω—Å:</strong> <span style="color: ${0===r?'green':'red'}">${formatTo5(r)} –º¬≥/—Å</span></p>
        ${0!==r?'<p class="detail">‚ö†Ô∏è –ë–∞–ª–∞–Ω—Å –Ω–µ —Å—Ö–æ–¥–∏—Ç—Å—è! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞—Å—á–µ—Ç—ã.</p>':'<p class="detail">‚úÖ –ë–∞–ª–∞–Ω—Å —Å—Ö–æ–¥–∏—Ç—Å—è</p>'}
      </div>
    `}o+='</div>',n.innerHTML=o,t.style.display='flex'}
function closeIntersectionPointModal(){const e=document.getElementById('intersectionPointModal');e&&(e.style.display='none')}
function initializeIntersectionPointModal(){createIntersectionPointModal(),console.log('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ç–æ—á–µ–∫ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ')}
function createIntersectionPointForLineStart(e){if(!e.lineStartsFromObject||!e.startObject)return;const t={x:e.x1,y:e.y1},n=intersectionPoints.find(e=>roundTo5(Math.abs(e.x-t.x))<1e-5&&roundTo5(Math.abs(e.y-t.y))<1e-5);if(n)return;const r=intersectionPoints.length,i={x:roundTo5(t.x),y:roundTo5(t.y),line1:e,object:e.startObject,type:'object-edge',objectCenter:getObjectCenter(e.startObject),edgePoint:!0};intersectionPoints.push(i),createIntersectionPoint(t.x,t.y,r,i,'#ff9500')}
function bringIntersectionPointsToFront(){intersectionVisuals.forEach(e=>{e.circle&&e.text&&(e.circle.bringToFront(),e.text.bringToFront())}),canvas.renderAll()}
function clearIntersectionPoints(){const e=canvas.getObjects();for(let t=e.length-1;t>=0;t--){'intersection-point'===e[t].id||'intersection-point-label'===e[t].id,canvas.remove(e[t])}intersectionPoints=[],intersectionVisuals=[],canvas.renderAll()}
function calculateAirVolumeAtPoint(e){const t=document.getElementById('intersectionPointModal');if(!t)return;const n=document.getElementById('intersectionPointInfoContent');if(!n)return;const r=n.querySelector('.point-coordinates');if(!r)return;const i=r.innerHTML.match(/X:[^0-9]*([0-9.]+)/),o=r.innerHTML.match(/Y:[^0-9]*([0-9.]+)/);if(!i||!o)return;const s=parseFloat(i[1]),a=parseFloat(o[1]);console.log(`–†–∞—Å—á–µ—Ç –≤–æ–∑–¥—É—Ö–∞ –≤ —Ç–æ—á–∫–µ (${s}, ${a})`);const l=collectPointInfo(s,a);showIntersectionPointInfoModal(l),showNotification('–ü–µ—Ä–µ—Å—á–µ—Ç –≤–æ–∑–¥—É—Ö–∞ –≤ —Ç–æ—á–∫–µ –≤—ã–ø–æ–ª–Ω–µ–Ω','success')}
function checkLineEndObjectsAtIntersections(){console.log('=== –ü–†–û–í–ï–†–ö–ê –õ–ò–ù–ò–ô, –ü–†–ò–•–û–î–Ø–©–ò–• –ù–ê–ß–ê–õ–û–ú –í –¢–û–ß–ö–ò –ü–ï–†–ï–°–ï–ß–ï–ù–ò–Ø, –ù–ê –ù–ê–õ–ò–ß–ò–ï –û–ë–™–ï–ö–¢–û–í –ù–ê –î–†–£–ì–û–ú –ö–û–ù–¶–ï ===');const e=intersectionPoints,t=getCachedImages();if(0===e.length)return void console.log('–ù–µ—Ç —Ç–æ—á–µ–∫ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.');e.forEach((e,n)=>{const{x:r,y:i}=e;console.log(`\n--- –¢–æ—á–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è ${n+1} (${formatTo5(r)}, ${formatTo5(i)}) ---`);const o=[],s=getCachedLines();s.forEach(e=>{Math.hypot(e.x1-r,e.y1-i)<5&&o.push(e)}),0===o.length?console.log('  –ù–µ—Ç –ª–∏–Ω–∏–π, –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö—Å—è –≤ —ç—Ç–æ–π —Ç–æ—á–∫–µ.'):(console.log(`  –õ–∏–Ω–∏–π, –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö—Å—è –∑–¥–µ—Å—å: ${o.length}`),o.forEach((e,n)=>{const r=e.x2,i=e.y2,o=[];t.forEach(e=>{const t=getObjectCenter(e),s=Math.hypot(t.x-r,t.y-i);if(s<30)o.push(e);else{const t=getObjectRect(e);r>=t.left&&r<=t.right&&i>=t.top&&i<=t.bottom&&o.push(e)}});const s=e.properties?.name||e.id||'–õ–∏–Ω–∏—è –±–µ–∑ –∏–º–µ–Ω–∏';o.length>0?(console.log(`    –õ–∏–Ω–∏—è ${n+1}: "${s}" ‚Äî –Ω–∞ –∫–æ–Ω—Ü–µ (${formatTo5(r)}, ${formatTo5(i)}) –Ω–∞–π–¥–µ–Ω—ã –æ–±—ä–µ–∫—Ç—ã:`),o.forEach((e,t)=>{const n=e.properties?.name||'–û–±—ä–µ–∫—Ç –±–µ–∑ –∏–º–µ–Ω–∏';console.log(`      - ${n} (—Ç–∏–ø: ${e.properties?.type||'–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'})`)})):console.log(`    –õ–∏–Ω–∏—è ${n+1}: "${s}" ‚Äî –Ω–∞ –∫–æ–Ω—Ü–µ (${formatTo5(r)}, ${formatTo5(i)}) –æ–±—ä–µ–∫—Ç—ã –ù–ï –Ω–∞–π–¥–µ–Ω—ã.`)}))}),console.log('=== –ü–†–û–í–ï–†–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê ===')}
function analyzeIntersectionPoints(){console.log('=== –ù–ê–ß–ê–õ–û –ê–ù–ê–õ–ò–ó–ê –¢–û–ß–ï–ö –ü–ï–†–ï–°–ï–ß–ï–ù–ò–Ø ===');const e=getCachedLines(),t=getCachedImages(),n=new Map;e.forEach(e=>{const t=`${roundTo5(e.x1)}_${roundTo5(e.y1)}`,r=`${roundTo5(e.x2)}_${roundTo5(e.y2)}`;n.has(t)||n.set(t,{x:roundTo5(e.x1),y:roundTo5(e.y1),linesStarting:[],linesEnding:[],objects:[]});const i=n.get(t);i.linesStarting.push({line:e,airVolume:e.properties?.airVolume||0,resistance:e.properties?.airResistance||1}),n.has(r)||n.set(r,{x:roundTo5(e.x2),y:roundTo5(e.y2),linesStarting:[],linesEnding:[],objects:[]});const o=n.get(r);o.linesEnding.push({line:e,airVolume:e.properties?.airVolume||0,resistance:e.properties?.airResistance||1})}),t.forEach(e=>{const t=getObjectCenter(e);let r=null,i=1/0;for(const[o,s]of n.entries()){const a=roundTo5(Math.sqrt(Math.pow(s.x-t.x,2)+Math.pow(s.y-t.y,2)));a<i&&a<30&&(i=a,r=o)}if(r){const i=n.get(r);i.objects.push({object:e,name:e.properties?.name||'–û–±—ä–µ–∫—Ç',airVolume:e.properties?.airVolume||0,airResistance:e.properties?.airResistance||1})}});let r=0;const i=(e,t,n)=>{const r=t.length,i=t.map(e=>e.resistance>0?1/e.resistance:1),o=i.reduce((e,t)=>e+t,0),s=t.map((t,n)=>e*(i[n]/o)),a=t.map(e=>{const t=e.line,r=`${roundTo5(t.x2)}_${roundTo5(t.y2)}`,i=n.get(r);if(i&&i.objects&&i.objects.length>0){const e=i.objects.find(e=>e.airResistance>0&&1!==e.airResistance);return e?e.airResistance:1}return 1}),l=[],c=[],u=0;for(let e=0;e<r;e++)if(a[e]>1){const t=s[e]/a[e];l[e]=t,c[e]=s[e]-t,u+=c[e]}else l[e]=s[e],c[e]=0;if(u>0){let e=[],r=[];for(let t=0;t<a.length;t++)a[t]<=1&&(e.push(t),r.push(i[t]));0===e.length&&(e=Array.from({length:a.length},(e,t)=>t),r=i);const t=r.reduce((e,t)=>e+t,0);if(t>0)for(let n of e){const e=u*(i[n]/t);l[n]+=e}}return l};for(const[o,s]of n.entries()){console.log(`\nüîµ –£–ó–ï–õ ${o}:`),console.log(`  –û–±—ä–µ–∫—Ç–æ–≤: ${s.objects.length}`),console.log(`  –õ–∏–Ω–∏–π –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è: ${s.linesStarting.length}`),console.log(`  –õ–∏–Ω–∏–π –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è: ${s.linesEnding.length}`);let a=0;s.linesEnding.forEach(e=>{e.line.properties?.airVolume&&(a+=e.line.properties.airVolume)}),a>0&&(console.log(`  –°—É–º–º–∞—Ä–Ω—ã–π –≤—Ö–æ–¥—è—â–∏–π –æ–±—ä–µ–º: ${a.toFixed(3)} –º¬≥/—Å`);let l=a;if(s.objects.length>0){const e=s.objects[0];e.airResistance>0&&(l/=e.airResistance,console.log(`  –°–õ–£–ß–ê–ô 5/6: –£—á–∏—Ç—ã–≤–∞–µ–º —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ ${e.airResistance}`))}if(s.linesEnding.length>=2&&1===s.linesStarting.length){const e=s.linesStarting[0].line;e.properties.airVolume=roundTo5(l),e.set('properties',e.properties),console.log(`  –°–õ–£–ß–ê–ô 7: –°—É–º–º–∞—Ä–Ω—ã–π –æ–±—ä–µ–º ${a.toFixed(3)} –ø–µ—Ä–µ–¥–∞–Ω –∏—Å—Ö–æ–¥—è—â–µ–π –ª–∏–Ω–∏–∏`),r++}}if(s.objects.length>0&&1===s.linesStarting.length){const e=s.objects[0];if(e.airVolume>0){const t=s.linesStarting[0];let n=e.airVolume;e.airResistance>0&&(n/=e.airResistance,console.log(`  –°–õ–£–ß–ê–ô 5: –û–±—ä–µ–∫—Ç —Å —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ–º ${e.airResistance}`)),t.line.properties.airVolume=roundTo5(n),t.line.set('properties',t.line.properties),console.log(`  –°–õ–£–ß–ê–ô 1: –û–±—ä–µ–∫—Ç –æ—Ç–¥–∞–µ—Ç –≤–µ—Å—å –æ–±—ä–µ–º ${n} –ª–∏–Ω–∏–∏`),r++}}if(s.objects.length>0&&s.linesStarting.length>1){const e=s.objects[0];if(e.airVolume>0){let t=e.airVolume;e.airResistance>0&&(t/=e.airResistance,console.log(`  –°–õ–£–ß–ê–ô 6: –û–±—ä–µ–∫—Ç —Å —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ–º ${e.airResistance}`));const o=i(t,s.linesStarting,n);o.forEach((e,t)=>{s.linesStarting[t].line.properties.airVolume=e,s.linesStarting[t].line.set('properties',s.linesStarting[t].line.properties),console.log(`  –°–õ–£–ß–ê–ô 2: –õ–∏–Ω–∏—è –ø–æ–ª—É—á–∞–µ—Ç ${e}`)}),r++}}if(1===s.linesEnding.length&&1===s.linesStarting.length){const e=s.linesEnding[0].line,t=s.linesStarting[0].line;if(e.properties?.airVolume>0){let n=e.properties.airVolume;if(s.objects.length>0){const e=s.objects[0];e.airResistance>0&&(n/=e.airResistance,console.log(`  –°–õ–£–ß–ê–ô 5 (–≤ —É–∑–ª–µ): –£—á–∏—Ç—ã–≤–∞–µ–º —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞`))}t.properties.airVolume=roundTo5(n),t.set('properties',t.properties),console.log(`  –°–õ–£–ß–ê–ô 3: –û–±—ä–µ–º ${n} –ø–µ—Ä–µ–¥–∞–Ω`),r++}}if(1===s.linesEnding.length&&s.linesStarting.length>1){const e=s.linesEnding[0].line;if(e.properties?.airVolume>0){let t=e.properties.airVolume;if(s.objects.length>0){const e=s.objects[0];e.airResistance>0&&(t/=e.airResistance,console.log(`  –°–õ–£–ß–ê–ô 6 (–≤ —É–∑–ª–µ): –£—á–∏—Ç—ã–≤–∞–µ–º —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞`))}const o=i(t,s.linesStarting,n);o.forEach((e,t)=>{s.linesStarting[t].line.properties.airVolume=e,s.linesStarting[t].line.set('properties',s.linesStarting[t].line.properties),console.log(`  –°–õ–£–ß–ê–ô 4: –õ–∏–Ω–∏—è –ø–æ–ª—É—á–∞–µ—Ç ${e}`)}),r++}}}updateAllAirVolumeTexts(),scheduleRender(),updatePropertiesPanel(),checkLineEndObjectsAtIntersections(),console.log(`\n=== –ê–ù–ê–õ–ò–ó –ó–ê–í–ï–†–®–ï–ù ===`),console.log(`–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —É–∑–ª–æ–≤: ${r}`),showNotification(`–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω! –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${r} —É–∑–ª–æ–≤`,'success');return r}
function createTestScenario(){clearCanvas();const e={id:'test-fan',name:'–¢–µ—Å—Ç–æ–≤—ã–π –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä',path:'./img/fan.png',type:'fan'};fabric.Image.fromURL(e.path,function(t){t.set({left:100,top:100,scaleX:.5,scaleY:.5,properties:{name:e.name,type:e.type,airVolume:10,airResistance:1}}),canvas.add(t);const n=[];const r=new fabric.Line([100,100,200,100],{stroke:'#4A00E0',strokeWidth:5,properties:{name:'–õ–∏–Ω–∏—è 1',airResistance:1,airVolume:0},id:'line_1'});canvas.add(r),n.push(r);const i=new fabric.Line([200,100,200,200],{stroke:'#4A00E0',strokeWidth:5,properties:{name:'–õ–∏–Ω–∏—è 2',airResistance:2,airVolume:0},id:'line_2'});canvas.add(i),n.push(i);const o=new fabric.Line([200,100,300,100],{stroke:'#4A00E0',strokeWidth:5,properties:{name:'–õ–∏–Ω–∏—è 3',airResistance:1,airVolume:0},id:'line_3'});canvas.add(o),n.push(o);const s=new fabric.Line([200,200,300,100],{stroke:'#4A00E0',strokeWidth:5,properties:{name:'–õ–∏–Ω–∏—è 4',airResistance:3,airVolume:0},id:'line_4'});canvas.add(s),n.push(s),r.lineStartsFromObject=!0,r.startObject=t,setTimeout(()=>{invalidateCache(),updateConnectionGraph(),showNotification('–¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π —Å–æ–∑–¥–∞–Ω. –ù–∞–∂–º–∏—Ç–µ "–†–∞—Å—á–µ—Ç –≤–æ–∑–¥—É—Ö–∞"','success')},100)})}
function updatePropertiesPanel(){const e=canvas.getActiveObject(),t=document.getElementById('properties-content');if(!e)return void(t.innerHTML=`<p style="color: #7f8c8d; font-style: italic; text-align: center; padding: 20px;">–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç –Ω–∞ —á–µ—Ä—Ç–µ–∂–µ</p>`);let n=`<div class="property-group"><h4>üìÑ –û—Å–Ω–æ–≤–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞</h4>
    <div class="property-row"><div class="property-label">–¢–∏–ø:</div><div class="property-value"><strong>${e.type}</strong></div></div>`;if('line'===e.type){const t=roundTo5(Math.sqrt(Math.pow(e.x2-e.x1,2)+Math.pow(e.y2-e.y1,2)));n+=`<div class="property-row"><div class="property-label">–î–ª–∏–Ω–∞:</div><div class="property-value">${formatTo5(t)}px</div></div>`;if(e.properties){normalizeLineProperties(e);const t=e.properties;n+=`<div class="property-group"><h4>üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h4>
        <div class="property-row"><div class="property-label">–ù–∞–∑–≤–∞–Ω–∏–µ:</div><div class="property-value">${t.name||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div></div>
        <div class="property-row"><div class="property-label">–í–æ–∑–¥—É—à–Ω–æ–µ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ:</div><div class="property-value"><strong>${formatTo5(t.airResistance||0)}</strong></div></div>
        <div class="property-row"><div class="property-label">–û–±—ä–µ–º –≤–æ–∑–¥—É—Ö–∞:</div><div class="property-value"><strong>${formatTo5(t.airVolume||0)} –º¬≥/—Å</strong></div></div>`;e.lineStartsFromObject&&e.startObject&&(n+=`<div class="property-row"><div class="property-label">–ò—Å—Ç–æ—á–Ω–∏–∫ –≤–æ–∑–¥—É—Ö–∞:</div><div class="property-value">${e.startObject.properties?.name||'–û–±—ä–µ–∫—Ç'}</div></div>`);n+=`</div>`}}else if('image'===e.type){const t=e.properties||{};n+=`<div class="property-row"><div class="property-label">–ù–∞–∑–≤–∞–Ω–∏–µ:</div><div class="property-value">${t.name||'–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'}</div></div>
      <div class="property-row"><div class="property-label">–¢–∏–ø:</div><div class="property-value">${t.type||'default'}</div></div>`;void 0!==t.airVolume&&null!==t.airVolume&&(n+=`<div class="property-row"><div class="property-label">–û–±—ä–µ–º –≤–æ–∑–¥—É—Ö–∞:</div><div class="property-value">${formatTo5(t.airVolume)} –º¬≥/—Å</div></div>`);void 0!==t.airResistance&&null!==t.airResistance&&(n+=`<div class="property-row"><div class="property-label">–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞:</div><div class="property-value">${formatTo5(t.airResistance)}</div></div>`)}n+=`</div>`,t.innerHTML=n}
function updateStatus(){const e=getCachedObjects(),t=e.all.filter(e=>'grid-group'!==e.id&&'grid-line'!==e.id&&!e.isPreview).length;let n=`<strong>–û–±—ä–µ–∫—Ç–æ–≤:</strong> ${t}`;t>.7*APP_CONFIG.MAX_OBJECTS&&(n+=` ‚ö†Ô∏è <strong>–ú–ù–û–ì–û –û–ë–™–ï–ö–¢–û–í</strong>`);const r=canvas.getActiveObject();r&&(n+=` | <strong>–í—ã–±—Ä–∞–Ω:</strong> ${r.type}`,'line'===r.type&&(n+=` (${formatTo5(Math.sqrt(Math.pow(r.x2-r.x1,2)+Math.pow(r.y2-r.y1,2)))}px)`,r.properties&&void 0!==r.properties.airResistance&&(n+=` | <strong>R:</strong> ${formatTo5(r.properties.airResistance)}`),r.properties&&void 0!==r.properties.airVolume&&(n+=` | <strong>Q:</strong> ${formatTo5(r.properties.airVolume)} –º¬≥/—Å`))),isCalculatingAirVolumes&&(n+=' | üîÑ <strong>–ò–¥–µ—Ç —Ä–∞—Å—á–µ—Ç –≤–æ–∑–¥—É—Ö–∞...</strong>'),'MANUAL'===lineSplitMode&&(n+=' | üéØ <strong>–†—É—á–Ω–æ–π —Ä–µ–∂–∏–º</strong>'),altKeyPressed&&(n+=' | <strong>Alt: –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –æ–±—ä–µ–∫—Ç–∞–º</strong>'),nodeLockEnabled&&(n+=' | üîí <strong>–£–∑–ª—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã</strong>'),document.getElementById('status').innerHTML=n}
function initializeModals(){document.getElementById('linePropertiesForm')?.addEventListener('submit',function(e){e.preventDefault(),applyLineProperties()}),document.getElementById('addImageForm')?.addEventListener('submit',function(e){e.preventDefault(),addNewImage()}),document.getElementById('objectPropertiesForm')?.addEventListener('submit',function(e){e.preventDefault(),applyObjectProperties()}),document.querySelectorAll('.modal').forEach(e=>{e.addEventListener('click',function(t){t.target===e&&('linePropertiesModal'===e.id?closeLinePropertiesModal():'addImageModal'===e.id?closeAddImageModal():'objectPropertiesModal'===e.id?closeObjectPropertiesModal():'intersectionPointModal'===e.id?closeIntersectionPointModal():'airVolumeReportModal'===e.id&&closeAirVolumeReport())})}),document.addEventListener('keydown',function(e){'Escape'===e.key&&(isDrawingLine&&(deactivateAllModes(),cleanupPreviewLines(),canvas.renderAll(),showNotification('–†–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω','info')),closeLinePropertiesModal(),closeAddImageModal(),closeObjectPropertiesModal(),closeIntersectionPointModal(),closeAirVolumeReport())})}
function showLinePropertiesModal(){const e=canvas.getActiveObject();if(!e||'line'!==e.type)return void showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ª–∏–Ω–∏—é –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!','error');currentEditingLine=e,normalizeLineProperties(e);const t=e.properties||{};document.getElementById('propertyName').value=t.name||'',document.getElementById('propertyColor').value=e.stroke||APP_CONFIG.DEFAULT_LINE_COLOR,document.getElementById('propertyWidth').value=e.strokeWidth||APP_CONFIG.DEFAULT_LINE_WIDTH,document.getElementById('propertyPassageLength').value=formatTo5(t.passageLength||.5),document.getElementById('propertyRoughnessCoefficient').value=formatTo5(t.roughnessCoefficient||.015),document.getElementById('propertyCrossSectionalArea').value=formatTo5(t.crossSectionalArea||10),document.getElementById('propertyW').value=formatTo5(t.W||1),document.getElementById('propertyAirVolume').value=formatTo5(t.airVolume||0);const n=document.getElementById('propertyAirVolume');e.lineStartsFromObject&&e.startObject?(n.readOnly=!0,n.title="–ó–Ω–∞—á–µ–Ω–∏–µ –±–µ—Ä–µ—Ç—Å—è –∏–∑ –æ–±—ä–µ–∫—Ç–∞, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –ª–∏–Ω–∏—è"):(n.readOnly=!1,n.title=""),document.getElementById('linePropertiesModal').style.display='flex'}
function closeLinePropertiesModal(){document.getElementById('linePropertiesModal').style.display='none',currentEditingLine=null}
function applyLineProperties(){if(!currentEditingLine)return;const e=roundTo5(parseFloat(document.getElementById('propertyPassageLength').value)),t=roundTo5(parseFloat(document.getElementById('propertyRoughnessCoefficient').value)),n=roundTo5(parseFloat(document.getElementById('propertyCrossSectionalArea').value)),r=calculateLinePerimeter(n),i=calculateAirResistance(t,r,e,n);let o=0;const s=document.getElementById('propertyAirVolume');if(s&&(currentEditingLine.lineStartsFromObject&&currentEditingLine.startObject?currentEditingLine.startObject.properties&&void 0!==currentEditingLine.startObject.properties.airVolume?(o=roundTo5(currentEditingLine.startObject.properties.airVolume),showNotification('–û–±—ä–µ–º –≤–æ–∑–¥—É—Ö–∞ –ª–∏–Ω–∏–∏ –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º –∫ –æ–±—ä–µ–∫—Ç—É','info')):o=roundTo5(parseFloat(s.value)||0):o=roundTo5(parseFloat(s.value)||0));const a={name:document.getElementById('propertyName').value,passageLength:e,roughnessCoefficient:t,crossSectionalArea:n,W:roundTo5(parseFloat(document.getElementById('propertyW').value)),perimeter:r,airResistance:i,airVolume:o},l=currentEditingLine.properties||{};l.length&&(a.length=roundTo5(l.length)),l.startPoint&&(a.startPoint={x:roundTo5(l.startPoint.x),y:roundTo5(l.startPoint.y)}),l.endPoint&&(a.endPoint={x:roundTo5(l.endPoint.x),y:roundTo5(l.endPoint.y)}),l.startsFromObject&&(a.startsFromObject=l.startsFromObject),saveToUndoStack(),currentEditingLine.set({stroke:document.getElementById('propertyColor').value,strokeWidth:parseInt(document.getElementById('propertyWidth').value),properties:a}),createOrUpdateAirVolumeText(currentEditingLine),canvas.renderAll(),updatePropertiesPanel(),closeLinePropertiesModal(),showNotification('–°–≤–æ–π—Å—Ç–≤–∞ –ª–∏–Ω–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã','success')}
function showObjectPropertiesModal(){const e=canvas.getActiveObject();if(!e)return void showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!','error');currentEditingObject=e,currentEditingObjectType=e.type;const t=e.properties||{};if('image'===e.type)document.getElementById('objPropertyName').value=t.name||'',document.getElementById('objPropertyType').value=t.type||'custom',document.getElementById('objPropertyX').value=roundTo5(e.left),document.getElementById('objPropertyY').value=roundTo5(e.top),document.getElementById('objPropertyWidth').value=roundTo5(e.width*e.scaleX),document.getElementById('objPropertyHeight').value=roundTo5(e.height*e.scaleY),document.getElementById('objAirVolume').value=roundTo5(t.airVolume||0),document.getElementById('objAirResistance').value=roundTo5(t.airResistance||0);else{if('line'!==e.type)return void showObjectPropertiesModal();showLinePropertiesModal()}document.getElementById('objectPropertiesModal').style.display='flex'}
function closeObjectPropertiesModal(){document.getElementById('objectPropertiesModal').style.display='none',currentEditingObject=null,currentEditingObjectType=null}
function applyObjectProperties(){if(!currentEditingObject)return;try{saveToUndoStack();const e={name:document.getElementById('objPropertyName').value.trim(),type:document.getElementById('objPropertyType').value,airVolume:roundTo5(parseFloat(document.getElementById('objAirVolume').value)||0),airResistance:roundTo5(parseFloat(document.getElementById('objAirResistance').value)||0)},t=currentEditingObject.properties||{};t.imageId&&(e.imageId=t.imageId),t.imagePath&&(e.imagePath=t.imagePath),void 0!==t.width&&(e.width=roundTo5(t.width)),void 0!==t.height&&(e.height=roundTo5(t.height));const n={properties:e,left:roundTo5(parseFloat(document.getElementById('objPropertyX').value)||currentEditingObject.left),top:roundTo5(parseFloat(document.getElementById('objPropertyY').value)||currentEditingObject.top)};if('image'===currentEditingObject.type){const e=roundTo5(parseFloat(document.getElementById('objPropertyWidth').value)),t=roundTo5(parseFloat(document.getElementById('objPropertyHeight').value));if(e&&t){const r=currentEditingObject._element?.naturalWidth||currentEditingObject.width,i=currentEditingObject._element?.naturalHeight||currentEditingObject.height;n.scaleX=roundTo5(e/r),n.scaleY=roundTo5(t/i)}}currentEditingObject.set(n),canvas.renderAll();const r=getCachedLines();r.forEach(e=>{e.lineStartsFromObject&&e.startObject&&(e.startObject.id===currentEditingObject.id||e.startObject._id===currentEditingObject._id)&&createOrUpdateAirVolumeText(e)}),updatePropertiesPanel(),closeObjectPropertiesModal(),showNotification('–°–≤–æ–π—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã','success')}catch(e){showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: '+e.message,'error')}}
function deleteCurrentObject(){if(!currentEditingObject||!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ–±—ä–µ–∫—Ç?'))return;if('line'===currentEditingObject.type){const e=`${roundTo5(currentEditingObject.x1)}_${roundTo5(currentEditingObject.y1)}`,t=`${roundTo5(currentEditingObject.x2)}_${roundTo5(currentEditingObject.y2)}`,n=connectionNodes.get(e),r=connectionNodes.get(t);if(n&&n.locked&&n.lines.length>1||r&&r.locked&&r.lines.length>1)return void showNotification('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ª–∏–Ω–∏—é –∏–∑ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —É–∑–ª–∞!','error')}saveToUndoStack(),'line'===currentEditingObject.type&&removeAirVolumeText(currentEditingObject),canvas.remove(currentEditingObject),canvas.renderAll(),closeObjectPropertiesModal(),updatePropertiesPanel(),updateStatus(),showNotification('–û–±—ä–µ–∫—Ç —É–¥–∞–ª–µ–Ω','info')}
function showAddImageModal(){document.getElementById('addImageModal').style.display='flex',document.getElementById('addImageForm').reset()}
function closeAddImageModal(){document.getElementById('addImageModal').style.display='none'}
function addNewImage(){const e=document.getElementById('newImageName').value.trim(),t=document.getElementById('newImageType').value,n=document.getElementById('newImageUrl').value.trim();if(!e)return void showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è!','error');if(!n)return void showNotification('–í–≤–µ–¥–∏—Ç–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è!','error');const r={id:'custom_'+Date.now(),name:e,path:n,type:t};allImages.push(r),updateImageLibrary(),closeAddImageModal(),showNotification(`–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ "${e}" –¥–æ–±–∞–≤–ª–µ–Ω–æ!`,'success')}
function saveDrawing(){const e=JSON.stringify(canvas.toJSON(['id','properties','pointIndex','pointData','lineStartsFromObject','startObject','airVolumeText','isPreview']));localStorage.setItem('fabricDrawing',e);const t=new Blob([e],{type:'application/json'}),n=URL.createObjectURL(t),r=document.createElement('a');r.href=n,r.download=`—á–µ—Ä—Ç–µ–∂-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(n);const i=canvas.getObjects().filter(e=>'grid-group'!==e.id&&'grid-line'!==e.id&&!e.isPreview).length;showNotification(`–ß–µ—Ä—Ç–µ–∂ —Å–æ—Ö—Ä–∞–Ω–µ–Ω! (${i} –æ–±—ä–µ–∫—Ç–æ–≤)`,'success')}
function loadDrawing(){const e=document.createElement('input');e.type='file',e.accept='.json',e.onchange=function(t){const n=t.target.files[0];if(!n)return;const r=new FileReader;r.onload=function(t){try{const r=t.target.result;deactivateAllModes(),canvas.clear(),drawGrid(APP_CONFIG.GRID_SIZE),canvas.loadFromJSON(r,function(){canvas.getObjects().forEach(e=>{if(e.lineStartsFromObject&&e.properties?.startsFromObject?.objectId){const t=canvas.getObjects().find(t=>t.id===e.properties.startsFromObject.objectId||t._id===e.properties.startsFromObject.objectId);t&&(e.startObject=t)}'line'===e.type&&normalizeLineProperties(e)}),setTimeout(()=>{invalidateCache(),updateConnectionGraph(),updateAllAirVolumeTexts()},500),canvas.renderAll(),updatePropertiesPanel(),updateStatus();const e=canvas.getObjects().filter(e=>'grid-group'!==e.id&&'grid-line'!==e.id&&!e.isPreview).length;showNotification(`–ß–µ—Ä—Ç–µ–∂ –∑–∞–≥—Ä—É–∂–µ–Ω! (${e} –æ–±—ä–µ–∫—Ç–æ–≤)`,'success')})}catch(e){showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: '+e.message,'error')}};r.readAsText(n)};e.click()}
function clearCanvas(){if(!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã —Å —á–µ—Ä—Ç–µ–∂–∞?'))return;deactivateAllModes(),lastLineEndPoint=null,clearIntersectionPoints(),canvas.getObjects().forEach(e=>{'grid-group'!==e.id&&'grid-line'!==e.id&&canvas.remove(e)}),connectionNodes.clear(),invalidateCache(),canvas.renderAll(),updatePropertiesPanel(),updateStatus(),showNotification('–•–æ–ª—Å—Ç –æ—á–∏—â–µ–Ω','info')}
function saveToUndoStack(){const e=JSON.stringify(canvas.toJSON(['id','properties','isPreview']));undoStack.push(e),redoStack=[],undoStack.length>APP_CONFIG.MAX_UNDO_STEPS&&undoStack.shift(),updateUndoRedoButtons()}
function undoAction(){if(undoStack.length<2)return;const e=undoStack.pop();redoStack.push(e);const t=undoStack[undoStack.length-1];canvas.loadFromJSON(t,function(){setTimeout(()=>{invalidateCache(),updateConnectionGraph(),updateAllAirVolumeTexts()},100),canvas.renderAll(),updatePropertiesPanel(),updateStatus()}),updateUndoRedoButtons(),showNotification('–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ','info')}
function redoAction(){if(0===redoStack.length)return;const e=redoStack.pop();undoStack.push(e),canvas.loadFromJSON(e,function(){setTimeout(()=>{invalidateCache(),updateConnectionGraph(),updateAllAirVolumeTexts()},100),canvas.renderAll(),updatePropertiesPanel(),updateStatus()}),updateUndoRedoButtons(),showNotification('–î–µ–π—Å—Ç–≤–∏–µ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–æ','info')}
function updateUndoRedoButtons(){const e=document.getElementById('undoBtn'),t=document.getElementById('redoBtn');e&&(e.disabled=undoStack.length<2),t&&(t.disabled=0===redoStack.length)}
function setupKeyboardShortcuts(){document.addEventListener('keydown',function(e){if('Escape'===e.key){isDrawingLine&&(deactivateAllModes(),cleanupPreviewLines(),canvas.renderAll(),showNotification('–†–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω','info')),closeLinePropertiesModal(),closeAddImageModal(),closeObjectPropertiesModal(),closeIntersectionPointModal(),closeAirVolumeReport()}if('Delete'===e.key){const t=canvas.getActiveObject();if(t){if('line'===t.type){const n=`${roundTo5(t.x1)}_${roundTo5(t.y1)}`,r=`${roundTo5(t.x2)}_${roundTo5(t.y2)}`,i=connectionNodes.get(n),o=connectionNodes.get(r);if(i&&i.locked&&i.lines.length>1||o&&o.locked&&o.lines.length>1)return void showNotification('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ª–∏–Ω–∏—é –∏–∑ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —É–∑–ª–µ!','error')}saveToUndoStack(),'line'===t.type&&removeAirVolumeText(t),canvas.remove(t),setTimeout(()=>{invalidateCache(),updateConnectionGraph()},100),canvas.renderAll(),updatePropertiesPanel(),updateStatus(),showNotification('–û–±—ä–µ–∫—Ç —É–¥–∞–ª–µ–Ω','info')}}if(e.ctrlKey){if('s'===e.key)return e.preventDefault(),void saveDrawing();if('o'===e.key)return e.preventDefault(),void loadDrawing();if('z'===e.key)return e.preventDefault(),void undoAction();if('y'===e.key)return e.preventDefault(),void redoAction()}switch(e.key.toLowerCase()){case'l':e.preventDefault(),activateLineDrawing();break;case's':e.preventDefault(),splitAllLines();break;case'c':e.preventDefault(),splitAllLinesAtObjectCenters();break;case'g':e.preventDefault(),toggleGrid();break;case'a':e.preventDefault(),toggleAutoSplitMode();break;case'r':e.preventDefault(),e.altKey&&analyzeIntersectionPoints();break;case't':e.preventDefault(),e.altKey&&updateAllAirVolumeTexts();break;case'p':e.preventDefault(),e.altKey&&calculateAirVolumesForAllLines(!0);break;case'n':e.preventDefault(),e.altKey&&toggleNodeLock();break;case'b':e.preventDefault(),e.altKey&&checkFlowBalance()}}),document.addEventListener('click',hideContextMenu)}
function setupAltKeyTracking(){document.addEventListener('keydown',function(e){('Alt'===e.key||18===e.keyCode)&&(altKeyPressed=!0,isDrawingLine&&(canvas.defaultCursor='crosshair',canvas.renderAll(),showNotification('Alt –Ω–∞–∂–∞—Ç–∞: —Ä–µ–∂–∏–º –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –∫—Ä–∞—è–º –æ–±—ä–µ–∫—Ç–æ–≤ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω','info',1500)))}),document.addEventListener('keyup',function(e){('Alt'===e.key||18===e.keyCode)&&(altKeyPressed=!1,isDrawingLine&&(canvas.defaultCursor='crosshair',canvas.renderAll()))})}
function showContextMenu(e,t){const n=document.getElementById('contextMenu'),r=canvas.getActiveObject();if(!r)return;n.style.display='block',n.style.left=e+'px',n.style.top=t+'px',contextMenuVisible=!0;const i=n.getBoundingClientRect();e+i.width>window.innerWidth&&(n.style.left=e-i.width+'px'),t+i.height>window.innerHeight&&(n.style.top=t-i.height+'px')}
function hideContextMenu(){if(!contextMenuVisible)return;document.getElementById('contextMenu').style.display='none',contextMenuVisible=!1}
function deleteObject(){const e=canvas.getActiveObject();if(!e)return;if('line'===e.type){const t=`${roundTo5(e.x1)}_${roundTo5(e.y1)}`,n=`${roundTo5(e.x2)}_${roundTo5(e.y2)}`,r=connectionNodes.get(t),i=connectionNodes.get(n);if(r&&r.locked&&r.lines.length>1||i&&i.locked&&i.lines.length>1)return showNotification('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ª–∏–Ω–∏—é –∏–∑ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —É–∑–ª–∞!','error'),void hideContextMenu()}saveToUndoStack(),'line'===e.type&&removeAirVolumeText(e),canvas.remove(e),setTimeout(()=>{invalidateCache(),updateConnectionGraph()},100),canvas.renderAll(),updatePropertiesPanel(),updateStatus(),showNotification('–û–±—ä–µ–∫—Ç —É–¥–∞–ª–µ–Ω','info'),hideContextMenu()}
function duplicateObject(){const e=canvas.getActiveObject();if(!e)return void showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç –¥–ª—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è','error');saveToUndoStack(),e.clone(function(t){t.left=roundTo5(t.left+20),t.top=roundTo5(t.top+20),canvas.add(t),canvas.setActiveObject(t),setTimeout(()=>{invalidateCache(),updateConnectionGraph()},100),canvas.renderAll(),showNotification('–û–±—ä–µ–∫—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω','success')}),hideContextMenu()}
function bringObjectToFront(){const e=canvas.getActiveObject();e&&(saveToUndoStack(),e.bringToFront(),canvas.renderAll(),showNotification('–û–±—ä–µ–∫—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω –Ω–∞ –ø–µ—Ä–µ–¥–Ω–∏–π –ø–ª–∞–Ω','success'),hideContextMenu())}
function sendObjectToBack(){const e=canvas.getActiveObject();e&&(saveToUndoStack(),e.sendToBack(),canvas.renderAll(),showNotification('–û–±—ä–µ–∫—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω –Ω–∞ –∑–∞–¥–Ω–∏–π –ø–ª–∞–Ω','success'),hideContextMenu())}
function showNotification(e,t='info',n=3e3){const r=document.getElementById('notification');r&&(r.textContent=e,r.className=`notification ${t}`,r.style.display='block',r.style.opacity='1',setTimeout(()=>{r.style.opacity='0',setTimeout(()=>{r.style.display='none'},300)},n))}
function exportLinePropertiesToCSV(){const e=getCachedLines();if(0===e.length)return void showNotification('–ù–µ—Ç –ª–∏–Ω–∏–π –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞!','error');let t='data:text/csv;charset=utf-8,';t+='ID,–ù–∞–∑–≤–∞–Ω–∏–µ,–î–ª–∏–Ω–∞ (px),–î–ª–∏–Ω–∞ –ø—Ä–æ—Ö–æ–¥–∞ (–º),–ö–æ—ç—Ñ. —à–µ—Ä–æ—Ö–æ–≤–∞—Ç–æ—Å—Ç–∏,–ü–ª–æ—â–∞–¥—å —Å–µ—á–µ–Ω–∏—è (–º¬≤),–ü–µ—Ä–∏–º–µ—Ç—Ä (–º),–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ (R),–û–±—ä–µ–º –≤–æ–∑–¥—É—Ö–∞ (–º¬≥/—Å)\n',e.forEach(e=>{const n=e.properties||{},r=roundTo5(Math.sqrt(Math.pow(e.x2-e.x1,2)+Math.pow(e.y2-e.y1,2))),i=[e.id||'N/A',`"${n.name||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}"`,formatTo5(r),formatTo5(n.passageLength||0),formatTo5(n.roughnessCoefficient||0),formatTo5(n.crossSectionalArea||0),formatTo5(n.perimeter||0),formatTo5(n.airResistance||0),formatTo5(n.airVolume||0)].join(',');t+=i+'\n'}),encodeURI(t);const n=document.createElement('a');n.setAttribute('href',encodeURI(t)),n.setAttribute('download',`–ª–∏–Ω–∏–∏_${new Date().toISOString().slice(0,10)}.csv`),document.body.appendChild(n),n.click(),document.body.removeChild(n),showNotification(`–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${e.length} –ª–∏–Ω–∏–π –≤ CSV`,'success')}
function calculateAllPropertiesForAllLines(){const e=getCachedLines();let t=0;e.forEach(e=>{try{normalizeLineProperties(e),calculateAllLineProperties(e),t++}catch(e){console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ —Å–≤–æ–π—Å—Ç–≤ –ª–∏–Ω–∏–∏:',e,e)}}),updateAllAirVolumeTexts(),canvas.renderAll(),updatePropertiesPanel(),t>0?showNotification(`–ü–µ—Ä–µ—Å—á–∏—Ç–∞–Ω—ã —Å–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è ${t} –ª–∏–Ω–∏–π`,'success'):showNotification('–õ–∏–Ω–∏–∏ –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã','info')}
function showAirVolumeReport(){const e=getCachedLines(),t=getCachedImages();if(0===e.length&&0===t.length)return void showNotification('–ù–µ—Ç –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è –æ—Ç—á–µ—Ç–∞!','error');let n=document.getElementById('airVolumeReportModal');n||createAirVolumeReportModal();let r='<div class="report-content">';r+='<div class="report-summary">',r+='<h3>üìä –û—Ç—á–µ—Ç –ø–æ –æ–±—ä–µ–º–∞–º –≤–æ–∑–¥—É—Ö–∞</h3>',r+=`<p><strong>–í—Å–µ–≥–æ –ª–∏–Ω–∏–π:</strong> ${e.length}</p>`,r+=`<p><strong>–í—Å–µ–≥–æ –æ–±—ä–µ–∫—Ç–æ–≤:</strong> ${t.length}</p>`;let i=0;e.forEach(e=>{e.properties?.airVolume&&(i+=e.properties.airVolume)}),r+=`<p><strong>–°—É–º–º–∞—Ä–Ω—ã–π –æ–±—ä–µ–º –≤–æ–∑–¥—É—Ö–∞:</strong> ${formatTo5(i)} –º¬≥/—Å</p>`,r+='</div>',e.length>0&&(r+='<div class="report-section">',r+='<h4>üìè –õ–∏–Ω–∏–∏</h4>',r+='<table class="report-table">',r+='<thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–î–ª–∏–Ω–∞ (px)</th><th>–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ (R)</th><th>–û–±—ä–µ–º –≤–æ–∑–¥—É—Ö–∞ (–º¬≥/—Å)</th></tr></thead>',r+='<tbody>',e.forEach(e=>{const t=e.properties||{},n=roundTo5(Math.sqrt(Math.pow(e.x2-e.x1,2)+Math.pow(e.y2-e.y1,2)));r+=`<tr>
        <td>${t.name||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</td>
        <td>${formatTo5(n)}</td>
        <td>${formatTo5(t.airResistance||0)}</td>
        <td><strong>${formatTo5(t.airVolume||0)}</strong></td>
      </tr>`}),r+='</tbody></table>',r+='</div>'),t.length>0&&(r+='<div class="report-section">',r+='<h4>üè≠ –û–±—ä–µ–∫—Ç—ã</h4>',r+='<table class="report-table">',r+='<thead><tr><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–¢–∏–ø</th><th>–û–±—ä–µ–º –≤–æ–∑–¥—É—Ö–∞ (–º¬≥/—Å)</th><th>–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ</th></tr></thead>',r+='<tbody>',t.forEach(e=>{const t=e.properties||{};r+=`<tr>
        <td>${t.name||'–û–±—ä–µ–∫—Ç'}</td>
        <td>${t.type||'default'}</td>
        <td>${formatTo5(t.airVolume||0)}</td>
        <td>${formatTo5(t.airResistance||0)}</td>
      </tr>`}),r+='</tbody></table>',r+='</div>'),r+='</div>',document.getElementById('airVolumeReportContent').innerHTML=r,document.getElementById('airVolumeReportModal').style.display='flex'}
function closeAirVolumeReport(){document.getElementById('airVolumeReportModal').style.display='none'}
function createAirVolumeReportModal(){const e=`
    <div id="airVolumeReportModal" class="modal">
      <div class="modal-content" style="max-width: 800px; max-height: 80vh;">
        <div class="modal-header">
          <h3>üìä –û—Ç—á–µ—Ç –ø–æ –æ–±—ä–µ–º–∞–º –≤–æ–∑–¥—É—Ö–∞</h3>
          <button class="close-btn" onclick="closeAirVolumeReport()">√ó</button>
        </div>
        <div id="airVolumeReportContent" class="modal-body" style="overflow-y: auto;">
          <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –æ—Ç—á–µ—Ç–∞ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
        </div>
        <div class="modal-footer">
          <button onclick="exportAirVolumeReportToCSV()" class="btn btn-primary">
            <span>üì•</span> –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV
          </button>
          <button onclick="closeAirVolumeReport()" class="btn btn-secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
    </div>
  `;document.body.insertAdjacentHTML('beforeend',e)}
function exportAirVolumeReportToCSV(){const e=getCachedLines(),t=getCachedImages();let n='data:text/csv;charset=utf-8,';n+='–û–¢–ß–ï–¢ –ü–û –û–ë–™–ï–ú–ê–ú –í–û–ó–î–£–•–ê\n',n+=`–î–∞—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ${new Date().toLocaleString()}\n`,n+=`–í—Å–µ–≥–æ –ª–∏–Ω–∏–π: ${e.length}\n`,n+=`–í—Å–µ–≥–æ –æ–±—ä–µ–∫—Ç–æ–≤: ${t.length}\n\n`,n+='–õ–ò–ù–ò–ò\n',n+='–ù–∞–∑–≤–∞–Ω–∏–µ,–î–ª–∏–Ω–∞ (px),–î–ª–∏–Ω–∞ –ø—Ä–æ—Ö–æ–¥–∞ (–º),–ö–æ—ç—Ñ. —à–µ—Ä–æ—Ö–æ–≤–∞—Ç–æ—Å—Ç–∏,–ü–ª–æ—â–∞–¥—å —Å–µ—á–µ–Ω–∏—è (–º¬≤),–ü–µ—Ä–∏–º–µ—Ç—Ä (–º),–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ (R),–û–±—ä–µ–º –≤–æ–∑–¥—É—Ö–∞ (–º¬≥/—Å),X1,Y1,X2,Y2\n',e.forEach(e=>{const t=e.properties||{},r=roundTo5(Math.sqrt(Math.pow(e.x2-e.x1,2)+Math.pow(e.y2-e.y1,2))),i=[`"${t.name||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}"`,formatTo5(r),formatTo5(t.passageLength||0),formatTo5(t.roughnessCoefficient||0),formatTo5(t.crossSectionalArea||0),formatTo5(t.perimeter||0),formatTo5(t.airResistance||0),formatTo5(t.airVolume||0),formatTo5(e.x1),formatTo5(e.y1),formatTo5(e.x2),formatTo5(e.y2)].join(',');n+=i+'\n'}),n+='\n\n–û–ë–™–ï–ö–¢–´\n',n+='–ù–∞–∑–≤–∞–Ω–∏–µ,–¢–∏–ø,–û–±—ä–µ–º –≤–æ–∑–¥—É—Ö–∞ (–º¬≥/—Å),–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ,X,Y,–®–∏—Ä–∏–Ω–∞,–í—ã—Å–æ—Ç–∞\n',t.forEach(e=>{const t=e.properties||{},r=[`"${t.name||'–û–±—ä–µ–∫—Ç'}"`,t.type||'default',formatTo5(t.airVolume||0),formatTo5(t.airResistance||0),formatTo5(e.left||0),formatTo5(e.top||0),formatTo5(e.width*e.scaleX||0),formatTo5(e.height*e.scaleY||0)].join(',');n+=r+'\n'});const r=encodeURI(n),i=document.createElement('a');i.setAttribute('href',r),i.setAttribute('download',`–æ—Ç—á–µ—Ç_–≤–æ–∑–¥—É—Ö_${new Date().toISOString().slice(0,10)}.csv`),document.body.appendChild(i),i.click(),document.body.removeChild(i),showNotification('–û—Ç—á–µ—Ç —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ CSV','success')}
function exportToPDFWithOptions(){const e=`
    <div id="pdfExportModal" class="modal" style="display:flex;">
      <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
          <h3>üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF</h3>
          <button class="close-btn" onclick="closePDFExportModal()">√ó</button>
        </div>
        <div class="modal-body">
          <div class="property-group">
            <h4>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞</h4>
            
            <div class="property-row">
              <div class="property-label">
                <label for="pdfFileName">–ò–º—è —Ñ–∞–π–ª–∞:</label>
              </div>
              <div class="property-value">
                <input type="text" id="pdfFileName" value="—á–µ—Ä—Ç–µ–∂_${new Date().toISOString().slice(0,10)}" style="width:100%;">
              </div>
            </div>

            <div class="property-row">
              <div class="property-label">
                <label for="pdfFormat">–§–æ—Ä–º–∞—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã:</label>
              </div>
              <div class="property-value">
                <select id="pdfFormat" style="width:100%;">
                  <option value="a4">A4</option>
                  <option value="a3">A3</option>
                  <option value="letter">Letter</option>
                </select>
              </div>
            </div>

            <div class="property-row">
              <div class="property-label">
                <label for="pdfOrientation">–û—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è:</label>
              </div>
              <div class="property-value">
                <select id="pdfOrientation" style="width:100%;">
                  <option value="portrait">–ö–Ω–∏–∂–Ω–∞—è</option>
                  <option value="landscape" selected>–ê–ª—å–±–æ–º–Ω–∞—è</option>
                </select>
              </div>
            </div>

            <div class="property-row">
              <div class="property-label">
                <label for="pdfQuality">–ö–∞—á–µ—Å—Ç–≤–æ:</label>
              </div>
              <div class="property-value">
                <select id="pdfQuality" style="width:100%;">
                  <option value="1">–û–±—ã—á–Ω–æ–µ</option>
                  <option value="2" selected>–í—ã—Å–æ–∫–æ–µ</option>
                  <option value="3">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ</option>
                </select>
              </div>
            </div>

            <div class="property-row">
              <div class="property-label">
                <label for="includeGrid">–í–∫–ª—é—á–∞—Ç—å —Å–µ—Ç–∫—É:</label>
              </div>
              <div class="property-value">
                <input type="checkbox" id="includeGrid" checked>
              </div>
            </div>

            <div class="property-row">
              <div class="property-label">
                <label for="includeAirVolumes">–í–∫–ª—é—á–∞—Ç—å –æ–±—ä–µ–º—ã –≤–æ–∑–¥—É—Ö–∞:</label>
              </div>
              <div class="property-value">
                <input type="checkbox" id="includeAirVolumes" checked>
              </div>
            </div>

            <div class="property-row">
              <div class="property-label">
                <label for="includeIntersections">–í–∫–ª—é—á–∞—Ç—å —Ç–æ—á–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π:</label>
              </div>
              <div class="property-value">
                <input type="checkbox" id="includeIntersections" checked>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button onclick="exportToPDF()" class="btn btn-primary">
            <span>üì•</span> –≠–∫—Å–ø–æ—Ä—Ç
          </button>
          <button onclick="closePDFExportModal()" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
    </div>
  `;const t=document.getElementById('pdfExportModal');t&&t.remove(),document.body.insertAdjacentHTML('beforeend',e)}
function closePDFExportModal(){const e=document.getElementById('pdfExportModal');e&&e.remove()}
function exportToPDF(){try{const e=document.getElementById('pdfFileName')?.value||'—á–µ—Ä—Ç–µ–∂',t=document.getElementById('pdfFormat')?.value||'a4',n=document.getElementById('pdfOrientation')?.value||'landscape',r=parseInt(document.getElementById('pdfQuality')?.value)||2,i=!1!==document.getElementById('includeGrid')?.checked,o=!1!==document.getElementById('includeAirVolumes')?.checked,s=!1!==document.getElementById('includeIntersections')?.checked;showNotification('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF...','info',2e3);const a=canvas.getObjects().find(e=>'grid-group'===e.id),l=canvas.getObjects().filter(e=>'air-volume-text'===e.id),c=canvas.getObjects().filter(e=>'intersection-point'===e.id||'intersection-point-label'===e.id);i||!a||a.set('visible',!1),o||l.forEach(e=>e.set('visible',!1)),s||c.forEach(e=>e.set('visible',!1)),canvas.renderAll();if('undefined'==typeof window.jspdf)throw new Error('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ jsPDF –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');const{jsPDF:u}=window.jspdf;let d,p;switch(t){case'a4':d='portrait'===n?210:297,p='portrait'===n?297:210;break;case'a3':d='portrait'===n?297:420,p='portrait'===n?420:297;break;case'letter':d='portrait'===n?216:279,p='portrait'===n?279:216;break;default:d=210,p=297}const f=new u({orientation:n,unit:'mm',format:t}),h=canvas.getElement(),m=h.toDataURL('image/png',r*.33),g=10,v=d-2*g,y=(h.height*v)/h.width;f.addImage(m,'PNG',g,g,v,y),f.setFontSize(8),f.setTextColor(100,100,100),f.text(`–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${new Date().toLocaleString()}`,g,p-g-5),f.text(`–í—Å–µ–≥–æ –æ–±—ä–µ–∫—Ç–æ–≤: ${canvas.getObjects().length}`,g,p-g),f.save(`${e}.pdf`),i||!a||a.set('visible',!0),o||l.forEach(e=>e.set('visible',!0)),s||c.forEach(e=>e.set('visible',!0)),canvas.renderAll(),closePDFExportModal(),showNotification('PDF —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!','success')}catch(e){console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ PDF:',e),showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ PDF: '+e.message,'error')}}
function quickExportToPDF(){try{showNotification('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF...','info',2e3);if('undefined'==typeof window.jspdf)throw new Error('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ jsPDF –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');const{jsPDF:e}=window.jspdf,t=new e({orientation:'landscape',unit:'px',format:[canvas.width,canvas.height]}),n=canvas.getElement(),r=n.toDataURL('image/png',1);t.addImage(r,'PNG',0,0,canvas.width,canvas.height),t.save(`—á–µ—Ä—Ç–µ–∂_${new Date().toISOString().slice(0,10)}.pdf`),showNotification('PDF —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!','success')}catch(e){console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ PDF:',e),showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ PDF: '+e.message,'error')}}
let lineDragState={active:!1,line:null,startX1:0,startY1:0,startX2:0,startY2:0,startLocked:!1,endLocked:!1,draggedEnd:null,pending:!1,pendingEnd:null,pendingLine:null};
function isPointALockedNode(e,t){const n=`${roundTo5(e)}_${roundTo5(t)}`,r=connectionNodes.get(n);return!!r&&r.locked&&r.lines.length>1}
function snapToNode(e,t,n=APP_CONFIG.SNAP_RADIUS){let r=null,i=n;for(const n of connectionNodes.values()){const o=Math.hypot(e-n.x,t-n.y);o<i&&(i=o,r=n)}return r?{x:r.x,y:r.y}:null}
function onLineMovingStart(e){const t=e.target;if('line'!==t.type||'preview-line'===t.id)return;lineDragState.pending&&lineDragState.pendingLine===t?(lineDragState.draggedEnd=lineDragState.pendingEnd,lineDragState.pending=!1,lineDragState.pendingLine=null,lineDragState.pendingEnd=null):lineDragState.draggedEnd='whole',lineDragState.active=!0,lineDragState.line=t,lineDragState.startX1=t.x1,lineDragState.startY1=t.y1,lineDragState.startX2=t.x2,lineDragState.startY2=t.y2,lineDragState.startLocked=isPointALockedNode(t.x1,t.y1),lineDragState.endLocked=isPointALockedNode(t.x2,t.y2)}
function onLineMoving(e){if(!lineDragState.active||lineDragState.line!==e.target)return;const t=e.target,n=t.x1,r=t.y1,i=t.x2,o=t.y2,s=lineDragState.startX1,a=lineDragState.startY1,l=lineDragState.startX2,c=lineDragState.startY2;let u=!1,d=n,p=r,f=i,h=o;if(lineDragState.startLocked&&lineDragState.endLocked)d=s,p=a,f=l,h=c,u=!0;else{if(lineDragState.startLocked){if('start'===lineDragState.draggedEnd)d=s,p=a,u=!0;else if('whole'===lineDragState.draggedEnd)d=s,p=a,u=!0}if(lineDragState.endLocked){if('end'===lineDragState.draggedEnd)f=l,h=c,u=!0;else if('whole'===lineDragState.draggedEnd)f=l,h=c,u=!0}if(!lineDragState.startLocked&&!lineDragState.endLocked){if('start'===lineDragState.draggedEnd){const e=snapToNode(d,p);e&&(d=e.x,p=e.y,u=!0)}else if('end'===lineDragState.draggedEnd){const e=snapToNode(f,h);e&&(f=e.x,h=e.y,u=!0)}}}if(u&&(t.set({x1:d,y1:p,x2:f,y2:h}),t.setCoords(),lineDragState.startX1=d,lineDragState.startY1=p,lineDragState.startX2=f,lineDragState.startY2=h,canvas.renderAll()),t.airVolumeText&&createOrUpdateAirVolumeText(t))}
function onLineModified(e){lineDragState.active&&(lineDragState.active=!1,lineDragState.line=null,invalidateCache(),updateConnectionGraph(),e.target&&'line'===e.target.type&&createOrUpdateAirVolumeText(e.target),scheduleRender())}
function updateLinesAttachedToNode(e,t,n,r){const i=`${roundTo5(e)}_${roundTo5(t)}`,o=connectionNodes.get(i);if(!o)return;o.lines.forEach(e=>{const t=e.line;e.isStart?t.set({x1:n,y1:r}):t.set({x2:n,y2:r}),t.setCoords(),t.airVolumeText&&createOrUpdateAirVolumeText(t)}),connectionNodes.delete(i);const s=`${roundTo5(n)}_${roundTo5(r)}`;o.x=n,o.y=r,connectionNodes.set(s,o)}
function onIntersectionPointMoving(e){const t=e.target;if('intersection-point'!==t.id)return;const n=t.radius||6,r=t.left+n,i=t.top+n,o=t.left+n,s=t.top+n;updateLinesAttachedToNode(r,i,o,s);const a=intersectionVisuals.find(e=>e.circle===t)?.text;a&&(a.set({left:o,top:s}),a.setCoords()),invalidateCache(),canvas.renderAll()}
function onIntersectionPointModified(e){const t=e.target;'intersection-point'===t.id&&setTimeout(()=>{buildConnectionGraph(),bringIntersectionPointsToFront(),scheduleRender()},10)}
function extendSetupCanvasEvents(){canvas&&(canvas.on('object:moving',function(e){const t=e.target;'line'===t.type?lineDragState.active||onLineMovingStart(e):onLineMoving(e),'intersection-point'===t.id&&onIntersectionPointMoving(e)}),canvas.on('object:modified',function(e){const t=e.target;'line'===t.type?onLineModified(e):'intersection-point'===t.id&&onIntersectionPointModified(e)}),canvas.on('selection:created',function(){lineDragState.pending=!1,lineDragState.pendingLine=null,lineDragState.pendingEnd=null}),canvas.on('selection:cleared',function(){lineDragState.pending=!1,lineDragState.pendingLine=null,lineDragState.pendingEnd=null}))}
canvas?extendSetupCanvasEvents():document.addEventListener('DOMContentLoaded',function(){canvas&&extendSetupCanvasEvents()});
window.canvas=canvas,window.analyzeIntersectionPoints=analyzeIntersectionPoints,window.calculateAirVolumesForAllLines=calculateAirVolumesForAllLines,window.clearIntersectionPoints=clearIntersectionPoints,window.updateConnectionGraph=updateConnectionGraph,window.toggleNodeLock=toggleNodeLock,window.exportLinePropertiesToCSV=exportLinePropertiesToCSV,window.calculateAllPropertiesForAllLines=calculateAllPropertiesForAllLines,window.showAirVolumeReport=showAirVolumeReport,window.closeAirVolumeReport=closeAirVolumeReport,window.exportAirVolumeReportToCSV=exportAirVolumeReportToCSV,window.showIntersectionPointInfoModal=showIntersectionPointInfoModal,window.closeIntersectionPointModal=closeIntersectionPointModal,window.collectPointInfo=collectPointInfo,window.invalidateCache=invalidateCache,window.scheduleRender=scheduleRender,window.calculateAirVolumeAtPoint=calculateAirVolumeAtPoint,window.splitAllLines=splitAllLines,window.generateLineId=generateLineId,window.splitLineAtPoint=splitLineAtPoint,window.checkFlowBalance=checkFlowBalance,window.createTestScenarioComplex=createTestScenarioComplex,window.splitAllLinesBeforeCalculation=splitAllLinesBeforeCalculation,window.exportToPDFWithOptions=exportToPDFWithOptions,window.closePDFExportModal=closePDFExportModal,window.exportToPDF=exportToPDF,window.quickExportToPDF=quickExportToPDF;
console.log('–†–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —á–µ—Ä—Ç–µ–∂–µ–π –∑–∞–≥—Ä—É–∂–µ–Ω —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º —Ä–∞—Å—á–µ—Ç–æ–º –≤–æ–∑–¥—É—à–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤ –¥–ª—è –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞!');