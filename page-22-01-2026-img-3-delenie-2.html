<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–†–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —á–µ—Ä—Ç–µ–∂–µ–π (Fabric.js) —Å —Ä–∞–∑–±–∏–µ–Ω–∏–µ–º –ª–∏–Ω–∏–π</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 10px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .container {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 5px;
      font-size: 32px;
      font-weight: 700;
    }

    .subtitle {
      color: #7f8c8d;
      text-align: center;
      margin-bottom: 25px;
      font-size: 16px;
    }

    .main-content {
      display: flex;
      gap: 25px;
      margin-top: 10px;
    }

    .left-panel {
      flex: 1;
      max-width: 320px;
      min-width: 300px;
    }

    .canvas-container {
      flex: 3;
      min-height: 600px;
    }

    #canvas-container {
      border: 2px solid #ddd;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      background: #fff;
    }

    #fabric-canvas {
      border-radius: 8px;
    }

    #tools {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      border: 1px solid #e9ecef;
    }

    button {
      padding: 8px 5px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .active-mode {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important;
      box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    #status {
      background: #2c3e50;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      margin-top: 15px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      line-height: 1.4;
    }

    .properties-panel {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      max-height: 300px;
      overflow-y: auto;
    }

    .properties-panel h3 {
      color: #2c3e50;
      margin-top: 0;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
      font-size: 18px;
      position: sticky;
      top: 0;
      background: white;
      z-index: 1;
    }

    .property-group {
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #6a11cb;
    }

    .property-group h4 {
      color: #34495e;
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 15px;
    }

    .property-row {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .property-label {
      flex: 1;
      color: #555;
      font-size: 13px;
      font-weight: 500;
    }

    .property-value {
      flex: 1;
      font-size: 13px;
    }

    input[type="number"],
    input[type="text"],
    input[type="color"],
    input[type="url"],
    select,
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border 0.3s;
      box-sizing: border-box;
    }

    input[type="number"]:focus,
    input[type="text"]:focus,
    input[type="color"]:focus,
    input[type="url"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #6a11cb;
      box-shadow: 0 0 0 2px rgba(106, 17, 203, 0.2);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-content {
      background: white;
      padding: 25px;
      border-radius: 15px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .modal-title {
      font-size: 20px;
      color: #2c3e50;
      font-weight: 600;
      margin: 0;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      color: #7f8c8d;
      cursor: pointer;
      padding: 5px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s;
    }

    .close-modal:hover {
      background: #f5f5f5;
      color: #e74c3c;
    }

    .modal-form {
      display: grid;
      gap: 15px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-label {
      color: #34495e;
      font-weight: 600;
      font-size: 14px;
    }

    .form-row {
      display: flex;
      gap: 10px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: flex-end;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
    }

    .btn-secondary {
      background: #95a5a6;
      color: white;
    }

    .btn-danger {
      background: #e74c3c;
      color: white;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1);
    }

    .instructions {
      background: #e8f4fc;
      border-left: 4px solid #3498db;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .instructions h4 {
      color: #2c3e50;
      margin-top: 0;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .instructions ul {
      margin: 10px 0;
      padding-left: 20px;
      color: #555;
    }

    .instructions li {
      margin-bottom: 5px;
      line-height: 1.5;
      font-size: 13px;
    }

    .image-type-badge {
      display: inline-block;
      background: #2c3e50;
      color: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      margin-left: 5px;
      text-transform: uppercase;
    }

    #image-tools-container {
      margin-bottom: 20px;
    }

    .image-tools-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .image-tools-header h4 {
      color: #2c3e50;
      margin: 0;
      font-size: 16px;
    }

    .image-tools-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 15px;
      max-height: 200px;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      background: #f8f9fa;
    }

    .custom-image-actions {
      display: flex;
      gap: 5px;
      margin-top: 5px;
      justify-content: flex-end;
    }

    .custom-image-actions button {
      padding: 4px 8px;
      font-size: 10px;
      background: #95a5a6;
    }

    .custom-image-actions .edit-btn {
      background: #3498db;
    }

    .custom-image-actions .delete-btn {
      background: #e74c3c;
    }

    .image-item {
      border: 2px solid transparent;
      border-radius: 8px;
      padding: 10px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
      background: white;
    }

    .image-item:hover {
      border-color: #6a11cb;
      background: #f8f9fa;
    }

    .image-item.selected {
      border-color: #38ef7d;
      background: #e8f8ef;
    }

    .image-item img {
      width: 40px;
      height: 40px;
      object-fit: contain;
      margin-bottom: 5px;
    }

    .image-item-name {
      font-size: 11px;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 3px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .image-item-type {
      font-size: 9px;
      color: #7f8c8d;
      background: #f1f1f1;
      padding: 2px 6px;
      border-radius: 10px;
      display: inline-block;
    }

    .preview-image {
      width: 100px;
      height: 100px;
      object-fit: contain;
      border: 2px dashed #ddd;
      border-radius: 8px;
      margin: 10px auto;
      display: block;
      background: #f8f9fa;
    }

    .drag-over {
      border-color: #6a11cb !important;
      background: rgba(106, 17, 203, 0.1) !important;
    }

    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #6a11cb;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    .hint {
      font-size: 12px;
      color: #7f8c8d;
      margin-top: 5px;
    }

    .section-divider {
      height: 1px;
      background: #e0e0e0;
      margin: 20px 0;
    }

    .tab-buttons {
      display: flex;
      border-bottom: 2px solid #e0e0e0;
      margin-bottom: 15px;
    }

    .tab-button {
      padding: 10px 20px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: #7f8c8d;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .tab-button.active {
      color: #6a11cb;
      border-bottom-color: #6a11cb;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      z-index: 2000;
      animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .notification.success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .notification.error {
      background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
    }

    .notification.info {
      background: linear-gradient(135deg, #3498db 0%, #2ecc71 100%);
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes fadeOut {
      from {
        opacity: 1;
      }
      to {
        opacity: 0;
      }
    }

    .context-menu {
      position: absolute;
      background: white;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      min-width: 150px;
      display: none;
    }

    .context-menu-item {
      padding: 10px 15px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 14px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .context-menu-item:hover {
      background: #f5f5f5;
    }

    .context-menu-divider {
      height: 1px;
      background: #e0e0e0;
      margin: 5px 0;
    }

    /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ç–æ—á–µ–∫ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è */
    .intersection-point {
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .intersection-point:hover {
      transform: scale(1.2);
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ç–æ—á–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è */
    .intersection-line-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
      border-left: 3px solid #6a11cb;
    }

    .line-end-marker {
      display: inline-block;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      text-align: center;
      line-height: 24px;
      font-weight: bold;
      margin-right: 10px;
      color: white;
    }

    .line-start-marker {
      background: #2ecc71;
    }

    .line-end-marker-bg {
      background: #e74c3c;
    }

    .object-at-intersection {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      padding: 10px;
      background: #e8f4fc;
      border-radius: 6px;
      border-left: 3px solid #3498db;
    }

    .object-icon {
      font-size: 20px;
      margin-right: 10px;
    }

    .line-info-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    .line-info-table th, .line-info-table td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    .line-info-table th {
      background: #f8f9fa;
      font-weight: 600;
    }

    .point-number {
      position: absolute;
      color: white;
      font-size: 10px;
      font-weight: bold;
      pointer-events: none;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –±—É–∫–≤ –ù –∏ –ö –Ω–∞ —Ö–æ–ª—Å—Ç–µ */
    .line-end-label {
      font-size: 14px;
      font-weight: bold;
      pointer-events: none;
    }

    .line-start-label {
      color: #27ae60;
    }

    .line-end-label-color {
      color: #e74c3c;
    }

    @media (max-width: 1200px) {
      .main-content {
        flex-direction: column;
      }

      .left-panel {
        max-width: 100%;
      }

      .canvas-container {
        min-height: 500px;
      }
    }

    @media (max-width: 768px) {
      #tools {
        grid-template-columns: repeat(3, 1fr);
      }

      .image-tools-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 576px) {
      #tools {
        grid-template-columns: repeat(2, 1fr);
      }

      .image-tools-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .modal-content {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>üìê –†–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —á–µ—Ä—Ç–µ–∂–µ–π</h1>
  <p class="subtitle">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ —á–µ—Ä—Ç–µ–∂–∏ —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ —Å–µ—Ç–∫–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ
    —Å–≤–æ–π—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–æ–≤ –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤ JSON
  </p>

  <div class="main-content">
    <div class="left-panel">
      <div id="tools">
        <button
          onclick="activateLineDrawing()"
          id="lineDrawingBtn"
        >
          <span>üìè</span> –õ–∏–Ω–∏—è
        </button>
        <button onclick="splitLinesAtIntersections()">
          <span>‚úÇÔ∏è</span> –†–∞–∑–±–∏—Ç—å –ª–∏–Ω–∏–∏
        </button>
        <button onclick="splitLinesAtSelectedImage()">
          <span>üîó</span> –†–∞–∑–±–∏—Ç—å –ø–æ –æ–±—ä–µ–∫—Ç—É
        </button>
        <button onclick="findIntersectionsOnly()">
          <span>üîç</span> –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
        </button>
        <button onclick="clearIntersectionPoints()">
          <span>üßπ</span> –û—á–∏—Å—Ç–∏—Ç—å —Ç–æ—á–∫–∏
        </button>
        <button onclick="showAllIntersectionPoints()">
          <span>üîµ</span> –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ—á–∫–∏
        </button>
        <button
          onclick="toggleContinuousMode()"
          id="continuousModeBtn"
        >
          <span>üîó</span> –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π (–í–´–ö–õ)
        </button>
        <button onclick="showLinePropertiesModal()">
          <span>‚öôÔ∏è</span> –°–≤–æ–π—Å—Ç–≤–∞ –ª–∏–Ω–∏–∏
        </button>
        <button onclick="showImagePropertiesModal()">
          <span>üñºÔ∏è</span> –°–≤–æ–π—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–∞
        </button>
        <button
          onclick="showAddImageModal()"
          id="addImageBtn"
        >
          <span>‚ûï</span> –î–æ–±–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        </button>
        <button onclick="saveDrawing()">
          <span>üíæ</span> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        </button>
        <button onclick="loadDrawing()">
          <span>üìÇ</span> –ó–∞–≥—Ä—É–∑–∏—Ç—å
        </button>
        <button onclick="clearCanvas()">
          <span>üóëÔ∏è</span> –û—á–∏—Å—Ç–∏—Ç—å —Ö–æ–ª—Å—Ç
        </button>
        <button onclick="exportToConsole()">
          <span>üìä</span> –≠–∫—Å–ø–æ—Ä—Ç
        </button>
        <button
          onclick="toggleGrid()"
          id="gridToggleBtn"
        >
          <span>üî≤</span> –°–µ—Ç–∫–∞ (–í–ö–õ)
        </button>
        <button
          onclick="undoAction()"
          id="undoBtn"
        >
          <span>‚Ü©Ô∏è</span> –û—Ç–º–µ–Ω–∏—Ç—å
        </button>
        <button
          onclick="toggleAutoSplitMode()"
          id="autoSplitBtn"
        >
          <span>‚ö°</span> –ê–≤—Ç–æ—Ä–∞–∑–±–∏–≤–∫–∞ (–í–ö–õ)
        </button>
      </div>

      <div id="image-tools-container">
        <div class="image-tools-header">
          <h4>üìÅ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h4>
          <button
            onclick="showManageImagesModal()"
            style="padding: 5px 10px; font-size: 11px;"
          >
            <span>‚öôÔ∏è</span> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
          </button>
        </div>
        <div
          class="image-tools-grid"
          id="imageToolsGrid"
        >
          <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
        </div>
      </div>

      <div class="properties-panel">
        <h3>–°–≤–æ–π—Å—Ç–≤–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞</h3>
        <div id="props-content">
          <p style="color: #7f8c8d; font-style: italic; text-align: center; padding: 20px;">
            –í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç –Ω–∞ —á–µ—Ä—Ç–µ–∂–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤
          </p>
        </div>
      </div>

      <div id="status">
        –ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ. –û–±—ä–µ–∫—Ç–æ–≤ –Ω–∞ —á–µ—Ä—Ç–µ–∂–µ: 0
      </div>

      <div class="instructions">
        <h4>üìã –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏</h4>
        <ul>
          <li><strong>ESC</strong> - –æ—Ç–º–µ–Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è</li>
          <li><strong>Delete</strong> - —É–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç</li>
          <li><strong>Ctrl+S</strong> - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä—Ç–µ–∂</li>
          <li><strong>Ctrl+O</strong> - –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–µ—Ä—Ç–µ–∂</li>
          <li><strong>Ctrl+Z</strong> - –æ—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ</li>
          <li><strong>Ctrl+Y</strong> - –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –æ—Ç–º–µ–Ω–µ–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ</li>
          <li><strong>Alt + –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ</strong> - –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Ö–æ–ª—Å—Ç–∞</li>
          <li><strong>Shift + –∫–ª–∏–∫</strong> - —Ä–∞–∑–º–µ—Å—Ç–∏—Ç—å –æ–±—ä–µ–∫—Ç</li>
          <li><strong>I</strong> - –Ω–∞–π—Ç–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è</li>
          <li><strong>Ctrl+Shift+S</strong> - —Ä–∞–∑–±–∏—Ç—å –ª–∏–Ω–∏–∏</li>
          <li><strong>L</strong> - —Ä–∏—Å–æ–≤–∞—Ç—å –ª–∏–Ω–∏—é</li>
          <li><strong>N</strong> - –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</li>
          <li><strong>G</strong> - —Å–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å —Å–µ—Ç–∫—É</li>
          <li><strong>Ctrl+G</strong> - —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã</li>
          <li><strong>Ctrl+Shift+G</strong> - —Ä–∞–∑–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å</li>
          <li><strong>A</strong> - –≤–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ—Ä–∞–∑–±–∏–≤–∫—É</li>
          <li><strong>O</strong> - —Ä–∞–∑–±–∏—Ç—å –ª–∏–Ω–∏–∏ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –æ–±—ä–µ–∫—Ç—É</li>
          <li><strong>P</strong> - –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ—á–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è</li>
        </ul>
      </div>
    </div>

    <div class="canvas-container">
      <div id="canvas-container">
        <canvas
          id="fabric-canvas"
          width="1050"
          height="600"
        ></canvas>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤ –ª–∏–Ω–∏–∏ -->
<div
  id="linePropertiesModal"
  class="modal"
>
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">‚öôÔ∏è –°–≤–æ–π—Å—Ç–≤–∞ –ª–∏–Ω–∏–∏</h2>
      <button
        class="close-modal"
        onclick="closeLinePropertiesModal()"
      >√ó
      </button>
    </div>
    <form
      id="linePropertiesForm"
      class="modal-form"
    >
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
          <input
            type="text"
            id="propertyName"
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ì–ª–∞–≤–Ω–∞—è –±–∞–ª–∫–∞"
            required
          >
        </div>
        <div class="form-group">
          <label class="form-label">–¶–≤–µ—Ç –ª–∏–Ω–∏–∏:</label>
          <input
            type="color"
            id="propertyColor"
            value="#2a9d8f"
          >
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">–¢–æ–ª—â–∏–Ω–∞ (px):</label>
          <select id="propertyWidth">
            <option value="1">1 px</option>
            <option
              value="2"
              selected
            >2 px
            </option>
            <option value="3">3 px</option>
            <option value="4">4 px</option>
            <option value="5">5 px</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">–¢–∏–ø –ª–∏–Ω–∏–∏:</label>
          <select id="propertyLineType">
            <option
              value="solid"
              selected
            >–°–ø–ª–æ—à–Ω–∞—è
            </option>
            <option value="dashed">–ü—É–Ω–∫—Ç–∏—Ä–Ω–∞—è</option>
            <option value="dotted">–¢–æ—á–µ—á–Ω–∞—è</option>
          </select>
        </div>
      </div>

      <div class="section-divider"></div>

      <div class="form-group">
        <label class="form-label">1. –î–ª–∏–Ω–∞ (L, –º¬≤):</label>
        <input
          type="number"
          id="propertyL"
          step="0.001"
          min="0"
          placeholder="0.5237"
          required
        >
      </div>
      <div class="form-group">
        <label class="form-label">2. –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (I):</label>
        <input
          type="number"
          id="propertyI"
          step="0.000001"
          min="0"
          placeholder="0.015327"
          required
        >
      </div>
      <div class="form-group">
        <label class="form-label">3. –ü–∞—Ä–∞–º–µ—Ç—Ä (K, –º):</label>
        <input
          type="number"
          id="propertyK"
          step="0.001"
          min="0"
          placeholder="10.235"
          required
        >
      </div>
      <div class="form-group">
        <label class="form-label">4. –í–µ—Å (W, –∫–≥/–º):</label>
        <input
          type="number"
          id="propertyW"
          step="0.01"
          min="0"
          placeholder="1.0"
          required
        >
      </div>

      <div class="modal-buttons">
        <button
          type="button"
          class="btn btn-secondary"
          onclick="closeLinePropertiesModal()"
        >–û—Ç–º–µ–Ω–∞
        </button>
        <button
          type="submit"
          class="btn btn-primary"
        >–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–≤–æ–π—Å—Ç–≤–∞
        </button>
      </div>
    </form>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
<div
  id="imagePropertiesModal"
  class="modal"
>
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">üñºÔ∏è –°–≤–æ–π—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–∞</h2>
      <button
        class="close-modal"
        onclick="closeImagePropertiesModal()"
      >√ó
      </button>
    </div>
    <form
      id="imagePropertiesForm"
      class="modal-form"
    >
      <div class="tab-buttons">
        <button
          type="button"
          class="tab-button active"
          onclick="switchImageTab('basic')"
        >–û—Å–Ω–æ–≤–Ω—ã–µ
        </button>
        <button
          type="button"
          class="tab-button"
          onclick="switchImageTab('technical')"
        >–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ
        </button>
        <button
          type="button"
          class="tab-button"
          onclick="switchImageTab('custom')"
        >–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ
        </button>
      </div>

      <div
        id="imageTabBasic"
        class="tab-content active"
      >
        <div class="form-group">
          <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
          <input
            type="text"
            id="imagePropertyName"
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä –ø—Ä–∏—Ç–æ—á–Ω—ã–π"
            required
          >
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">–®–∏—Ä–∏–Ω–∞ (px):</label>
            <input
              type="number"
              id="imageWidth"
              step="1"
              min="10"
              max="100"
              placeholder="40"
              required
            >
          </div>
          <div class="form-group">
            <label class="form-label">–í—ã—Å–æ—Ç–∞ (px):</label>
            <input
              type="number"
              id="imageHeight"
              step="1"
              min="10"
              max="100"
              placeholder="40"
              required
            >
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">–ü–æ–≤–æ—Ä–æ—Ç (–≥—Ä–∞–¥—É—Å—ã):</label>
          <input
            type="number"
            id="imageRotation"
            step="1"
            min="0"
            max="360"
            placeholder="0"
          >
        </div>
        <div class="form-group">
          <label class="form-label">–ù–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å:</label>
          <input
            type="range"
            id="imageOpacity"
            min="0.1"
            max="1"
            step="0.1"
            value="1"
          >
          <span id="opacityValue">100%</span>
        </div>
      </div>

      <div
        id="imageTabTechnical"
        class="tab-content"
      >
        <div class="form-group">
          <label class="form-label">–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞:</label>
          <select
            id="imageType"
            onchange="updateImageTypeFields()"
          >
            <option value="default">–û–±—ã—á–Ω—ã–π –æ–±—ä–µ–∫—Ç</option>
            <option value="fan">–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä</option>
            <option value="fire">–ü–æ–∂–∞—Ä–Ω—ã–π –¥–∞—Ç—á–∏–∫</option>
            <option value="valve">–ö–ª–∞–ø–∞–Ω</option>
            <option value="pump">–ù–∞—Å–æ—Å</option>
            <option value="sensor">–î–∞—Ç—á–∏–∫</option>
          </select>
        </div>
        <div
          id="fanProperties"
          style="display: none;"
        >
          <div class="form-group">
            <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–∑–¥—É—Ö–∞ (–º¬≥/—á):</label>
            <input
              type="number"
              id="imageAirQuantity"
              step="0.1"
              min="0"
              placeholder="100.0"
            >
          </div>
          <div class="form-group">
            <label class="form-label">–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ –≤–æ–∑–¥—É—Ö–∞ (–ü–∞):</label>
            <input
              type="number"
              id="imageAirResistance"
              step="0.1"
              min="0"
              placeholder="30.0"
            >
          </div>
        </div>
        <div
          id="fireProperties"
          style="display: none;"
        >
          <div class="form-group">
            <label class="form-label">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è (¬∞C):</label>
            <input
              type="number"
              id="fireTemperature"
              step="1"
              min="0"
              placeholder="70"
            >
          </div>
          <div class="form-group">
            <label class="form-label">–ó–æ–Ω–∞ –ø–æ–∫—Ä—ã—Ç–∏—è (–º¬≤):</label>
            <input
              type="number"
              id="fireCoverage"
              step="1"
              min="0"
              placeholder="50"
            >
          </div>
        </div>
        <div
          id="valveProperties"
          style="display: none;"
        >
          <div class="form-group">
            <label class="form-label">–î–∏–∞–º–µ—Ç—Ä (–º–º):</label>
            <input
              type="number"
              id="valveDiameter"
              step="1"
              min="0"
              placeholder="50"
            >
          </div>
          <div class="form-group">
            <label class="form-label">–¢–∏–ø –ø—Ä–∏–≤–æ–¥–∞:</label>
            <select id="valveActuator">
              <option value="manual">–†—É—á–Ω–æ–π</option>
              <option value="electric">–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∏–π</option>
              <option value="pneumatic">–ü–Ω–µ–≤–º–∞—Ç–∏—á–µ—Å–∫–∏–π</option>
            </select>
          </div>
        </div>
      </div>

      <div
        id="imageTabCustom"
        class="tab-content"
      >
        <div id="customPropertiesContainer">
          <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ —Å–≤–æ–π—Å—Ç–≤–∞–º–∏ -->
        </div>
        <div style="margin-top: 10px;">
          <button
            type="button"
            class="btn btn-secondary"
            onclick="addCustomPropertyField()"
            style="padding: 8px 12px; font-size: 12px;"
          >
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π—Å—Ç–≤–æ
          </button>
        </div>
      </div>

      <div class="modal-buttons">
        <button
          type="button"
          class="btn btn-secondary"
          onclick="closeImagePropertiesModal()"
        >–û—Ç–º–µ–Ω–∞
        </button>
        <button
          type="submit"
          class="btn btn-primary"
        >–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–≤–æ–π—Å—Ç–≤–∞
        </button>
      </div>
    </form>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
<div
  id="addImageModal"
  class="modal"
>
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h2>
      <button
        class="close-modal"
        onclick="closeAddImageModal()"
      >√ó
      </button>
    </div>

    <div class="tab-buttons">
      <button
        type="button"
        class="tab-button active"
        onclick="switchAddImageTab('upload')"
      >–ó–∞–≥—Ä—É–∑–∏—Ç—å
      </button>
      <button
        type="button"
        class="tab-button"
        onclick="switchAddImageTab('url')"
      >–ü–æ URL
      </button>
      <button
        type="button"
        class="tab-button"
        onclick="switchAddImageTab('gallery')"
      >–ì–∞–ª–µ—Ä–µ—è
      </button>
    </div>

    <form
      id="addImageForm"
      class="modal-form"
    >
      <div
        id="uploadTab"
        class="tab-content active"
      >
        <div class="form-group">
          <label class="form-label">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</label>
          <div
            id="dropArea"
            style="border: 2px dashed #6a11cb; border-radius: 8px; padding: 30px; text-align: center; cursor: pointer; background: #f8f9fa;"
          >
            <span style="font-size: 48px;">üìÅ</span>
            <p style="margin: 10px 0; font-weight: 600; color: #2c3e50;">
              –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞
            </p>
            <p style="margin: 0; color: #7f8c8d; font-size: 14px;">–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ
              –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
            </p>
            <input
              type="file"
              id="fileInput"
              accept="image/*"
              style="display: none;"
            >
          </div>
          <div class="hint">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: PNG, JPG, SVG, GIF.
            –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 2MB
          </div>
        </div>

        <div
          id="previewContainer"
          style="display: none;"
        >
          <h4 style="margin: 15px 0 10px 0;">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä:</h4>
          <img
            id="imagePreview"
            class="preview-image"
            src=""
            alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä"
          >
          <div
            class="hint"
            style="text-align: center;"
          >–†–∞–∑–º–µ—Ä –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω 40√ó40 –ø–∏–∫—Å–µ–ª–µ–π
          </div>
        </div>
      </div>

      <div
        id="urlTab"
        class="tab-content"
      >
        <div class="form-group">
          <label class="form-label">URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</label>
          <input
            type="url"
            id="newImageUrl"
            placeholder="https://example.com/image.png"
          >
          <div class="hint">–£–∫–∞–∂–∏—Ç–µ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</div>
        </div>

        <div class="form-group">
          <label class="form-label">–ò–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö:</label>
          <div
            class="image-tools-grid"
            id="standardImagesGrid"
          >
            <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
          </div>
        </div>
      </div>

      <div
        id="galleryTab"
        class="tab-content"
      >
        <div id="galleryContainer">
          <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
        </div>
      </div>

      <div class="section-divider"></div>

      <div class="form-group">
        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</label>
        <input
          type="text"
          id="newImageName"
          placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–≤–µ—Ä—å"
          required
        >
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">–ò–∫–æ–Ω–∫–∞ (—ç–º–æ–¥–∑–∏):</label>
          <input
            type="text"
            id="newImageIcon"
            placeholder="üö™"
            value="üñºÔ∏è"
            maxlength="2"
          >
        </div>
        <div class="form-group">
          <label class="form-label">–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞:</label>
          <select id="newImageType">
            <option value="default">–û–±—ã—á–Ω—ã–π –æ–±—ä–µ–∫—Ç</option>
            <option value="fan">–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä</option>
            <option value="fire">–ü–æ–∂–∞—Ä–Ω—ã–π –¥–∞—Ç—á–∏–∫</option>
            <option value="valve">–ö–ª–∞–ø–∞–Ω</option>
            <option value="pump">–ù–∞—Å–æ—Å</option>
            <option value="sensor">–î–∞—Ç—á–∏–∫</option>
            <option value="door">–î–≤–µ—Ä—å</option>
            <option value="window">–û–∫–Ω–æ</option>
            <option value="equipment">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
        <textarea
          id="newImageDescription"
          rows="2"
          placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"
        ></textarea>
      </div>

      <div
        id="addImageCustomProps"
        style="display: none;"
      >
        <h4 style="margin: 15px 0 10px 0;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞:</h4>
        <div id="addImageCustomPropsContainer">
          <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
        </div>
        <div style="margin-top: 10px;">
          <button
            type="button"
            class="btn btn-secondary"
            onclick="addCustomPropertyField('addImage')"
            style="padding: 8px 12px; font-size: 12px;"
          >
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π—Å—Ç–≤–æ
          </button>
        </div>
      </div>

      <div class="modal-buttons">
        <button
          type="button"
          class="btn btn-secondary"
          onclick="closeAddImageModal()"
        >–û—Ç–º–µ–Ω–∞
        </button>
        <button
          type="submit"
          class="btn btn-primary"
          id="submitImageBtn"
        >–î–æ–±–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        </button>
      </div>
    </form>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ -->
<div
  id="manageImagesModal"
  class="modal"
>
  <div
    class="modal-content"
    style="max-width: 700px;"
  >
    <div class="modal-header">
      <h2 class="modal-title">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏</h2>
      <button
        class="close-modal"
        onclick="closeManageImagesModal()"
      >√ó
      </button>
    </div>

    <div class="tab-buttons">
      <button
        type="button"
        class="tab-button active"
        onclick="switchManageTab('custom')"
      >–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ
      </button>
      <button
        type="button"
        class="tab-button"
        onclick="switchManageTab('default')"
      >–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ
      </button>
      <button
        type="button"
        class="tab-button"
        onclick="switchManageTab('import')"
      >–ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç
      </button>
    </div>

    <div
      id="customImagesTab"
      class="tab-content active"
    >
      <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
        <p>–í–∞—à–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</p>
        <button
          onclick="showAddImageModal(); closeManageImagesModal();"
          class="btn btn-primary"
          style="padding: 8px 12px;"
        >
          ‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ
        </button>
      </div>

      <div
        id="customImagesList"
        class="image-tools-grid"
        style="grid-template-columns: repeat(3, 1fr); max-height: 300px;"
      >
        <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
      </div>

      <div
        class="hint"
        style="margin-top: 10px;"
      >
        –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:
        <span id="customImagesCount">0</span>
      </div>
    </div>

    <div
      id="defaultImagesTab"
      class="tab-content"
    >
      <p>–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä:</p>
      <div
        id="defaultImagesList"
        class="image-tools-grid"
        style="grid-template-columns: repeat(3, 1fr); max-height: 300px;"
      >
        <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
      </div>
    </div>

    <div
      id="importExportTab"
      class="tab-content"
    >
      <div class="form-group">
        <h4 style="margin-top: 0;">–≠–∫—Å–ø–æ—Ä—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h4>
        <p>–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤—Å–µ –≤–∞—à–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ñ–∞–π–ª –¥–ª—è
          —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞:
        </p>
        <button
          onclick="exportCustomImages()"
          class="btn btn-primary"
          style="width: 100%; margin-bottom: 15px;"
        >
          üì• –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        </button>
      </div>

      <div class="form-group">
        <h4>–ò–º–ø–æ—Ä—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h4>
        <p>–ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞ (—Ñ–æ—Ä–º–∞—Ç JSON):</p>
        <div style="border: 2px dashed #6a11cb; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; background: #f8f9fa; margin-bottom: 15px;">
          <span style="font-size: 36px;">üìÅ</span>
          <p style="margin: 10px 0; font-weight: 600; color: #2c3e50;">
            –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ JSON —Ñ–∞–π–ª —Å—é–¥–∞
          </p>
          <p style="margin: 0; color: #7f8c8d; font-size: 14px;">–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è
            –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
          </p>
          <input
            type="file"
            id="importFileInput"
            accept=".json"
            style="display: none;"
          >
        </div>
        <div class="hint">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫
          —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º
        </div>
      </div>

      <div class="form-group">
        <h4>–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h4>
        <p>–í–Ω–∏–º–∞–Ω–∏–µ: —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!</p>
        <button
          onclick="clearAllCustomImages()"
          class="btn btn-danger"
          style="width: 100%;"
        >
          üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        </button>
      </div>
    </div>

    <div class="modal-buttons">
      <button
        type="button"
        class="btn btn-secondary"
        onclick="closeManageImagesModal()"
      >–ó–∞–∫—Ä—ã—Ç—å
      </button>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ—á–∫–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è -->
<div
  id="intersectionPointModal"
  class="modal"
>
  <div class="modal-content" style="max-width: 800px; max-height: 80vh;">
    <div class="modal-header">
      <h2 class="modal-title">üìå –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ—á–∫–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è</h2>
      <button class="close-modal" onclick="closeIntersectionPointModal()">√ó</button>
    </div>

    <div id="intersectionPointInfo">
      <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–æ—á–∫–µ -->
    </div>

    <div class="modal-buttons">
      <button type="button" class="btn btn-secondary" onclick="closeIntersectionPointModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<!-- –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é -->
<div
  id="contextMenu"
  class="context-menu"
>
  <div
    class="context-menu-item"
    onclick="copyObject()"
  ><span>üìã</span> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
  </div>
  <div
    class="context-menu-item"
    onclick="pasteObject()"
  ><span>üìÑ</span> –í—Å—Ç–∞–≤–∏—Ç—å
  </div>
  <div class="context-menu-divider"></div>
  <div
    class="context-menu-item"
    onclick="duplicateObject()"
  ><span>üîÅ</span> –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å
  </div>
  <div
    class="context-menu-item"
    onclick="bringObjectToFront()"
  ><span>‚¨ÜÔ∏è</span> –ù–∞ –ø–µ—Ä–µ–¥–Ω–∏–π –ø–ª–∞–Ω
  </div>
  <div
    class="context-menu-item"
    onclick="sendObjectToBack()"
  ><span>‚¨áÔ∏è</span> –ù–∞ –∑–∞–¥–Ω–∏–π –ø–ª–∞–Ω
  </div>
  <div class="context-menu-divider"></div>
  <div
    class="context-menu-item"
    onclick="deleteObject()"
  ><span>üóëÔ∏è</span> –£–¥–∞–ª–∏—Ç—å
  </div>
</div>

<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div id="notificationContainer"></div>

<script>
  // ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
  const canvas = new fabric.Canvas('fabric-canvas', {
    backgroundColor: '#f8f9fa',
    preserveObjectStacking: true,
    selection: true,
    selectionColor: 'rgba(79, 195, 247, 0.3)',
    selectionBorderColor: '#4fc3f7',
    selectionLineWidth: 2,
    renderOnAddRemove: true
  });

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
  let isDrawingLine = false;
  let isContinuousLineMode = false;
  let lineStartPoint = null;
  let previewLine = null;
  let isDragging = false;
  let lastPosX, lastPosY;
  let lastLineEndPoint = null;
  const SNAP_RADIUS = 15;
  let currentEditingLine = null;
  let currentEditingImage = null;
  let currentImageData = null;
  let gridVisible = true;
  let undoStack = [];
  let redoStack = [];
  let copiedObject = null;
  let contextMenuVisible = false;
  let autoSplitMode = true;

  // –ù–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ç–æ—á–µ–∫ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
  let intersectionPoints = [];
  let intersectionCircles = [];

  // –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  const defaultImages = [
    {
      id: 'fan1',
      name: '–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä 1',
      icon: 'üåÄ',
      path: 'https://cdn-icons-png.flaticon.com/512/3067/3067270.png',
      type: 'fan',
      description: '–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä —Ç–∏–ø 1'
    },
    {
      id: 'fan2',
      name: '–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä 2',
      icon: 'üåÄ',
      path: 'https://cdn-icons-png.flaticon.com/512/3067/3067266.png',
      type: 'fan',
      description: '–í–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä —Ç–∏–ø 2'
    },
    {
      id: 'fire',
      name: '–ü–æ–∂–∞—Ä–Ω—ã–π –¥–∞—Ç—á–∏–∫',
      icon: 'üî•',
      path: 'https://cdn-icons-png.flaticon.com/512/3067/3067260.png',
      type: 'fire',
      description: '–î–∞—Ç—á–∏–∫ –ø–æ–∂–∞—Ä–Ω–æ–π —Å–∏–≥–Ω–∞–ª–∏–∑–∞—Ü–∏–∏'
    },
    {
      id: 'valve',
      name: '–ö–ª–∞–ø–∞–Ω',
      icon: 'üîß',
      path: 'https://cdn-icons-png.flaticon.com/512/3067/3067256.png',
      type: 'valve',
      description: '–ó–∞–ø–æ—Ä–Ω—ã–π –∫–ª–∞–ø–∞–Ω'
    },
    {
      id: 'pump',
      name: '–ù–∞—Å–æ—Å',
      icon: '‚öôÔ∏è',
      path: 'https://cdn-icons-png.flaticon.com/512/3067/3067266.png',
      type: 'pump',
      description: '–¶–∏—Ä–∫—É–ª—è—Ü–∏–æ–Ω–Ω—ã–π –Ω–∞—Å–æ—Å'
    },
    {
      id: 'sensor',
      name: '–î–∞—Ç—á–∏–∫',
      icon: 'üì°',
      path: 'https://cdn-icons-png.flaticon.com/512/3067/3067260.png',
      type: 'sensor',
      description: '–î–∞—Ç—á–∏–∫ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã'
    }
  ];

  let customImages = [];
  let allImages = [...defaultImages];

  // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
  document.addEventListener('DOMContentLoaded', function () {
    initializeCanvas();
    loadCustomImages();
    updateImageTools();
    updateStatus();
    console.log('üöÄ –†–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —á–µ—Ä—Ç–µ–∂–µ–π –∑–∞–≥—Ä—É–∂–µ–Ω!');
  });

  function initializeCanvas() {
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–µ—Ç–∫–∏
    drawGrid(20);

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –∫–∞–Ω–≤–∞—Å–∞
    setupCanvasEvents();

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à
    setupKeyboardShortcuts();

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
    initializeModals();
  }

  // ==================== –°–ï–¢–ö–ê ====================
  function drawGrid(gridSize = 20) {
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Å–µ—Ç–∫—É, –µ—Å–ª–∏ –µ—Å—Ç—å
    const oldGrid = canvas.getObjects().filter(obj => obj.id === 'grid-group');
    oldGrid.forEach(obj => canvas.remove(obj));

    if (!gridVisible) return;

    const width = canvas.width, height = canvas.height;
    const gridLines = [];

    for (let x = 0; x <= width; x += gridSize) {
      gridLines.push(new fabric.Line([x, 0, x, height], {
        stroke: 'rgba(224, 224, 224, 0.7)',
        strokeWidth: 1,
        selectable: false,
        evented: false,
        id: 'grid-line'
      }));
    }

    for (let y = 0; y <= height; y += gridSize) {
      gridLines.push(new fabric.Line([0, y, width, y], {
        stroke: 'rgba(224, 224, 224, 0.7)',
        strokeWidth: 1,
        selectable: false,
        evented: false,
        id: 'grid-line'
      }));
    }

    const gridGroup = new fabric.Group(gridLines, {
      selectable: false,
      evented: false,
      hoverCursor: 'default',
      id: 'grid-group'
    });

    canvas.add(gridGroup);
    canvas.sendToBack(gridGroup);
  }

  function toggleGrid() {
    gridVisible = !gridVisible;
    const btn = document.getElementById('gridToggleBtn');

    if (gridVisible) {
      btn.innerHTML = '<span>üî≤</span> –°–µ—Ç–∫–∞ (–í–ö–õ)';
      showNotification('–°–µ—Ç–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞', 'success');
    } else {
      btn.innerHTML = '<span>üî≤</span> –°–µ—Ç–∫–∞ (–í–´–ö–õ)';
      showNotification('–°–µ—Ç–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞', 'info');
    }

    drawGrid(20);
    canvas.renderAll();
  }

  // ==================== –ê–í–¢–û–†–ê–ó–ë–ò–í–ö–ê ====================
  function toggleAutoSplitMode() {
    autoSplitMode = !autoSplitMode;
    const btn = document.getElementById('autoSplitBtn');

    if (autoSplitMode) {
      btn.innerHTML = '<span>‚ö°</span> –ê–≤—Ç–æ—Ä–∞–∑–±–∏–≤–∫–∞ (–í–ö–õ)';
      showNotification('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –ª–∏–Ω–∏–π –≤–∫–ª—é—á–µ–Ω–æ', 'success');
    } else {
      btn.innerHTML = '<span>‚ö°</span> –ê–≤—Ç–æ—Ä–∞–∑–±–∏–≤–∫–∞ (–í–´–ö–õ)';
      showNotification('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –ª–∏–Ω–∏–π –æ—Ç–∫–ª—é—á–µ–Ω–æ', 'info');
    }
  }

  // ==================== –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø ====================
  function loadCustomImages() {
    const saved = localStorage.getItem('customImages');
    if (saved) {
      try {
        customImages = JSON.parse(saved);
        allImages = [...defaultImages, ...customImages];
        console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${customImages.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π`);
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π:', e);
        customImages = [];
      }
    }
  }

  function saveCustomImages() {
    localStorage.setItem('customImages', JSON.stringify(customImages));
  }

  function updateImageTools() {
    const grid = document.getElementById('imageToolsGrid');
    if (!grid) return;

    grid.innerHTML = '';

    allImages.forEach(image => {
      const button = document.createElement('button');
      button.id = `${image.id}Btn`;
      button.className = 'image-item';
      button.innerHTML = `
        <div style="font-size: 20px; margin-bottom: 5px;">${image.icon || 'üñºÔ∏è'}</div>
        <div class="image-item-name">${image.name}</div>
        ${image.id.startsWith('custom_') ? '<div class="image-item-type">–ü</div>' : ''}
      `;

      button.onclick = () => activateImagePlacementMode(image.id);

      if (image.id.startsWith('custom_')) {
        const actions = document.createElement('div');
        actions.className = 'custom-image-actions';
        actions.innerHTML = `
          <button class="edit-btn" onclick="editCustomImage('${image.id}'); event.stopPropagation();">‚úèÔ∏è</button>
          <button class="delete-btn" onclick="deleteCustomImage('${image.id}'); event.stopPropagation();">üóëÔ∏è</button>
        `;
        button.appendChild(actions);
      }

      grid.appendChild(button);
    });
  }

  function activateImagePlacementMode(imageId) {
    deactivateAllModes();

    const image = allImages.find(img => img.id === imageId);
    if (!image) {
      showNotification('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!', 'error');
      return;
    }

    currentImageData = image;

    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
    document.querySelectorAll('.image-item').forEach(btn => btn.classList.remove('active-mode'));

    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–µ
    const currentBtn = document.getElementById(`${imageId}Btn`);
    if (currentBtn) currentBtn.classList.add('active-mode');

    canvas.defaultCursor = 'crosshair';
    canvas.selection = false;

    showNotification(`–†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: ${image.name}. Shift+–∫–ª–∏–∫ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è`, 'info');
  }

  // ==================== –ü–†–ê–í–ö–ê 1: –ò–ó–ú–ï–ù–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –†–ê–ó–ë–ò–ï–ù–ò–Ø –õ–ò–ù–ò–ô ====================
  function splitLinesAtImagePosition(image) {
    const lines = canvas.getObjects().filter(obj =>
      obj.type === 'line' && obj.id !== 'grid-line' && obj !== previewLine
    );

    let linesSplit = 0;
    let linesRemoved = 0;
    const intersectionInfo = [];
    const IMAGE_PADDING = 0; // –£–±—Ä–∞–ª–∏ –æ—Ç—Å—Ç—É–ø - —Ç–µ–ø–µ—Ä—å —Ç–æ—á–Ω–æ –ø–æ –∫—Ä–∞—è–º

    // –ü–æ–ª—É—á–∞–µ–º —Ç–æ—á–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const imgWidth = image.width * image.scaleX;
    const imgHeight = image.height * image.scaleY;

    // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —É–≥–ª–æ–≤ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ë–ï–ó –æ—Ç—Å—Ç—É–ø–æ–≤
    const rect = {
      left: image.left - imgWidth / 2,
      right: image.left + imgWidth / 2,
      top: image.top - imgHeight / 2,
      bottom: image.top + imgHeight / 2
    };

    lines.forEach(line => {
      const lineStart = {x: line.x1, y: line.y1};
      const lineEnd = {x: line.x2, y: line.y2};

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ª–∏–Ω–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–Ω—É—Ç—Ä–∏ –æ–±—ä–µ–∫—Ç–∞
      const isStartInside = isPointInsideRect(lineStart, rect);
      const isEndInside = isPointInsideRect(lineEnd, rect);

      // –ï—Å–ª–∏ –ª–∏–Ω–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–Ω—É—Ç—Ä–∏ –æ–±—ä–µ–∫—Ç–∞ - —É–¥–∞–ª—è–µ–º –µ–µ
      if (isStartInside && isEndInside) {
        canvas.remove(line);
        linesRemoved++;
        return;
      }

      // –ù–∞—Ö–æ–¥–∏–º —Ç–æ—á–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –ª–∏–Ω–∏–∏ —Å –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–º
      const intersections = getLineRectIntersections(lineStart, lineEnd, rect);

      // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
      if (intersections.length > 0) {
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–æ—á–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é –æ—Ç –Ω–∞—á–∞–ª–∞ –ª–∏–Ω–∏–∏
        intersections.sort((a, b) => {
          const distA = distance(lineStart, a.point);
          const distB = distance(lineStart, b.point);
          return distA - distB;
        });

        // –°–æ–∑–¥–∞–µ–º —Å–µ–≥–º–µ–Ω—Ç—ã –≤–Ω–µ –æ–±—ä–µ–∫—Ç–∞
        const segments = [];
        let currentPoint = lineStart;
        let lastPointInside = isStartInside;

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ —Ç–æ—á–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
        for (let i = 0; i < intersections.length; i++) {
          const intersection = intersections[i];

          // –ï—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∞—è —Ç–æ—á–∫–∞ –±—ã–ª–∞ –≤–Ω—É—Ç—Ä–∏, –∞ —Ç–µ–∫—É—â–∞—è —Ç–æ—á–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è - –≤—ã—Ö–æ–¥
          if (lastPointInside) {
            // –¢–æ—á–∫–∞ –≤—ã—Ö–æ–¥–∞ - –Ω–∞—á–∞–ª–æ –Ω–æ–≤–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞
            currentPoint = intersection.point;
            lastPointInside = false;
          } else {
            // –°–æ–∑–¥–∞–µ–º —Å–µ–≥–º–µ–Ω—Ç –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ç–æ—á–∫–∏ –¥–æ —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞
            const segment = createLineSegment(
              currentPoint,
              intersection.point,
              line,
              `–≤—Ö–æ–¥ —á–µ—Ä–µ–∑ ${intersection.side}`
            );
            segments.push(segment);

            currentPoint = intersection.point;
            lastPointInside = true;
          }
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–µ–≥–º–µ–Ω—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å)
        if (!lastPointInside && !isEndInside) {
          const segment = createLineSegment(currentPoint, lineEnd, line, "–≤–Ω–µ –æ–±—ä–µ–∫—Ç–∞");
          segments.push(segment);
        }

        // –£–¥–∞–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω—É—é –ª–∏–Ω–∏—é –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å–µ–≥–º–µ–Ω—Ç—ã
        canvas.remove(line);
        segments.forEach(segment => {
          canvas.add(segment);
        });

        linesSplit++;
        intersectionInfo.push({
          originalLine: line,
          segments: segments,
          intersections: intersections
        });
      }
    });

    if (linesSplit > 0 || linesRemoved > 0) {
      saveToUndoStack();
      showNotification(`–†–∞–∑–±–∏—Ç–æ ${linesSplit} –ª–∏–Ω–∏–π, —É–¥–∞–ª–µ–Ω–æ ${linesRemoved} –ª–∏–Ω–∏–π –ø–æ–¥ –æ–±—ä–µ–∫—Ç–æ–º`, 'success');
      canvas.renderAll();
      updatePropertiesPanel();
    }

    return intersectionInfo;
  }

  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ—á–∫–∏ –≤–Ω—É—Ç—Ä–∏ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞
  function isPointInsideRect(point, rect) {
    return point.x >= rect.left &&
      point.x <= rect.right &&
      point.y >= rect.top &&
      point.y <= rect.bottom;
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏
  function distance(p1, p2) {
    return Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –í–°–ï–• —Ç–æ—á–µ–∫ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –ª–∏–Ω–∏–∏ —Å –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–º
  function getLineRectIntersections(lineStart, lineEnd, rect) {
    const sides = [
      { // –í–µ—Ä—Ö–Ω—è—è —Å—Ç–æ—Ä–æ–Ω–∞
        p1: {x: rect.left, y: rect.top},
        p2: {x: rect.right, y: rect.top},
        side: 'top'
      },
      { // –ü—Ä–∞–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞
        p1: {x: rect.right, y: rect.top},
        p2: {x: rect.right, y: rect.bottom},
        side: 'right'
      },
      { // –ù–∏–∂–Ω—è—è —Å—Ç–æ—Ä–æ–Ω–∞
        p1: {x: rect.right, y: rect.bottom},
        p2: {x: rect.left, y: rect.bottom},
        side: 'bottom'
      },
      { // –õ–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞
        p1: {x: rect.left, y: rect.bottom},
        p2: {x: rect.left, y: rect.top},
        side: 'left'
      }
    ];

    const intersections = [];

    sides.forEach(side => {
      const intersection = lineIntersection(
        {x1: lineStart.x, y1: lineStart.y, x2: lineEnd.x, y2: lineEnd.y},
        {x1: side.p1.x, y1: side.p1.y, x2: side.p2.x, y2: side.p2.y}
      );

      if (intersection) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–æ—á–∫–∞ –ª–µ–∂–∏—Ç –Ω–∞ –æ—Ç—Ä–µ–∑–∫–µ —Å—Ç–æ—Ä–æ–Ω—ã
        const minX = Math.min(side.p1.x, side.p2.x);
        const maxX = Math.max(side.p1.x, side.p2.x);
        const minY = Math.min(side.p1.y, side.p2.y);
        const maxY = Math.max(side.p1.y, side.p2.y);

        if (intersection.x >= minX - 0.1 && intersection.x <= maxX + 0.1 &&
          intersection.y >= minY - 0.1 && intersection.y <= maxY + 0.1) {
          intersections.push({
            point: {x: intersection.x, y: intersection.y},
            side: side.side
          });
        }
      }
    });

    return intersections;
  }

  // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ–≥–º–µ–Ω—Ç–∞ –ª–∏–Ω–∏–∏
  function createLineSegment(start, end, originalLine, segmentType) {
    const length = distance(start, end);

    return new fabric.Line([
      start.x, start.y,
      end.x, end.y
    ], {
      stroke: originalLine.stroke || '#2a9d8f',
      strokeWidth: originalLine.strokeWidth || 3,
      strokeDashArray: originalLine.strokeDashArray,
      fill: false,
      strokeLineCap: 'round',
      hasControls: true,
      hasBorders: true,
      lockRotation: false,
      selectable: true,
      properties: originalLine.properties ? {
        ...originalLine.properties,
        name: `${originalLine.properties.name || '–õ–∏–Ω–∏—è'} (${segmentType})`,
        length: length,
        originalLength: originalLine.properties.length || length,
        segmentType: segmentType
      } : {
        name: `–õ–∏–Ω–∏—è (${segmentType})`,
        length: length,
        segmentType: segmentType
      }
    });
  }

  // ==================== –ü–†–ê–í–ö–ê 2: –ö–ù–û–ü–ö–ê –ü–û–ö–ê–ó–ê–¢–¨ –¢–û–ß–ö–ò –ü–ï–†–ï–°–ï–ß–ï–ù–ò–Ø ====================
  function showAllIntersectionPoints() {
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ç–æ—á–∫–∏
    clearIntersectionPoints();

    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
    const intersections = findAllIntersections();

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ—á–∫–∞—Ö
    intersectionPoints = intersections;

    // –°–æ–∑–¥–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏
    intersections.forEach((inter, index) => {
      // –°–æ–∑–¥–∞–µ–º –∫—Ä—É–≥ –¥–∏–∞–º–µ—Ç—Ä–æ–º 3px
      const circle = new fabric.Circle({
        left: inter.x - 1.5, // 3px –¥–∏–∞–º–µ—Ç—Ä = 1.5px —Ä–∞–¥–∏—É—Å
        top: inter.y - 1.5,
        radius: 1.5,
        fill: '#e74c3c',
        stroke: '#c0392b',
        strokeWidth: 1,
        selectable: true,
        hasControls: false,
        hasBorders: false,
        evented: true,
        originX: 'center',
        originY: 'center',
        id: 'intersection-point',
        pointIndex: index,
        pointData: inter,
        hoverCursor: 'pointer'
      });

      // –°–æ–∑–¥–∞–µ–º —Ç–µ–∫—Å—Ç —Å –Ω–æ–º–µ—Ä–æ–º
      const text = new fabric.Text((index + 1).toString(), {
        left: inter.x + 4,
        top: inter.y - 8,
        fontSize: 10,
        fill: '#2c3e50',
        fontWeight: 'bold',
        selectable: false,
        evented: false,
        id: 'intersection-point-label',
        textBackgroundColor: 'rgba(255, 255, 255, 0.8)',
        padding: 1
      });

      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ —Ç–æ—á–∫—É
      circle.on('mousedown', function(e) {
        if (e.button === 1) { // –õ–µ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –º—ã—à–∏
          showIntersectionPointInfo(index);
        }
      });

      canvas.add(circle);
      canvas.add(text);
      intersectionCircles.push(circle);
    });

    canvas.renderAll();

    if (intersections.length > 0) {
      showNotification(`–ù–∞–π–¥–µ–Ω–æ ${intersections.length} —Ç–æ—á–µ–∫ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Ç–æ—á–∫—É –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.`, 'success');
    } else {
      showNotification('–¢–æ—á–µ–∫ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'info');
    }
  }

  // ==================== –ü–†–ê–í–ö–ê 3: –§–£–ù–ö–¶–ò–Ø –ü–û–ö–ê–ó–ê –ò–ù–§–û–†–ú–ê–¶–ò–ò –û –¢–û–ß–ö–ï ====================
  function showIntersectionPointInfo(pointIndex) {
    const pointData = intersectionPoints[pointIndex];
    if (!pointData) return;

    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –ª–∏–Ω–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ —ç—Ç—É —Ç–æ—á–∫—É
    const allLines = canvas.getObjects().filter(obj =>
      obj.type === 'line' && obj.id !== 'grid-line'
    );

    // –õ–∏–Ω–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è –≤ —ç—Ç–æ–π —Ç–æ—á–∫–µ
    const linesStartingHere = [];
    // –õ–∏–Ω–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—Ç—Å—è –≤ —ç—Ç–æ–π —Ç–æ—á–∫–µ
    const linesEndingHere = [];
    // –õ–∏–Ω–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ —ç—Ç—É —Ç–æ—á–∫—É
    const linesPassingThrough = [];

    // –û–±—ä–µ–∫—Ç—ã –≤ —ç—Ç–æ–π —Ç–æ—á–∫–µ
    const objectsAtPoint = canvas.getObjects().filter(obj =>
      obj.type === 'image' &&
      isPointInsideObject(pointData, obj)
    );

    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é –ª–∏–Ω–∏—é
    allLines.forEach(line => {
      const startDist = distance({x: line.x1, y: line.y1}, pointData);
      const endDist = distance({x: line.x2, y: line.y2}, pointData);

      // –ü–æ—Ä–æ–≥ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è "–≤ —Ç–æ—á–∫–µ"
      const threshold = 2;

      if (startDist < threshold && endDist < threshold) {
        // –õ–∏–Ω–∏—è —è–≤–ª—è–µ—Ç—Å—è —Ç–æ—á–∫–æ–π (–Ω—É–ª–µ–≤–æ–π –¥–ª–∏–Ω—ã)
        linesPassingThrough.push({
          line: line,
          type: 'point',
          distanceFromStart: 0
        });
      } else if (startDist < threshold) {
        // –õ–∏–Ω–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–π —Ç–æ—á–∫–µ
        linesStartingHere.push({
          line: line,
          type: 'start',
          distanceFromEnd: endDist
        });
      } else if (endDist < threshold) {
        // –õ–∏–Ω–∏—è –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–π —Ç–æ—á–∫–µ
        linesEndingHere.push({
          line: line,
          type: 'end',
          distanceFromStart: startDist
        });
      } else {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—Ö–æ–¥–∏—Ç –ª–∏ –ª–∏–Ω–∏—è —á–µ—Ä–µ–∑ —Ç–æ—á–∫—É
        const lineLength = distance({x: line.x1, y: line.y1}, {x: line.x2, y: line.y2});
        const toStart = distance({x: line.x1, y: line.y1}, pointData);
        const toEnd = distance({x: line.x2, y: line.y2}, pointData);

        // –ï—Å–ª–∏ —Å—É–º–º–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–π –¥–æ –∫–æ–Ω—Ü–æ–≤ –ø—Ä–∏–º–µ—Ä–Ω–æ —Ä–∞–≤–Ω–∞ –¥–ª–∏–Ω–µ –ª–∏–Ω–∏–∏, —Ç–æ—á–∫–∞ –ª–µ–∂–∏—Ç –Ω–∞ –ª–∏–Ω–∏–∏
        if (Math.abs(toStart + toEnd - lineLength) < 1) {
          linesPassingThrough.push({
            line: line,
            type: 'through',
            distanceFromStart: toStart,
            distanceFromEnd: toEnd
          });
        }
      }
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫–∏ –ù –∏ –ö –Ω–∞ —Ö–æ–ª—Å—Ç –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
    addLineEndLabelsToCanvas(linesStartingHere, linesEndingHere, pointData);

    // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    let html = `
      <div class="property-group">
        <h4>üìå –¢–æ—á–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è #${pointIndex + 1}</h4>
        <div class="property-row">
          <div class="property-label">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</div>
          <div class="property-value">X: ${pointData.x.toFixed(1)}, Y: ${pointData.y.toFixed(1)}</div>
        </div>
        <div class="property-row">
          <div class="property-label">–ü–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–µ—Å—è –ª–∏–Ω–∏–∏:</div>
          <div class="property-value">${pointData.line1.properties?.name || '–õ–∏–Ω–∏—è 1'} –∏ ${pointData.line2.properties?.name || '–õ–∏–Ω–∏—è 2'}</div>
        </div>
      </div>
    `;

    // –°–µ–∫—Ü–∏—è –¥–ª—è –ª–∏–Ω–∏–π, –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö—Å—è –≤ —Ç–æ—á–∫–µ
    if (linesStartingHere.length > 0) {
      html += `
        <div class="property-group" style="border-left-color: #2ecc71;">
          <h4>üü¢ –õ–∏–Ω–∏–∏, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è –≤ —Ç–æ—á–∫–µ (${linesStartingHere.length})</h4>
      `;

      linesStartingHere.forEach((lineInfo, index) => {
        const line = lineInfo.line;
        const props = line.properties || {};
        html += `
          <div class="intersection-line-item">
            <div class="line-end-marker line-start-marker">–ù</div>
            <div style="flex: 1;">
              <strong>${props.name || `–õ–∏–Ω–∏—è ${index + 1}`}</strong><br>
              <small>–î–ª–∏–Ω–∞: ${props.length ? props.length.toFixed(1) : '–Ω/–¥'} px</small>
            </div>
          </div>
        `;
      });

      html += `</div>`;
    }

    // –°–µ–∫—Ü–∏—è –¥–ª—è –ª–∏–Ω–∏–π, –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—â–∏—Ö—Å—è –≤ —Ç–æ—á–∫–µ
    if (linesEndingHere.length > 0) {
      html += `
        <div class="property-group" style="border-left-color: #e74c3c;">
          <h4>üî¥ –õ–∏–Ω–∏–∏, –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—â–∏–µ—Å—è –≤ —Ç–æ—á–∫–µ (${linesEndingHere.length})</h4>
      `;

      linesEndingHere.forEach((lineInfo, index) => {
        const line = lineInfo.line;
        const props = line.properties || {};
        html += `
          <div class="intersection-line-item">
            <div class="line-end-marker line-end-marker-bg">–ö</div>
            <div style="flex: 1;">
              <strong>${props.name || `–õ–∏–Ω–∏—è ${index + 1}`}</strong><br>
              <small>–î–ª–∏–Ω–∞: ${props.length ? props.length.toFixed(1) : '–Ω/–¥'} px</small>
            </div>
          </div>
        `;
      });

      html += `</div>`;
    }

    // –°–µ–∫—Ü–∏—è –¥–ª—è –æ–±—ä–µ–∫—Ç–æ–≤ –≤ —Ç–æ—á–∫–µ
    if (objectsAtPoint.length > 0) {
      html += `
        <div class="property-group" style="border-left-color: #3498db;">
          <h4>üèóÔ∏è –û–±—ä–µ–∫—Ç—ã –≤ —Ç–æ—á–∫–µ (${objectsAtPoint.length})</h4>
      `;

      objectsAtPoint.forEach((obj, index) => {
        const props = obj.properties || {};
        html += `
          <div class="object-at-intersection">
            <div class="object-icon">${getObjectIcon(props.type)}</div>
            <div style="flex: 1;">
              <strong>${props.name || `–û–±—ä–µ–∫—Ç ${index + 1}`}</strong><br>
              <small>–¢–∏–ø: ${props.type || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</small>
            </div>
          </div>
        `;
      });

      html += `</div>`;
    }

    // –¢–∞–±–ª–∏—Ü–∞ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ —Å–≤–æ–π—Å—Ç–≤–∞–º–∏ –≤—Å–µ—Ö –ª–∏–Ω–∏–π
    if (linesStartingHere.length > 0 || linesEndingHere.length > 0) {
      html += `
        <div class="property-group">
          <h4>üìä –î–µ—Ç–∞–ª—å–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –ª–∏–Ω–∏–π</h4>
          <table class="line-info-table">
            <thead>
              <tr>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–¢–∏–ø –∫–æ–Ω—Ü–∞</th>
                <th>L (–º¬≤)</th>
                <th>I</th>
                <th>K (–º)</th>
                <th>W (–∫–≥/–º)</th>
                <th>–î–ª–∏–Ω–∞</th>
              </tr>
            </thead>
            <tbody>
      `;

      // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö—Å—è –ª–∏–Ω–∏–π
      linesStartingHere.forEach(lineInfo => {
        const line = lineInfo.line;
        const props = line.properties || {};
        html += `
          <tr>
            <td>${props.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</td>
            <td><span class="line-start-marker" style="padding: 2px 6px; border-radius: 3px; color: white;">–ù–∞—á–∞–ª–æ (–ù)</span></td>
            <td>${props.L ? props.L.toFixed(4) : '0.0000'}</td>
            <td>${props.I ? props.I.toFixed(6) : '0.000000'}</td>
            <td>${props.K ? props.K.toFixed(3) : '0.000'}</td>
            <td>${props.W ? props.W.toFixed(2) : '0.00'}</td>
            <td>${props.length ? props.length.toFixed(1) : '0.0'} px</td>
          </tr>
        `;
      });

      // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—â–∏—Ö—Å—è –ª–∏–Ω–∏–π
      linesEndingHere.forEach(lineInfo => {
        const line = lineInfo.line;
        const props = line.properties || {};
        html += `
          <tr>
            <td>${props.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</td>
            <td><span class="line-end-marker-bg" style="padding: 2px 6px; border-radius: 3px; color: white;">–ö–æ–Ω–µ—Ü (–ö)</span></td>
            <td>${props.L ? props.L.toFixed(4) : '0.0000'}</td>
            <td>${props.I ? props.I.toFixed(6) : '0.000000'}</td>
            <td>${props.K ? props.K.toFixed(3) : '0.000'}</td>
            <td>${props.W ? props.W.toFixed(2) : '0.00'}</td>
            <td>${props.length ? props.length.toFixed(1) : '0.0'} px</td>
          </tr>
        `;
      });

      html += `
            </tbody>
          </table>
        </div>
      `;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    document.getElementById('intersectionPointInfo').innerHTML = html;

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    document.getElementById('intersectionPointModal').style.display = 'flex';
  }

  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ—á–∫–∏ –≤–Ω—É—Ç—Ä–∏ –æ–±—ä–µ–∫—Ç–∞
  function isPointInsideObject(point, obj) {
    if (obj.type !== 'image') return false;

    const left = obj.left - (obj.width * obj.scaleX) / 2;
    const right = obj.left + (obj.width * obj.scaleX) / 2;
    const top = obj.top - (obj.height * obj.scaleY) / 2;
    const bottom = obj.top + (obj.height * obj.scaleY) / 2;

    return point.x >= left && point.x <= right && point.y >= top && point.y <= bottom;
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏ –æ–±—ä–µ–∫—Ç–∞
  function getObjectIcon(type) {
    const icons = {
      'fan': 'üåÄ',
      'fire': 'üî•',
      'valve': 'üîß',
      'pump': '‚öôÔ∏è',
      'sensor': 'üì°',
      'door': 'üö™',
      'window': 'ü™ü',
      'equipment': 'üî®',
      'default': 'üñºÔ∏è'
    };
    return icons[type] || icons['default'];
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫ –ù –∏ –ö –Ω–∞ —Ö–æ–ª—Å—Ç
  function addLineEndLabelsToCanvas(startingLines, endingLines, pointData) {
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –º–µ—Ç–∫–∏
    canvas.getObjects().forEach(obj => {
      if (obj.id === 'line-end-label') {
        canvas.remove(obj);
      }
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫–∏ –¥–ª—è –ª–∏–Ω–∏–π, –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö—Å—è –≤ —Ç–æ—á–∫–µ
    startingLines.forEach((lineInfo, index) => {
      const line = lineInfo.line;
      const angle = Math.atan2(line.y2 - line.y1, line.x2 - line.x1);
      const offsetX = Math.cos(angle) * 20;
      const offsetY = Math.sin(angle) * 20;

      const label = new fabric.Text('–ù', {
        left: pointData.x + offsetX,
        top: pointData.y + offsetY,
        fontSize: 14,
        fill: '#27ae60',
        fontWeight: 'bold',
        selectable: false,
        evented: false,
        id: 'line-end-label',
        originX: 'center',
        originY: 'center'
      });

      canvas.add(label);
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫–∏ –¥–ª—è –ª–∏–Ω–∏–π, –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—â–∏—Ö—Å—è –≤ —Ç–æ—á–∫–µ
    endingLines.forEach((lineInfo, index) => {
      const line = lineInfo.line;
      const angle = Math.atan2(line.y1 - line.y2, line.x1 - line.x2);
      const offsetX = Math.cos(angle) * 20;
      const offsetY = Math.sin(angle) * 20;

      const label = new fabric.Text('–ö', {
        left: pointData.x + offsetX,
        top: pointData.y + offsetY,
        fontSize: 14,
        fill: '#e74c3c',
        fontWeight: 'bold',
        selectable: false,
        evented: false,
        id: 'line-end-label',
        originX: 'center',
        originY: 'center'
      });

      canvas.add(label);
    });

    canvas.renderAll();
  }

  // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ç–æ—á–∫–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
  function closeIntersectionPointModal() {
    document.getElementById('intersectionPointModal').style.display = 'none';

    // –£–¥–∞–ª—è–µ–º –º–µ—Ç–∫–∏ –ù –∏ –ö —Å —Ö–æ–ª—Å—Ç–∞
    canvas.getObjects().forEach(obj => {
      if (obj.id === 'line-end-label') {
        canvas.remove(obj);
      }
    });

    canvas.renderAll();
  }

  // ==================== –†–ò–°–û–í–ê–ù–ò–ï –õ–ò–ù–ò–ô ====================
  function activateLineDrawing() {
    deactivateAllModes();
    isDrawingLine = true;
    canvas.defaultCursor = 'crosshair';
    canvas.selection = false;
    canvas.forEachObject(obj => obj.selectable = false);

    document.getElementById('lineDrawingBtn').classList.add('active-mode');

    const modeText = isContinuousLineMode
      ? '–†–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è –ª–∏–Ω–∏–∏ (–Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π). –ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –Ω–∞—á–∞–ª–∞, –∑–∞—Ç–µ–º –¥–ª—è –∫–æ–Ω—Ü–∞.'
      : '–†–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è –ª–∏–Ω–∏–∏. –ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –Ω–∞—á–∞–ª–∞, –∑–∞—Ç–µ–º –¥–ª—è –∫–æ–Ω—Ü–∞.';

    showNotification(modeText + ' ESC –¥–ª—è –æ—Ç–º–µ–Ω—ã.', 'info');
  }

  function toggleContinuousMode() {
    isContinuousLineMode = !isContinuousLineMode;
    const btn = document.getElementById('continuousModeBtn');

    if (isContinuousLineMode) {
      btn.innerHTML = '<span>üîó</span> –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π (–í–ö–õ)';
      showNotification('–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π —Ä–µ–∂–∏–º –í–ö–õ–Æ–ß–ï–ù', 'success');
    } else {
      btn.innerHTML = '<span>üîó</span> –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π (–í–´–ö–õ)';
      showNotification('–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π —Ä–µ–∂–∏–º –í–´–ö–õ–Æ–ß–ï–ù', 'info');
    }
  }

  // ==================== –ü–ï–†–ï–°–ï–ß–ï–ù–ò–Ø –õ–ò–ù–ò–ô ====================
  function lineIntersection(line1, line2) {
    if (line1 === line2) return null;

    const x1 = line1.x1, y1 = line1.y1;
    const x2 = line1.x2, y2 = line1.y2;
    const x3 = line2.x1, y3 = line2.y1;
    const x4 = line2.x2, y4 = line2.y2;

    const denominator = (y4 - y3) * (x2 - x1) - (x4 - x3) * (y2 - y1);

    if (Math.abs(denominator) < 0.000001) {
      return null;
    }

    const t = ((x4 - x3) * (y1 - y3) - (y4 - y3) * (x1 - x3)) / denominator;
    const u = ((x2 - x1) * (y1 - y3) - (y2 - y1) * (x1 - x3)) / denominator;

    if (t >= 0 && t <= 1 && u >= 0 && u <= 1) {
      const x = x1 + t * (x2 - x1);
      const y = y1 + t * (y2 - y1);

      const epsilon = 0.05;
      if (t < epsilon || t > 1 - epsilon || u < epsilon || u > 1 - epsilon) {
        return null;
      }

      return {
        x: Math.round(x * 100) / 100,
        y: Math.round(y * 100) / 100,
        t: t,
        line1: line1,
        line2: line2
      };
    }

    return null;
  }

  function findAllIntersections() {
    const lines = canvas.getObjects().filter(obj =>
      obj.type === 'line' && obj.id !== 'grid-line' && obj !== previewLine
    );

    const intersections = [];

    for (let i = 0; i < lines.length; i++) {
      for (let j = i + 1; j < lines.length; j++) {
        const intersection = lineIntersection(lines[i], lines[j]);
        if (intersection) {
          intersections.push(intersection);
        }
      }
    }

    return intersections;
  }

  function showIntersectionPoints() {
    clearIntersectionPoints();

    const intersections = findAllIntersections();

    intersections.forEach((inter, index) => {
      const circle = new fabric.Circle({
        left: inter.x - 8,
        top: inter.y - 8,
        radius: 8,
        fill: '#e74c3c',
        stroke: '#c0392b',
        strokeWidth: 2,
        selectable: false,
        hasControls: false,
        hasBorders: false,
        evented: false,
        originX: 'center',
        originY: 'center',
        id: 'intersection-point'
      });

      const text = new fabric.Text((index + 1).toString(), {
        left: inter.x + 12,
        top: inter.y - 12,
        fontSize: 14,
        fill: '#2c3e50',
        fontWeight: 'bold',
        selectable: false,
        evented: false,
        id: 'intersection-point',
        textBackgroundColor: 'rgba(255, 255, 255, 0.8)',
        padding: 3
      });

      canvas.add(circle);
      canvas.add(text);
      canvas.sendToBack(circle);
      canvas.sendToBack(text);
    });

    canvas.renderAll();
    return intersections;
  }

  function splitLinesAtIntersections() {
    const intersections = findAllIntersections();

    if (intersections.length === 0) {
      showNotification('–ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!', 'info');
      return;
    }

    showIntersectionPoints();

    const linesToSplit = new Map();

    intersections.forEach(inter => {
      if (!linesToSplit.has(inter.line1)) {
        linesToSplit.set(inter.line1, []);
      }

      const existingPoint = linesToSplit.get(inter.line1).find(p =>
        Math.abs(p.x - inter.x) < 1 && Math.abs(p.y - inter.y) < 1
      );

      if (!existingPoint) {
        linesToSplit.get(inter.line1).push({
          x: inter.x,
          y: inter.y,
          t: inter.t
        });
      }

      if (!linesToSplit.has(inter.line2)) {
        linesToSplit.set(inter.line2, []);
      }

      const existingPoint2 = linesToSplit.get(inter.line2).find(p =>
        Math.abs(p.x - inter.x) < 1 && Math.abs(p.y - inter.y) < 1
      );

      if (!existingPoint2) {
        linesToSplit.get(inter.line2).push({
          x: inter.x,
          y: inter.y,
          t: inter.t
        });
      }
    });

    const newLines = [];

    linesToSplit.forEach((points, line) => {
      const startPoint = {x: line.x1, y: line.y1, t: 0};
      const endPoint = {x: line.x2, y: line.y2, t: 1};
      const allPoints = [startPoint, ...points, endPoint];
      allPoints.sort((a, b) => a.t - b.t);

      for (let i = 0; i < allPoints.length - 1; i++) {
        const p1 = allPoints[i];
        const p2 = allPoints[i + 1];
        const dx = p2.x - p1.x;
        const dy = p2.y - p1.y;
        const length = Math.sqrt(dx * dx + dy * dy);

        if (length > 2) {
          const totalLength = Math.sqrt(
            Math.pow(line.x2 - line.x1, 2) + Math.pow(line.y2 - line.y1, 2)
          );
          const lengthRatio = length / totalLength;

          const segment = new fabric.Line([
            p1.x, p1.y, p2.x, p2.y
          ], {
            stroke: line.stroke || '#2a9d8f',
            strokeWidth: line.strokeWidth || 3,
            strokeDashArray: line.strokeDashArray,
            fill: false,
            strokeLineCap: 'round',
            hasControls: true,
            hasBorders: true,
            lockRotation: false,
            selectable: true,
            properties: line.properties ? {
              name: `${line.properties.name || '–õ–∏–Ω–∏—è'} (—Å–µ–≥–º–µ–Ω—Ç ${i + 1})`,
              L: line.properties.L ? line.properties.L * lengthRatio : 0.5 * lengthRatio,
              I: line.properties.I ? line.properties.I * lengthRatio : 0.015 * lengthRatio,
              K: line.properties.K ? line.properties.K * lengthRatio : 10 * lengthRatio,
              W: line.properties.W ? line.properties.W * lengthRatio : 1.0 * lengthRatio,
              length: length
            } : {
              name: `–°–µ–≥–º–µ–Ω—Ç ${i + 1}`,
              L: 0.5 * lengthRatio,
              I: 0.015 * lengthRatio,
              K: 10 * lengthRatio,
              W: 1.0 * lengthRatio,
              length: length
            }
          });

          newLines.push(segment);
        }
      }
    });

    linesToSplit.forEach((points, line) => {
      canvas.remove(line);
    });

    newLines.forEach(segment => {
      canvas.add(segment);
    });

    clearIntersectionPoints();

    showNotification(`–†–∞–∑–±–∏—Ç–æ ${linesToSplit.size} –ª–∏–Ω–∏–π –Ω–∞ ${newLines.length} —Å–µ–≥–º–µ–Ω—Ç–æ–≤`, 'success');
    canvas.renderAll();
    updatePropertiesPanel();
  }

  function clearIntersectionPoints() {
    const objects = canvas.getObjects();
    for (let i = objects.length - 1; i >= 0; i--) {
      if (objects[i].id === 'intersection-point' ||
        objects[i].id === 'intersection-point-label' ||
        objects[i].id === 'connection-point') {
        canvas.remove(objects[i]);
      }
    }

    // –û—á–∏—â–∞–µ–º –º–∞—Å—Å–∏–≤—ã
    intersectionPoints = [];
    intersectionCircles = [];

    canvas.renderAll();
  }

  function findIntersectionsOnly() {
    clearIntersectionPoints();
    const intersections = showIntersectionPoints();

    if (intersections.length === 0) {
      showNotification('–ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!', 'info');
    } else {
      showNotification(`–ù–∞–π–¥–µ–Ω–æ ${intersections.length} –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π`, 'success');
    }

    return intersections;
  }

  // ==================== –§–£–ù–ö–¶–ò–Ø –†–ê–ó–ë–ò–ï–ù–ò–Ø –õ–ò–ù–ò–ô –ü–û –í–´–ë–†–ê–ù–ù–û–ú–£ –û–ë–™–ï–ö–¢–£ ====================
  function splitLinesAtSelectedImage() {
    const activeObject = canvas.getActiveObject();

    if (!activeObject || activeObject.type !== 'image') {
      showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ä–∞–∑–±–∏–µ–Ω–∏—è –ª–∏–Ω–∏–π!', 'error');
      return;
    }

    const result = splitLinesAtImagePosition(activeObject);

    if (result.length === 0) {
      showNotification('–ù–µ—Ç –ª–∏–Ω–∏–π –¥–ª—è —Ä–∞–∑–±–∏–µ–Ω–∏—è –Ω–∞ —ç—Ç–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏', 'info');
    }
  }

  function addImageAtPosition(x, y) {
    if (!currentImageData) {
      showNotification('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ!', 'error');
      return;
    }

    const MAX_SIZE = 40;

    fabric.Image.fromURL(currentImageData.path, function (img) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å –ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      if (!img.width || !img.height) {
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è!', 'error');
        return;
      }

      // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
      const originalWidth = img.width || 100;
      const originalHeight = img.height || 100;
      const scale = Math.min(MAX_SIZE / originalWidth, MAX_SIZE / originalHeight, 1);

      const finalWidth = originalWidth * scale;
      const finalHeight = originalHeight * scale;

      // –°–æ–∑–¥–∞–µ–º —Å–≤–æ–π—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–∞
      const properties = {
        name: currentImageData.name,
        type: currentImageData.type || 'default',
        imageId: currentImageData.id,
        imagePath: currentImageData.path,
        width: finalWidth,
        height: finalHeight,
        description: currentImageData.description || '',
        ...currentImageData.properties
      };

      img.set({
        left: x,
        top: y,
        scaleX: scale,
        scaleY: scale,
        hasControls: true,
        hasBorders: true,
        lockUniScaling: false,
        selectable: true,
        originX: 'center',
        originY: 'center',
        properties: properties
      });

      // –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–µ—Ç–∫–µ
      const gridSize = 20;
      img.set({
        left: snapToGrid(img.left, gridSize),
        top: snapToGrid(img.top, gridSize)
      });

      saveToUndoStack();
      canvas.add(img);
      canvas.setActiveObject(img);

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–±–∏–≤–∞–µ–º –ª–∏–Ω–∏–∏, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º –∞–≤—Ç–æ—Ä–∞–∑–±–∏–≤–∫–∏
      if (autoSplitMode) {
        setTimeout(() => {
          const splitResult = splitLinesAtImagePosition(img);
          if (splitResult.length > 0) {
            showNotification(`–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–±–∏—Ç–æ ${splitResult.length} –ª–∏–Ω–∏–π`, 'success');
          }
        }, 50);
      }

      updatePropertiesPanel();
      updateStatus();

      showNotification(`${currentImageData.name} –¥–æ–±–∞–≤–ª–µ–Ω`, 'success');

    }, {
      crossOrigin: 'anonymous'
    }, function (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
      showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è!', 'error');
    });
  }

  // ==================== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô –ö–ê–ù–í–ê–°–ê ====================
  function setupCanvasEvents() {
    // –°–æ–±—ã—Ç–∏—è –º—ã—à–∏
    canvas.on('mouse:down', function (options) {
      const pointer = canvas.getPointer(options.e);
      const gridSize = 20;

      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ Shift+–∫–ª–∏–∫
      if (options.e.shiftKey && currentImageData) {
        addImageAtPosition(pointer.x, pointer.y);
        return;
      }

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –Ω–∞ —Ç–æ—á–∫—É –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
      if (options.target && options.target.id === 'intersection-point') {
        const pointIndex = options.target.pointIndex;
        if (pointIndex !== undefined) {
          showIntersectionPointInfo(pointIndex);
          options.e.preventDefault();
        }
        return;
      }

      // –†–∏—Å–æ–≤–∞–Ω–∏–µ –ª–∏–Ω–∏–∏
      if (isDrawingLine) {
        let snappedX, snappedY;

        if (isContinuousLineMode && lastLineEndPoint) {
          const distanceToLastPoint = Math.sqrt(
            Math.pow(pointer.x - lastLineEndPoint.x, 2) +
            Math.pow(pointer.y - lastLineEndPoint.y, 2)
          );

          if (distanceToLastPoint < SNAP_RADIUS) {
            snappedX = lastLineEndPoint.x;
            snappedY = lastLineEndPoint.y;
          } else {
            snappedX = snapToGrid(pointer.x, gridSize);
            snappedY = snapToGrid(pointer.y, gridSize);
          }
        } else {
          snappedX = snapToGrid(pointer.x, gridSize);
          snappedY = snapToGrid(pointer.y, gridSize);
        }

        if (!lineStartPoint) {
          lineStartPoint = {x: snappedX, y: snappedY};
          previewLine = new fabric.Line([
            lineStartPoint.x, lineStartPoint.y, snappedX, snappedY
          ], {
            stroke: '#2a9d8f',
            strokeWidth: 3,
            strokeDashArray: [5, 5],
            selectable: false,
            evented: false
          });
          canvas.add(previewLine);
        } else {
          const length = Math.sqrt(
            Math.pow(snappedX - lineStartPoint.x, 2) +
            Math.pow(snappedY - lineStartPoint.y, 2)
          );

          const lineType = document.getElementById('propertyLineType')?.value || 'solid';
          let strokeDashArray;
          switch (lineType) {
            case 'dashed':
              strokeDashArray = [5, 5];
              break;
            case 'dotted':
              strokeDashArray = [2, 2];
              break;
            default:
              strokeDashArray = null;
          }

          const finalLine = new fabric.Line([
            lineStartPoint.x, lineStartPoint.y, snappedX, snappedY
          ], {
            stroke: document.getElementById('propertyColor')?.value || '#2a9d8f',
            strokeWidth: parseInt(document.getElementById('propertyWidth')?.value || 2),
            strokeDashArray: strokeDashArray,
            fill: false,
            strokeLineCap: 'round',
            hasControls: true,
            hasBorders: true,
            lockRotation: false,
            properties: {
              name: document.getElementById('propertyName')?.value || `–õ–∏–Ω–∏—è ${canvas.getObjects().filter(o => o.type === 'line' && o.id !== 'grid-line').length + 1}`,
              L: parseFloat(document.getElementById('propertyL')?.value) || 0.5,
              I: parseFloat(document.getElementById('propertyI')?.value) || 0.015,
              K: parseFloat(document.getElementById('propertyK')?.value) || 10,
              W: parseFloat(document.getElementById('propertyW')?.value) || 1.0,
              length: length
            }
          });

          saveToUndoStack();
          canvas.add(finalLine);
          canvas.setActiveObject(finalLine);
          updatePropertiesPanel();

          lastLineEndPoint = {x: snappedX, y: snappedY};

          if (isContinuousLineMode) {
            lineStartPoint = {x: snappedX, y: snappedY};
            if (previewLine) {
              previewLine.set({
                x1: lineStartPoint.x,
                y1: lineStartPoint.y,
                x2: snappedX,
                y2: snappedY
              });
            }
          } else {
            deactivateAllModes();
          }
        }
        return;
      }

      // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Ö–æ–ª—Å—Ç–∞ –ø–æ Alt
      if (options.e.altKey) {
        isDragging = true;
        lastPosX = pointer.x;
        lastPosY = pointer.y;
        canvas.defaultCursor = 'grabbing';
        return;
      }
    });

    canvas.on('mouse:move', function (options) {
      const pointer = canvas.getPointer(options.e);
      updateStatus(pointer.x, pointer.y);

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é –ª–∏–Ω–∏–∏ –ø—Ä–∏ —Ä–∏—Å–æ–≤–∞–Ω–∏–∏
      if (isDrawingLine && lineStartPoint && previewLine) {
        const snappedX = snapToGrid(pointer.x, 20);
        const snappedY = snapToGrid(pointer.y, 20);
        previewLine.set({x2: snappedX, y2: snappedY});
        previewLine.setCoords();
        canvas.requestRenderAll();
      }

      // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Ö–æ–ª—Å—Ç–∞
      if (isDragging && options.e.altKey) {
        const deltaX = pointer.x - lastPosX;
        const deltaY = pointer.y - lastPosY;
        canvas.relativePan(new fabric.Point(deltaX, deltaY));
        lastPosX = pointer.x;
        lastPosY = pointer.y;
      }
    });

    canvas.on('mouse:up', function () {
      if (isDragging) {
        isDragging = false;
        canvas.defaultCursor = 'default';
      }
    });

    // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é (–ø—Ä–∞–≤–∞—è –∫–Ω–æ–ø–∫–∞ –º—ã—à–∏)
    canvas.on('mouse:down', function (options) {
      if (options.e.button === 2) { // –ü—Ä–∞–≤–∞—è –∫–Ω–æ–ø–∫–∞ –º—ã—à–∏
        const pointer = canvas.getPointer(options.e);
        const activeObject = canvas.getActiveObject();

        if (activeObject) {
          showContextMenu(pointer.x, pointer.y);
        }
        options.e.preventDefault();
      }
    });

    // –í—ã–±–æ—Ä –æ–±—ä–µ–∫—Ç–æ–≤
    canvas.on('selection:created', updatePropertiesPanel);
    canvas.on('selection:updated', updatePropertiesPanel);
    canvas.on('selection:cleared', updatePropertiesPanel);

    // –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Å–µ—Ç–∫–µ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏
    canvas.on('object:moving', function (options) {
      const obj = options.target;
      const gridSize = 20;
      obj.set({
        left: snapToGrid(obj.left, gridSize),
        top: snapToGrid(obj.top, gridSize)
      });
      obj.setCoords();
    });

    canvas.on('object:scaling', function (options) {
      const obj = options.target;
      const gridSize = 20;

      if (obj.type === 'line') {
        const newX2 = snapToGrid(obj.x2 * obj.scaleX, gridSize);
        const newY2 = snapToGrid(obj.y2 * obj.scaleY, gridSize);
        obj.set({
          x2: newX2,
          y2: newY2,
          scaleX: 1,
          scaleY: 1
        });

        if (obj.properties) {
          const length = Math.sqrt(Math.pow(newX2 - obj.x1, 2) + Math.pow(newY2 - obj.y1, 2));
          obj.properties.length = length;
        }
      } else if (obj.type === 'image') {
        const minSize = 10;
        const newWidth = Math.max(snapToGrid(obj.width * obj.scaleX, gridSize), minSize);
        const newHeight = Math.max(snapToGrid(obj.height * obj.scaleY, gridSize), minSize);

        obj.set({
          scaleX: newWidth / obj.width,
          scaleY: newHeight / obj.height
        });

        if (obj.properties) {
          obj.properties.width = newWidth;
          obj.properties.height = newHeight;
        }
      }
      obj.setCoords();
    });
  }

  // ==================== –ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò ====================
  function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function (event) {
      // ESC - –æ—Ç–º–µ–Ω–∞
      if (event.key === 'Escape') {
        deactivateAllModes();
        hideContextMenu();
      }

      // Delete - —É–¥–∞–ª–µ–Ω–∏–µ
      if (event.key === 'Delete' || event.key === 'Backspace') {
        const activeObject = canvas.getActiveObject();
        if (activeObject) {
          saveToUndoStack();
          canvas.remove(activeObject);
          updatePropertiesPanel();
          updateStatus();
          showNotification('–û–±—ä–µ–∫—Ç —É–¥–∞–ª–µ–Ω', 'info');
        }
      }

      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∫–∞
      if (event.ctrlKey || event.metaKey) {
        if (event.key === 's') {
          event.preventDefault();
          saveDrawing();
        }
        if (event.key === 'o') {
          event.preventDefault();
          loadDrawing();
        }
        if (event.key === 'z') {
          event.preventDefault();
          if (event.shiftKey) {
            redoAction();
          } else {
            undoAction();
          }
        }
        if (event.key === 'y') {
          event.preventDefault();
          redoAction();
        }
        if (event.shiftKey && event.key === 'S') {
          event.preventDefault();
          splitLinesAtIntersections();
        }
        if (event.key === 'g') {
          event.preventDefault();
          if (event.shiftKey) {
            ungroupObjects();
          } else {
            groupObjects();
          }
        }
      }

      // –ë—ã—Å—Ç—Ä—ã–µ –∫–ª–∞–≤–∏—à–∏
      if (!event.ctrlKey && !event.metaKey) {
        switch (event.key.toLowerCase()) {
          case 'l':
            event.preventDefault();
            activateLineDrawing();
            break;
          case 'i':
            event.preventDefault();
            findIntersectionsOnly();
            break;
          case 'n':
            event.preventDefault();
            showAddImageModal();
            break;
          case 'g':
            event.preventDefault();
            toggleGrid();
            break;
          case 'c':
            if (event.shiftKey) {
              event.preventDefault();
              toggleContinuousMode();
            }
            break;
          case 'a':
            event.preventDefault();
            toggleAutoSplitMode();
            break;
          case 'o':
            event.preventDefault();
            splitLinesAtSelectedImage();
            break;
          case 'p':
            event.preventDefault();
            showAllIntersectionPoints();
            break;
        }
      }

      // –¶–∏—Ñ—Ä—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (1-6)
      if (event.key >= '1' && event.key <= '6') {
        const index = parseInt(event.key) - 1;
        if (index < allImages.length) {
          activateImagePlacementMode(allImages[index].id);
        }
      }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.addEventListener('click', hideContextMenu);
  }

  // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ú–û–î–ê–õ–¨–ù–´–• –û–ö–û–ù ====================
  function initializeModals() {
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
    const dropArea = document.getElementById('dropArea');
    const fileInput = document.getElementById('fileInput');

    if (dropArea && fileInput) {
      dropArea.addEventListener('click', () => fileInput.click());

      dropArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropArea.classList.add('drag-over');
      });

      dropArea.addEventListener('dragleave', () => {
        dropArea.classList.remove('drag-over');
      });

      dropArea.addEventListener('drop', (e) => {
        e.preventDefault();
        dropArea.classList.remove('drag-over');

        if (e.dataTransfer.files.length) {
          fileInput.files = e.dataTransfer.files;
          handleFileUpload(fileInput.files[0]);
        }
      });

      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
          handleFileUpload(e.target.files[0]);
        }
      });
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    const importDropArea = document.querySelector('#importExportTab div[style*="dashed"]');
    const importFileInput = document.getElementById('importFileInput');

    if (importDropArea && importFileInput) {
      importDropArea.addEventListener('click', () => importFileInput.click());

      importFileInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
          importCustomImages(e.target.files[0]);
        }
      });
    }

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º
    document.getElementById('linePropertiesForm')?.addEventListener('submit', function (e) {
      e.preventDefault();
      applyLineProperties();
    });

    document.getElementById('imagePropertiesForm')?.addEventListener('submit', function (e) {
      e.preventDefault();
      applyImageProperties();
    });

    document.getElementById('addImageForm')?.addEventListener('submit', function (e) {
      e.preventDefault();
      addNewImage();
    });
  }

  // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
  function snapToGrid(value, gridSize = 20) {
    return Math.round(value / gridSize) * gridSize;
  }

  function deactivateAllModes() {
    if (isDrawingLine) {
      isDrawingLine = false;
      document.getElementById('lineDrawingBtn').classList.remove('active-mode');
      if (previewLine) {
        canvas.remove(previewLine);
        previewLine = null;
      }
      lineStartPoint = null;
      lastLineEndPoint = null;
    }

    if (currentImageData) {
      document.querySelectorAll('.image-item').forEach(btn => btn.classList.remove('active-mode'));
      currentImageData = null;
    }

    canvas.defaultCursor = 'default';
    canvas.selection = true;
    canvas.forEachObject(obj => {
      if (obj.id !== 'grid-group') {
        obj.selectable = true;
      }
    });

    updateStatus();
  }

  function updateStatus(x, y) {
    const count = canvas.getObjects().filter(obj =>
      obj.id !== 'grid-group' && obj.id !== 'grid-line'
    ).length;

    let statusText = `<strong>–û–±—ä–µ–∫—Ç–æ–≤:</strong> ${count}`;

    if (x !== undefined && y !== undefined) {
      statusText += ` | <strong>–ö—É—Ä—Å–æ—Ä:</strong> ${Math.round(x)}, ${Math.round(y)}px`;
    }

    const activeObj = canvas.getActiveObject();
    if (activeObj) {
      statusText += ` | <strong>–í—ã–±—Ä–∞–Ω:</strong> ${activeObj.type}`;
      if (activeObj.type === 'line') {
        const length = Math.sqrt(
          Math.pow(activeObj.x2 - activeObj.x1, 2) +
          Math.pow(activeObj.y2 - activeObj.y1, 2)
        );
        statusText += ` (${Math.round(length)}px)`;
      } else if (activeObj.type === 'image') {
        const props = activeObj.properties || {};
        statusText += ` (${props.name || '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'})`;
      }
    }

    if (isContinuousLineMode) {
      statusText += ' | üîó <strong>–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π —Ä–µ–∂–∏–º</strong>';
    }

    if (autoSplitMode) {
      statusText += ' | ‚ö° <strong>–ê–≤—Ç–æ—Ä–∞–∑–±–∏–≤–∫–∞</strong>';
    }

    document.getElementById('status').innerHTML = statusText;
  }

  // ==================== –°–í–û–ô–°–¢–í–ê –û–ë–™–ï–ö–¢–û–í ====================
  function updatePropertiesPanel() {
    const activeObj = canvas.getActiveObject();
    const propsContent = document.getElementById('props-content');

    if (!activeObj) {
      propsContent.innerHTML = `
        <p style="color: #7f8c8d; font-style: italic; text-align: center; padding: 20px;">
          –í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç –Ω–∞ —á–µ—Ä—Ç–µ–∂–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤
        </p>
      `;
      return;
    }

    let content = `
      <div class="property-group">
        <h4>üìÑ –û—Å–Ω–æ–≤–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞</h4>
        <div class="property-row">
          <div class="property-label">–¢–∏–ø:</div>
          <div class="property-value"><strong>${activeObj.type}</strong></div>
        </div>
        <div class="property-row">
          <div class="property-label">–ü–æ–∑–∏—Ü–∏—è X:</div>
          <div class="property-value">${Math.round(activeObj.left || activeObj.x1 || 0)}px</div>
        </div>
        <div class="property-row">
          <div class="property-label">–ü–æ–∑–∏—Ü–∏—è Y:</div>
          <div class="property-value">${Math.round(activeObj.top || activeObj.y1 || 0)}px</div>
        </div>
    `;

    if (activeObj.type === 'line') {
      const length = Math.sqrt(
        Math.pow(activeObj.x2 - activeObj.x1, 2) +
        Math.pow(activeObj.y2 - activeObj.y1, 2)
      );
      content += `
        <div class="property-row">
          <div class="property-label">–î–ª–∏–Ω–∞:</div>
          <div class="property-value">${Math.round(length)}px</div>
        </div>
      `;

      if (activeObj.properties) {
        content += `
          <div class="property-group" style="border-left-color: #2a9d8f;">
            <h4>üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h4>
            <div class="property-row">
              <div class="property-label">–ù–∞–∑–≤–∞–Ω–∏–µ:</div>
              <div class="property-value">${activeObj.properties.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
            </div>
            <div class="property-row">
              <div class="property-label">L (–º¬≤):</div>
              <div class="property-value">${(activeObj.properties.L || 0).toFixed(4)}</div>
            </div>
            <div class="property-row">
              <div class="property-label">I:</div>
              <div class="property-value">${(activeObj.properties.I || 0).toFixed(6)}</div>
            </div>
            <div class="property-row">
              <div class="property-label">K (–º):</div>
              <div class="property-value">${(activeObj.properties.K || 0).toFixed(3)}</div>
            </div>
            <div class="property-row">
              <div class="property-label">W (–∫–≥/–º):</div>
              <div class="property-value">${(activeObj.properties.W || 0).toFixed(2)}</div>
            </div>
        `;

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
        if (activeObj.properties.connectsToImage) {
          const conn = activeObj.properties.connectsToImage;
          content += `
            <div class="property-row">
              <div class="property-label">–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ:</div>
              <div class="property-value">${conn.imageName || '–û–±—ä–µ–∫—Ç'}</div>
            </div>
            <div class="property-row">
              <div class="property-label">–ü–æ–¥—Ö–æ–¥–∏—Ç:</div>
              <div class="property-value">${conn.approachingFrom === 'start' ? '–ù–∞—á–∞–ª–æ–º' : '–ö–æ–Ω—Ü–æ–º'}</div>
            </div>
            <div class="property-row">
              <div class="property-label">–°—Ç–æ—Ä–æ–Ω–∞:</div>
              <div class="property-value">${getSideName(conn.side)}</div>
            </div>
          `;
        }

        content += `</div>`;
      }

      content += `
        <div style="margin-top: 15px; text-align: center;">
          <button onclick="showLinePropertiesModal()" style="padding: 8px 16px; font-size: 13px;">
            ‚öôÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
          </button>
        </div>
      `;
    } else if (activeObj.type === 'image') {
      const props = activeObj.properties || {};
      const width = Math.round(activeObj.width * activeObj.scaleX);
      const height = Math.round(activeObj.height * activeObj.scaleY);

      content += `
        <div class="property-row">
          <div class="property-label">–®–∏—Ä–∏–Ω–∞:</div>
          <div class="property-value">${width}px</div>
        </div>
        <div class="property-row">
          <div class="property-label">–í—ã—Å–æ—Ç–∞:</div>
          <div class="property-value">${height}px</div>
        </div>
      `;

      if (props.name || props.type) {
        content += `
          <div class="property-group" style="border-left-color: #e74c3c;">
            <h4>üö™ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—ä–µ–∫—Ç–∞</h4>
            <div class="property-row">
              <div class="property-label">–ù–∞–∑–≤–∞–Ω–∏–µ:</div>
              <div class="property-value">${props.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
            </div>
            <div class="property-row">
              <div class="property-label">–¢–∏–ø:</div>
              <div class="property-value">${props.type || 'default'}</div>
            </div>
        `;

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞
        if (props.type === 'fan' && (props.airQuantity || props.airResistance)) {
          content += `
            <div class="property-row">
              <div class="property-label">–ö–æ–ª-–≤–æ –≤–æ–∑–¥—É—Ö–∞:</div>
              <div class="property-value">${(props.airQuantity || 0).toFixed(1)} –º¬≥/—á</div>
            </div>
            <div class="property-row">
              <div class="property-label">–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ:</div>
              <div class="property-value">${(props.airResistance || 0).toFixed(1)} –ü–∞</div>
            </div>
          `;
        } else if (props.type === 'fire' && (props.temperature || props.coverage)) {
          content += `
            <div class="property-row">
              <div class="property-label">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞:</div>
              <div class="property-value">${props.temperature || 0} ¬∞C</div>
            </div>
            <div class="property-row">
              <div class="property-label">–ó–æ–Ω–∞ –ø–æ–∫—Ä—ã—Ç–∏—è:</div>
              <div class="property-value">${props.coverage || 0} –º¬≤</div>
            </div>
          `;
        }

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞
        if (props) {
          Object.keys(props).forEach(key => {
            if (!['name', 'type', 'imageId', 'imagePath', 'width', 'height', 'description', 'airQuantity', 'airResistance', 'temperature', 'coverage'].includes(key)) {
              content += `
                <div class="property-row">
                  <div class="property-label">${key}:</div>
                  <div class="property-value">${props[key]}</div>
                </div>
              `;
            }
          });
        }

        content += `</div>`;
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ª–∏–Ω–∏–∏, —Å–æ–µ–¥–∏–Ω–µ–Ω–Ω—ã–µ —Å —ç—Ç–∏–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
      const connectedLines = canvas.getObjects().filter(obj =>
        obj.type === 'line' &&
        obj.properties &&
        obj.properties.connectsToImage &&
        obj.properties.connectsToImage.imageId === props.imageId
      );

      if (connectedLines.length > 0) {
        content += `
          <div class="property-group" style="border-left-color: #3498db;">
            <h4>üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ –ª–∏–Ω–∏–∏</h4>
            <div class="property-row">
              <div class="property-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</div>
              <div class="property-value">${connectedLines.length} —à—Ç.</div>
            </div>
        `;

        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Å—Ç–æ—Ä–æ–Ω–∞–º
        const sides = {};
        connectedLines.forEach(line => {
          const side = line.properties.connectsToImage.side || 'unknown';
          if (!sides[side]) sides[side] = 0;
          sides[side]++;
        });

        Object.keys(sides).forEach(side => {
          content += `
            <div class="property-row">
              <div class="property-label">${getSideName(side)}:</div>
              <div class="property-value">${sides[side]} –ª–∏–Ω–∏–∏</div>
            </div>
          `;
        });

        content += `</div>`;
      }

      content += `
        <div style="margin-top: 15px; text-align: center;">
          <button onclick="showImagePropertiesModal()" style="padding: 8px 16px; font-size: 13px;">
            üñºÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
          </button>
          <button onclick="splitLinesAtSelectedImage()" style="padding: 8px 16px; font-size: 13px; margin-left: 10px;">
            ‚úÇÔ∏è –†–∞–∑–±–∏—Ç—å –ª–∏–Ω–∏–∏
          </button>
        </div>
      `;
    }

    content += `</div>`;
    propsContent.innerHTML = content;
  }

  function getSideName(side) {
    const sideNames = {
      'top': '–í–µ—Ä—Ö',
      'right': '–ü—Ä–∞–≤–æ',
      'bottom': '–ù–∏–∑',
      'left': '–õ–µ–≤–æ',
      'unknown': '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
    };
    return sideNames[side] || side;
  }

  // ==================== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –°–í–û–ô–°–¢–í –õ–ò–ù–ò–ò ====================
  function showLinePropertiesModal() {
    const activeObject = canvas.getActiveObject();
    if (!activeObject || activeObject.type !== 'line') {
      showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ª–∏–Ω–∏—é –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!', 'error');
      return;
    }

    currentEditingLine = activeObject;
    const props = activeObject.properties || {
      name: '–õ–∏–Ω–∏—è',
      L: 0.5,
      I: 0.015,
      K: 10,
      W: 1.0
    };

    document.getElementById('propertyName').value = props.name;
    document.getElementById('propertyColor').value = activeObject.stroke || '#2a9d8f';
    document.getElementById('propertyWidth').value = activeObject.strokeWidth || 2;

    const isDashed = activeObject.strokeDashArray?.length > 0;
    const isDotted = isDashed && activeObject.strokeDashArray[0] === 2;
    document.getElementById('propertyLineType').value = isDotted ? 'dotted' : (isDashed ? 'dashed' : 'solid');

    document.getElementById('propertyL').value = props.L;
    document.getElementById('propertyI').value = props.I;
    document.getElementById('propertyK').value = props.K;
    document.getElementById('propertyW').value = props.W;

    document.getElementById('linePropertiesModal').style.display = 'flex';
  }

  function closeLinePropertiesModal() {
    document.getElementById('linePropertiesModal').style.display = 'none';
    currentEditingLine = null;
  }

  function applyLineProperties() {
    if (!currentEditingLine) return;

    const newProperties = {
      name: document.getElementById('propertyName').value,
      L: parseFloat(document.getElementById('propertyL').value),
      I: parseFloat(document.getElementById('propertyI').value),
      K: parseFloat(document.getElementById('propertyK').value),
      W: parseFloat(document.getElementById('propertyW').value)
    };

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    const oldProps = currentEditingLine.properties || {};
    if (oldProps.connectsToImage) {
      newProperties.connectsToImage = oldProps.connectsToImage;
    }
    if (oldProps.length) {
      newProperties.length = oldProps.length;
    }

    const lineType = document.getElementById('propertyLineType').value;
    let strokeDashArray;
    switch (lineType) {
      case 'dashed':
        strokeDashArray = [5, 5];
        break;
      case 'dotted':
        strokeDashArray = [2, 2];
        break;
      default:
        strokeDashArray = null;
    }

    saveToUndoStack();
    currentEditingLine.set({
      stroke: document.getElementById('propertyColor').value,
      strokeWidth: parseInt(document.getElementById('propertyWidth').value),
      strokeDashArray: strokeDashArray,
      properties: newProperties
    });

    canvas.renderAll();
    updatePropertiesPanel();
    closeLinePropertiesModal();
    showNotification('–°–≤–æ–π—Å—Ç–≤–∞ –ª–∏–Ω–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
  }

  // ==================== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –°–í–û–ô–°–¢–í –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø ====================
  function showImagePropertiesModal() {
    const activeObject = canvas.getActiveObject();
    if (!activeObject || activeObject.type !== 'image') {
      showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!', 'error');
      return;
    }

    currentEditingImage = activeObject;
    const props = activeObject.properties || {
      name: '–û–±—ä–µ–∫—Ç',
      type: 'default'
    };

    document.getElementById('imagePropertyName').value = props.name;
    document.getElementById('imageType').value = props.type || 'default';
    document.getElementById('imageWidth').value = Math.round(props.width || activeObject.width * activeObject.scaleX);
    document.getElementById('imageHeight').value = Math.round(props.height || activeObject.height * activeObject.scaleY);
    document.getElementById('imageRotation').value = Math.round(activeObject.angle || 0);

    const opacity = activeObject.opacity !== undefined ? activeObject.opacity : 1;
    document.getElementById('imageOpacity').value = opacity;
    document.getElementById('opacityValue').textContent = Math.round(opacity * 100) + '%';

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞
    if (props.type === 'fan') {
      document.getElementById('imageAirQuantity').value = props.airQuantity || '';
      document.getElementById('imageAirResistance').value = props.airResistance || '';
    } else if (props.type === 'fire') {
      document.getElementById('fireTemperature').value = props.temperature || '';
      document.getElementById('fireCoverage').value = props.coverage || '';
    }

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞
    const container = document.getElementById('customPropertiesContainer');
    container.innerHTML = '';

    if (props) {
      Object.entries(props).forEach(([key, value]) => {
        if (!['name', 'type', 'imageId', 'imagePath', 'width', 'height', 'description', 'airQuantity', 'airResistance', 'temperature', 'coverage'].includes(key)) {
          const fieldDiv = document.createElement('div');
          fieldDiv.className = 'form-row';
          fieldDiv.style.marginBottom = '10px';
          fieldDiv.innerHTML = `
            <input type="text" class="custom-prop-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞" value="${key}" style="flex: 1;">
            <input type="text" class="custom-prop-value" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ" value="${value}" style="flex: 1;">
            <button type="button" onclick="this.parentElement.remove()" style="padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">
              ‚úï
            </button>
          `;
          container.appendChild(fieldDiv);
        }
      });
    }

    updateImageTypeFields();
    document.getElementById('imagePropertiesModal').style.display = 'flex';
    switchImageTab('basic');
  }

  function switchImageTab(tabName) {
    document.querySelectorAll('#imagePropertiesModal .tab-content').forEach(tab => {
      tab.classList.remove('active');
    });

    document.getElementById('imageTab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('active');

    document.querySelectorAll('#imagePropertiesModal .tab-button').forEach(btn => {
      btn.classList.remove('active');
    });
    event.target.classList.add('active');
  }

  function updateImageTypeFields() {
    const type = document.getElementById('imageType').value;

    document.getElementById('fanProperties').style.display = 'none';
    document.getElementById('fireProperties').style.display = 'none';
    document.getElementById('valveProperties').style.display = 'none';

    if (type === 'fan') {
      document.getElementById('fanProperties').style.display = 'block';
    } else if (type === 'fire') {
      document.getElementById('fireProperties').style.display = 'block';
    } else if (type === 'valve') {
      document.getElementById('valveProperties').style.display = 'block';
    }
  }

  function closeImagePropertiesModal() {
    document.getElementById('imagePropertiesModal').style.display = 'none';
    currentEditingImage = null;
  }

  function applyImageProperties() {
    if (!currentEditingImage) return;

    const newProperties = {
      name: document.getElementById('imagePropertyName').value,
      type: document.getElementById('imageType').value,
      width: parseInt(document.getElementById('imageWidth').value),
      height: parseInt(document.getElementById('imageHeight').value)
    };

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞
    const type = newProperties.type;
    if (type === 'fan') {
      newProperties.airQuantity = parseFloat(document.getElementById('imageAirQuantity').value) || 0;
      newProperties.airResistance = parseFloat(document.getElementById('imageAirResistance').value) || 0;
    } else if (type === 'fire') {
      newProperties.temperature = parseInt(document.getElementById('fireTemperature').value) || 0;
      newProperties.coverage = parseInt(document.getElementById('fireCoverage').value) || 0;
    } else if (type === 'valve') {
      newProperties.diameter = parseInt(document.getElementById('valveDiameter').value) || 0;
      newProperties.actuator = document.getElementById('valveActuator').value;
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞
    const propNames = document.querySelectorAll('#customPropertiesContainer .custom-prop-name');
    const propValues = document.querySelectorAll('#customPropertiesContainer .custom-prop-value');

    for (let i = 0; i < propNames.length; i++) {
      if (propNames[i].value.trim() && propValues[i].value.trim()) {
        newProperties[propNames[i].value.trim()] = propValues[i].value.trim();
      }
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –¥–æ–ª–∂–Ω—ã –∏–∑–º–µ–Ω—è—Ç—å—Å—è
    const oldProps = currentEditingImage.properties || {};
    newProperties.imageId = oldProps.imageId;
    newProperties.imagePath = oldProps.imagePath;
    newProperties.description = oldProps.description;

    saveToUndoStack();
    currentEditingImage.set({
      scaleX: newProperties.width / currentEditingImage.width,
      scaleY: newProperties.height / currentEditingImage.height,
      angle: parseInt(document.getElementById('imageRotation').value) || 0,
      opacity: parseFloat(document.getElementById('imageOpacity').value),
      properties: newProperties
    });

    canvas.renderAll();
    updatePropertiesPanel();
    closeImagePropertiesModal();
    showNotification('–°–≤–æ–π—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
  }

  // ==================== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–û–ë–ê–í–õ–ï–ù–ò–Ø –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø ====================
  function showAddImageModal() {
    document.getElementById('addImageModal').style.display = 'flex';
    document.getElementById('previewContainer').style.display = 'none';
    document.getElementById('addImageCustomProps').style.display = 'none';
    document.getElementById('addImageForm').reset();
    switchAddImageTab('upload');

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const grid = document.getElementById('standardImagesGrid');
    if (grid) {
      grid.innerHTML = '';
      defaultImages.forEach(img => {
        const item = document.createElement('div');
        item.className = 'image-item';
        item.innerHTML = `
          <img src="${img.path}" alt="${img.name}" onerror="this.src='https://via.placeholder.com/40?text=Error'">
          <div class="image-item-name">${img.name}</div>
        `;
        item.onclick = () => {
          document.getElementById('newImageUrl').value = img.path;
          document.getElementById('newImageName').value = img.name;
          document.getElementById('newImageType').value = img.type;
          document.getElementById('newImageIcon').value = img.icon;
        };
        grid.appendChild(item);
      });
    }
  }

  function closeAddImageModal() {
    document.getElementById('addImageModal').style.display = 'none';
  }

  function switchAddImageTab(tabName) {
    // 1. –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
    document.querySelectorAll('#addImageModal .tab-content').forEach(tab => {
      tab.classList.remove('active');
    });

    // 2. –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
    document.getElementById(tabName + 'Tab').classList.add('active');

    // 3. –û–±–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
    document.querySelectorAll('#addImageModal .tab-button').forEach(btn => {
      btn.classList.remove('active');
    });
    event.target.classList.add('active');

    // 4. –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —É–ø—Ä–∞–≤–ª—è—Ç—å –∞—Ç—Ä–∏–±—É—Ç–æ–º required
    const urlInput = document.getElementById('newImageUrl');
    const fileInput = document.getElementById('fileInput');

    if (tabName === 'upload') {
      // –í–∫–ª–∞–¥–∫–∞ "–ó–∞–≥—Ä—É–∑–∏—Ç—å": URL –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
      urlInput.removeAttribute('required');
    } else if (tabName === 'url') {
      // –í–∫–ª–∞–¥–∫–∞ "URL": URL –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
      urlInput.setAttribute('required', true);
    } else {
      // –í–∫–ª–∞–¥–∫–∞ "–ì–∞–ª–µ—Ä–µ—è": –Ω–∏—á–µ–≥–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
      urlInput.removeAttribute('required');
    }
  }

  function handleFileUpload(file) {
    if (!file.type.match('image.*')) {
      showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è!', 'error');
      return;
    }

    if (file.size > 2 * 1024 * 1024) {
      showNotification('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 2MB', 'error');
      return;
    }

    const reader = new FileReader();
    reader.onload = function (e) {
      const preview = document.getElementById('imagePreview');
      preview.src = e.target.result;
      document.getElementById('previewContainer').style.display = 'block';

      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
      const name = file.name.replace(/\.[^/.]+$/, ""); // –£–±–∏—Ä–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
      document.getElementById('newImageName').value = name;

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞
      document.getElementById('addImageCustomProps').style.display = 'block';
    };

    reader.readAsDataURL(file);
  }

  function addNewImage() {
    const name = document.getElementById('newImageName').value.trim();
    const type = document.getElementById('newImageType').value;
    const icon = document.getElementById('newImageIcon').value || 'üñºÔ∏è';
    const description = document.getElementById('newImageDescription').value.trim();

    let imageUrl = document.getElementById('newImageUrl').value.trim();

    // –ï—Å–ª–∏ —Ñ–∞–π–ª –±—ã–ª –∑–∞–≥—Ä—É–∂–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
    const fileInput = document.getElementById('fileInput');
    if (fileInput.files.length) {
      const reader = new FileReader();
      reader.onload = function (e) {
        createImageObject(name, type, icon, description, e.target.result);
      };
      reader.readAsDataURL(fileInput.files[0]);
    } else if (imageUrl) {
      createImageObject(name, type, icon, description, imageUrl);
    } else {
      showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ URL!', 'error');
      return;
    }
  }

  function createImageObject(name, type, icon, description, imageUrl) {
    // –°–æ–±–∏—Ä–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞
    const customProps = {};
    const propNames = document.querySelectorAll('#addImageCustomPropsContainer .custom-prop-name');
    const propValues = document.querySelectorAll('#addImageCustomPropsContainer .custom-prop-value');

    for (let i = 0; i < propNames.length; i++) {
      if (propNames[i].value.trim() && propValues[i].value.trim()) {
        customProps[propNames[i].value.trim()] = propValues[i].value.trim();
      }
    }

    const newImage = {
      id: 'custom_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
      name: name,
      icon: icon,
      path: imageUrl,
      type: type,
      description: description,
      properties: customProps
    };

    customImages.push(newImage);
    saveCustomImages();
    allImages = [...defaultImages, ...customImages];
    updateImageTools();

    closeAddImageModal();
    showNotification(`–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ "${name}" —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ!`, 'success');

    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    setTimeout(() => {
      activateImagePlacementMode(newImage.id);
    }, 300);
  }

  function addCustomPropertyField(context = 'addImage') {
    const containerId = context === 'addImage' ? 'addImageCustomPropsContainer' : 'customPropertiesContainer';
    const container = document.getElementById(containerId);

    const fieldDiv = document.createElement('div');
    fieldDiv.className = 'form-row';
    fieldDiv.style.marginBottom = '10px';
    fieldDiv.innerHTML = `
      <input type="text" class="custom-prop-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞" style="flex: 1;">
      <input type="text" class="custom-prop-value" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ" style="flex: 1;">
      <button type="button" onclick="this.parentElement.remove()" style="padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">
        ‚úï
      </button>
    `;

    container.appendChild(fieldDiv);
  }

  function editCustomImage(imageId) {
    const image = customImages.find(img => img.id === imageId);
    if (!image) return;

    showAddImageModal();

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    setTimeout(() => {
      document.getElementById('newImageName').value = image.name;
      document.getElementById('newImageIcon').value = image.icon;
      document.getElementById('newImageType').value = image.type;
      document.getElementById('newImageDescription').value = image.description || '';
      document.getElementById('newImageUrl').value = image.path;

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞
      document.getElementById('addImageCustomProps').style.display = 'block';
      const container = document.getElementById('addImageCustomPropsContainer');
      container.innerHTML = '';

      if (image.properties) {
        Object.entries(image.properties).forEach(([key, value]) => {
          const fieldDiv = document.createElement('div');
          fieldDiv.className = 'form-row';
          fieldDiv.style.marginBottom = '10px';
          fieldDiv.innerHTML = `
            <input type="text" class="custom-prop-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞" value="${key}" style="flex: 1;">
            <input type="text" class="custom-prop-value" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ" value="${value}" style="flex: 1;">
            <button type="button" onclick="this.parentElement.remove()" style="padding: 5px 10px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer;">
              ‚úï
            </button>
          `;
          container.appendChild(fieldDiv);
        });
      }
    }, 100);

    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    deleteCustomImage(imageId, false);
  }

  function deleteCustomImage(imageId, showNotification = true) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ?')) return;

    customImages = customImages.filter(img => img.id !== imageId);
    saveCustomImages();
    allImages = [...defaultImages, ...customImages];
    updateImageTools();

    if (showNotification) {
      showNotification('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
    }
  }

  // ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–û–î–ê–õ–¨–ù–´–ú–ò –û–ö–ù–ê–ú–ò ====================
  function showManageImagesModal() {
    document.getElementById('manageImagesModal').style.display = 'flex';
    switchManageTab('custom');
  }

  function closeManageImagesModal() {
    document.getElementById('manageImagesModal').style.display = 'none';
  }

  function switchManageTab(tabName) {
    document.querySelectorAll('#manageImagesModal .tab-content').forEach(tab => {
      tab.classList.remove('active');
    });

    document.getElementById(tabName + 'ImagesTab').classList.add('active');

    document.querySelectorAll('#manageImagesModal .tab-button').forEach(btn => {
      btn.classList.remove('active');
    });
    event.target.classList.add('active');

    if (tabName === 'custom') {
      updateCustomImagesList();
    } else if (tabName === 'default') {
      updateDefaultImagesList();
    }
  }

  function updateCustomImagesList() {
    const list = document.getElementById('customImagesList');
    list.innerHTML = '';

    customImages.forEach(image => {
      const item = document.createElement('div');
      item.className = 'image-item';
      item.innerHTML = `
        <div style="font-size: 30px; margin-bottom: 5px;">${image.icon}</div>
        <div class="image-item-name">${image.name}</div>
        <div class="image-item-type">${image.type}</div>
        <div class="custom-image-actions" style="margin-top: 10px;">
          <button class="edit-btn" onclick="editCustomImage('${image.id}'); event.stopPropagation();">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          <button class="delete-btn" onclick="deleteCustomImage('${image.id}'); event.stopPropagation(); closeManageImagesModal();">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
        </div>
      `;
      list.appendChild(item);
    });

    document.getElementById('customImagesCount').textContent = customImages.length;
  }

  function updateDefaultImagesList() {
    const list = document.getElementById('defaultImagesList');
    list.innerHTML = '';

    defaultImages.forEach(image => {
      const item = document.createElement('div');
      item.className = 'image-item';
      item.innerHTML = `
        <img src="${image.path}" alt="${image.name}" onerror="this.src='https://via.placeholder.com/40?text=Error'">
        <div class="image-item-name">${image.name}</div>
        <div class="image-item-type">${image.type}</div>
      `;
      list.appendChild(item);
    });
  }

  // ==================== –ò–ú–ü–û–†–¢/–≠–ö–°–ü–û–†–¢ ====================
  function exportCustomImages() {
    const dataStr = JSON.stringify(customImages, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);

    const exportFileDefaultName = `–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è-—á–µ—Ä—Ç–µ–∂–µ–π-${new Date().toISOString().slice(0, 10)}.json`;

    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();

    showNotification('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!', 'success');
  }

  function importCustomImages(file) {
    const reader = new FileReader();
    reader.onload = function (e) {
      try {
        const importedImages = JSON.parse(e.target.result);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö
        if (!Array.isArray(importedImages)) {
          throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        importedImages.forEach(img => {
          if (img.id && img.name && img.path) {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π ID –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
            img.id = 'imported_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            customImages.push(img);
          }
        });

        saveCustomImages();
        allImages = [...defaultImages, ...customImages];
        updateImageTools();
        updateCustomImagesList();

        showNotification(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${importedImages.length} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π`, 'success');
      } catch (error) {
        showNotification('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ —Ñ–∞–π–ª–∞: ' + error.message, 'error');
      }
    };

    reader.readAsText(file);
  }

  function clearAllCustomImages() {
    if (!confirm('–í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –≤–∞—à–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è. –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å! –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
      return;
    }

    customImages = [];
    saveCustomImages();
    allImages = [...defaultImages];
    updateImageTools();
    updateCustomImagesList();

    showNotification('–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω—ã', 'success');
  }

  // ==================== –°–û–•–†–ê–ù–ï–ù–ò–ï –ò –ó–ê–ì–†–£–ó–ö–ê –ß–ï–†–¢–ï–ñ–ê ====================
  function saveDrawing() {
    const json = JSON.stringify(canvas.toJSON(['id', 'properties']));
    localStorage.setItem('fabricDrawing', json);

    const blob = new Blob([json], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `—á–µ—Ä—Ç–µ–∂-${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    const count = canvas.getObjects().filter(obj => obj.id !== 'grid-group' && obj.id !== 'grid-line').length;
    showNotification(`–ß–µ—Ä—Ç–µ–∂ —Å–æ—Ö—Ä–∞–Ω–µ–Ω! (${count} –æ–±—ä–µ–∫—Ç–æ–≤)`, 'success');
  }

  function loadDrawing() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';

    input.onchange = function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (event) {
        try {
          const json = event.target.result;
          deactivateAllModes();
          canvas.clear();
          drawGrid(20);

          canvas.loadFromJSON(json, function () {
            const lines = canvas.getObjects().filter(obj =>
              obj.type === 'line' && obj.id !== 'grid-line'
            );

            if (lines.length > 0) {
              const lastLine = lines[lines.length - 1];
              lastLineEndPoint = {x: lastLine.x2, y: lastLine.y2};
            }

            canvas.renderAll();
            updatePropertiesPanel();
            updateStatus();

            const count = canvas.getObjects().filter(obj => obj.id !== 'grid-group' && obj.id !== 'grid-line').length;
            showNotification(`–ß–µ—Ä—Ç–µ–∂ –∑–∞–≥—Ä—É–∂–µ–Ω! (${count} –æ–±—ä–µ–∫—Ç–æ–≤)`, 'success');
          });
        } catch (error) {
          showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + error.message, 'error');
        }
      };
      reader.readAsText(file);
    };

    input.click();
  }

  // ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –û–ë–™–ï–ö–¢–ê–ú–ò ====================
  function clearCanvas() {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã —Å —á–µ—Ä—Ç–µ–∂–∞?')) return;

    deactivateAllModes();
    lastLineEndPoint = null;

    canvas.getObjects().forEach(obj => {
      if (obj.id !== 'grid-group' && obj.id !== 'grid-line') {
        canvas.remove(obj);
      }
    });

    canvas.renderAll();
    updatePropertiesPanel();
    updateStatus();
    showNotification('–•–æ–ª—Å—Ç –æ—á–∏—â–µ–Ω', 'info');
  }

  function groupObjects() {
    const activeObjects = canvas.getActiveObjects();
    if (activeObjects.length < 2) {
      showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã 2 –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏', 'error');
      return;
    }

    saveToUndoStack();
    const group = new fabric.Group(activeObjects);
    canvas.remove(...activeObjects);
    canvas.add(group);
    canvas.setActiveObject(group);
    canvas.renderAll();

    showNotification(`–û–±—ä–µ–∫—Ç—ã —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω—ã (${activeObjects.length} —à—Ç.)`, 'success');
  }

  function ungroupObjects() {
    const activeObject = canvas.getActiveObject();
    if (!activeObject || activeObject.type !== 'group') {
      showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É –¥–ª—è —Ä–∞–∑–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏', 'error');
      return;
    }

    saveToUndoStack();
    const objects = activeObject.getObjects();
    activeObject.toActiveSelection();
    canvas.remove(activeObject);

    objects.forEach(obj => {
      canvas.add(obj);
    });

    const selection = new fabric.ActiveSelection(objects, {canvas: canvas});
    canvas.setActiveObject(selection);
    canvas.renderAll();

    showNotification('–ì—Ä—É–ø–ø–∞ —Ä–∞–∑–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–∞', 'success');
  }

  // ==================== –ö–û–ù–¢–ï–ö–°–¢–ù–û–ï –ú–ï–ù–Æ ====================
  function showContextMenu(x, y) {
    const contextMenu = document.getElementById('contextMenu');
    const activeObject = canvas.getActiveObject();

    if (!activeObject) return;

    contextMenu.style.display = 'block';
    contextMenu.style.left = x + 'px';
    contextMenu.style.top = y + 'px';
    contextMenuVisible = true;

    // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –º–µ–Ω—é, —á—Ç–æ–±—ã –æ–Ω–æ –Ω–µ –≤—ã—Ö–æ–¥–∏–ª–æ –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã –æ–∫–Ω–∞
    const rect = contextMenu.getBoundingClientRect();
    if (x + rect.width > window.innerWidth) {
      contextMenu.style.left = (x - rect.width) + 'px';
    }
    if (y + rect.height > window.innerHeight) {
      contextMenu.style.top = (y - rect.height) + 'px';
    }
  }

  function hideContextMenu() {
    if (!contextMenuVisible) return;

    const contextMenu = document.getElementById('contextMenu');
    contextMenu.style.display = 'none';
    contextMenuVisible = false;
  }

  function copyObject() {
    const activeObject = canvas.getActiveObject();
    if (activeObject) {
      copiedObject = activeObject.toJSON();
      showNotification('–û–±—ä–µ–∫—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω', 'success');
      hideContextMenu();
    }
  }

  function pasteObject() {
    if (!copiedObject) {
      showNotification('–ù–µ—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞', 'error');
      return;
    }

    fabric.util.enlivenObjects([copiedObject], function (objects) {
      objects.forEach(obj => {
        obj.left += 20;
        obj.top += 20;
        canvas.add(obj);
      });
      canvas.renderAll();
      showNotification('–û–±—ä–µ–∫—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω', 'success');
    });

    hideContextMenu();
  }

  function duplicateObject() {
    const activeObject = canvas.getActiveObject();
    if (!activeObject) {
      showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç –¥–ª—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è', 'error');
      return;
    }

    saveToUndoStack();
    activeObject.clone(function (clone) {
      clone.left += 20;
      clone.top += 20;
      canvas.add(clone);
      canvas.setActiveObject(clone);
      canvas.renderAll();
      showNotification('–û–±—ä–µ–∫—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω', 'success');
    });

    hideContextMenu();
  }

  function bringObjectToFront() {
    const activeObject = canvas.getActiveObject();
    if (!activeObject) return;

    saveToUndoStack();
    activeObject.bringToFront();
    canvas.renderAll();
    showNotification('–û–±—ä–µ–∫—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω –Ω–∞ –ø–µ—Ä–µ–¥–Ω–∏–π –ø–ª–∞–Ω', 'success');
    hideContextMenu();
  }

  function sendObjectToBack() {
    const activeObject = canvas.getActiveObject();
    if (!activeObject) return;

    saveToUndoStack();
    activeObject.sendToBack();
    canvas.renderAll();
    showNotification('–û–±—ä–µ–∫—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω –Ω–∞ –∑–∞–¥–Ω–∏–π –ø–ª–∞–Ω', 'success');
    hideContextMenu();
  }

  function deleteObject() {
    const activeObject = canvas.getActiveObject();
    if (!activeObject) return;

    saveToUndoStack();
    canvas.remove(activeObject);
    canvas.renderAll();
    updatePropertiesPanel();
    updateStatus();
    showNotification('–û–±—ä–µ–∫—Ç —É–¥–∞–ª–µ–Ω', 'info');
    hideContextMenu();
  }

  // ==================== –û–¢–ú–ï–ù–ê/–ü–û–í–¢–û–† ====================
  function saveToUndoStack() {
    const json = JSON.stringify(canvas.toJSON(['id', 'properties']));
    undoStack.push(json);
    redoStack = [];

    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä —Å—Ç–µ–∫–∞
    if (undoStack.length > 50) {
      undoStack.shift();
    }

    updateUndoRedoButtons();
  }

  function undoAction() {
    if (undoStack.length < 2) return;

    const currentState = undoStack.pop();
    redoStack.push(currentState);

    const previousState = undoStack[undoStack.length - 1];
    canvas.loadFromJSON(previousState, function () {
      canvas.renderAll();
      updatePropertiesPanel();
      updateStatus();
    });

    updateUndoRedoButtons();
    showNotification('–î–µ–π—Å—Ç–≤–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ', 'info');
  }

  function redoAction() {
    if (redoStack.length === 0) return;

    const nextState = redoStack.pop();
    undoStack.push(nextState);

    canvas.loadFromJSON(nextState, function () {
      canvas.renderAll();
      updatePropertiesPanel();
      updateStatus();
    });

    updateUndoRedoButtons();
    showNotification('–î–µ–π—Å—Ç–≤–∏–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–æ', 'info');
  }

  function updateUndoRedoButtons() {
    const undoBtn = document.getElementById('undoBtn');
    if (undoBtn) {
      undoBtn.disabled = undoStack.length < 2;
    }
  }

  // ==================== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ====================
  function showNotification(message, type = 'info') {
    const container = document.getElementById('notificationContainer');
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;

    container.appendChild(notification);

    setTimeout(() => {
      notification.remove();
    }, 3000);
  }

  // ==================== –≠–ö–°–ü–û–†–¢ –í –ö–û–ù–°–û–õ–¨ ====================
  function exportToConsole() {
    const objects = canvas.getObjects().filter(obj => obj.id !== 'grid-group' && obj.id !== 'grid-line');
    const exportData = {
      timestamp: new Date().toISOString(),
      totalObjects: objects.length,
      objects: []
    };

    objects.forEach((obj, index) => {
      const objData = {
        id: index + 1,
        type: obj.type,
        position: {
          x: obj.left || obj.x1,
          y: obj.top || obj.y1
        },
        properties: obj.properties || {}
      };

      if (obj.type === 'line') {
        objData.dimensions = {
          x1: obj.x1,
          y1: obj.y1,
          x2: obj.x2,
          y2: obj.y2,
          length: Math.sqrt(Math.pow(obj.x2 - obj.x1, 2) + Math.pow(obj.y2 - obj.y1, 2))
        };

        if (obj.properties && obj.properties.connectsToImage) {
          objData.connection = obj.properties.connectsToImage;
        }
      } else if (obj.type === 'image') {
        objData.dimensions = {
          width: obj.width * obj.scaleX,
          height: obj.height * obj.scaleY,
          scaleX: obj.scaleX,
          scaleY: obj.scaleY
        };
      }

      exportData.objects.push(objData);
    });

    console.log('üìä –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä—Ç–µ–∂–∞:', exportData);
    console.table(exportData.objects.map(obj => ({
      'ID': obj.id,
      '–¢–∏–ø': obj.type,
      '–ü–æ–¥—Ç–∏–ø': obj.properties.type || '–ù–µ—Ç',
      'X': Math.round(obj.position.x),
      'Y': Math.round(obj.position.y),
      '–ù–∞–∑–≤–∞–Ω–∏–µ': obj.properties.name || '–ù–µ—Ç',
      '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ': obj.connection ? `–ö ${obj.connection.imageName}` : '–ù–µ—Ç'
    })));

    showNotification(`–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ –∫–æ–Ω—Å–æ–ª—å (${objects.length} –æ–±—ä–µ–∫—Ç–æ–≤)`, 'success');
  }

  // ==================== –ü–†–ï–î–û–¢–í–†–ê–©–ï–ù–ò–ï –ö–û–ù–¢–ï–ö–°–¢–ù–û–ì–û –ú–ï–ù–Æ –ë–†–ê–£–ó–ï–†–ê ====================
  document.getElementById('fabric-canvas').addEventListener('contextmenu', function (e) {
    e.preventDefault();
  });
</script>
</body>
</html>