<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–†–µ–¥–∞–∫—Ç–æ—Ä —á–µ—Ä—Ç–µ–∂–µ–π —Å —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º —Å–≤–æ–π—Å—Ç–≤ (Fabric.js)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0 5px 5px 5px;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .container {
      background: white;
      border-radius: 15px;
      padding: 0;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      max-width: 1800px;
      margin: 0 auto;
    }

    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 10px;
      font-size: 32px;
      font-weight: 700;
    }

    .subtitle {
      color: #7f8c8d;
      text-align: center;
      margin-bottom: 30px;
      font-size: 16px;
    }

    .main-content {
      display: flex;
      gap: 25px;
      margin-top: 20px;
    }

    .left-panel {
      flex: 1;
      max-width: 320px;
    }

    .canvas-container {
      flex: 2;
      min-height: 600px;
    }

    #canvas-container {
      border: 2px solid #ddd;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      background: #fff;
      width: 100%;
      height: 600px;
    }

    #tools {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-bottom: 15px;
      background: #f8f9fa;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #e9ecef;
    }

    button {
      padding: 6px 8px;
      border: none;
      border-radius: 6px;
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 3px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
    }

    button:active {
      transform: translateY(0);
    }

    .active-mode {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    #status {
      background: #2c3e50;
      color: white;
      padding: 10px 15px;
      border-radius: 8px;
      margin-top: 15px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .properties-panel {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      max-height: 400px;
      overflow-y: auto;
    }

    .properties-panel h3 {
      color: #2c3e50;
      margin-top: 0;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid #f0f0f0;
      font-size: 18px;
    }

    .property-group {
      margin-bottom: 15px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #6a11cb;
    }

    .property-group h4 {
      color: #34495e;
      margin-top: 0;
      margin-bottom: 12px;
      font-size: 15px;
    }

    .property-row {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .property-label {
      flex: 1;
      color: #555;
      font-size: 13px;
      font-weight: 500;
    }

    .property-value {
      flex: 1;
    }

    input[type="number"],
    input[type="text"],
    input[type="color"],
    select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      transition: border 0.3s;
      box-sizing: border-box;
    }

    input[type="number"]:focus,
    input[type="text"]:focus,
    input[type="color"]:focus,
    select:focus {
      outline: none;
      border-color: #6a11cb;
      box-shadow: 0 0 0 2px rgba(106, 17, 203, 0.2);
    }

    /* –ü–∞–Ω–µ–ª—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
    .image-panel {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      max-height: 300px;
      overflow-y: auto;
    }

    .image-panel h3 {
      color: #2c3e50;
      margin-top: 0;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid #f0f0f0;
      font-size: 18px;
    }

    .image-buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    .image-button {
      padding: 5px;
      border: 2px solid transparent;
      border-radius: 6px;
      background: #f8f9fa;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60px;
    }

    .image-button:hover {
      border-color: #6a11cb;
      background: #eef2ff;
      transform: translateY(-2px);
    }

    .image-button.active {
      border-color: #11998e;
      background: #e6fff9;
      box-shadow: 0 4px 6px rgba(17, 153, 142, 0.2);
    }

    .image-button img {
      width: 30px;
      height: 30px;
      object-fit: contain;
      margin-bottom: 5px;
    }

    .image-button span {
      font-size: 10px;
      color: #555;
      text-align: center;
      word-break: break-word;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      padding: 25px;
      border-radius: 15px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      animation: modalSlideIn 0.3s ease;
      max-height: 80vh;
      overflow-y: auto;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #f0f0f0;
    }

    .modal-title {
      font-size: 20px;
      color: #2c3e50;
      font-weight: 600;
      margin: 0;
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 22px;
      color: #7f8c8d;
      cursor: pointer;
      padding: 5px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s;
    }

    .close-modal:hover {
      background: #f5f5f5;
      color: #e74c3c;
    }

    .modal-form {
      display: grid;
      gap: 12px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-label {
      color: #34495e;
      font-weight: 600;
      font-size: 13px;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      justify-content: flex-end;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 13px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: white;
    }

    .btn-secondary {
      background: #95a5a6;
      color: white;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1);
    }

    .instructions {
      background: #e8f4fc;
      border-left: 4px solid #3498db;
      padding: 12px;
      border-radius: 8px;
      margin-top: 15px;
      font-size: 12px;
    }

    .instructions h4 {
      color: #2c3e50;
      margin-top: 0;
      font-size: 14px;
    }

    .instructions ul {
      margin: 8px 0;
      padding-left: 18px;
      color: #555;
    }

    .instructions li {
      margin-bottom: 4px;
      line-height: 1.4;
    }

    .object-props-panel {
      margin-top: 15px;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>üìê –†–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —á–µ—Ä—Ç–µ–∂–µ–π</h1>
  <p class="subtitle">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ —á–µ—Ä—Ç–µ–∂–∏ —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ —Å–µ—Ç–∫–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Å–≤–æ–π—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–æ–≤ –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤ JSON</p>

  <div class="main-content">
    <div class="left-panel">
      <!-- –ü–∞–Ω–µ–ª—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
      <div class="image-panel">
        <h3>üìÅ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤</h3>
        <div class="image-buttons" id="image-buttons">
          <!-- –ö–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã —Å–∫—Ä–∏–ø—Ç–æ–º -->
        </div>
      </div>

      <div id="tools">
        <button onclick="activateLineDrawing()" id="lineDrawingBtn">
          <span>üìè</span> –õ–∏–Ω–∏—è
        </button>
        <button onclick="splitLinesAtIntersections()">
          <span>‚úÇÔ∏è</span> –†–∞–∑–±–∏—Ç—å –ª–∏–Ω–∏–∏
        </button>
        <button onclick="findIntersectionsOnly()">
          <span>üîç</span> –ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è
        </button>
        <button onclick="clearIntersectionPoints()">
          <span>üßπ</span> –û—á–∏—Å—Ç–∏—Ç—å
        </button>
        <button onclick="activateFreehandDrawing()" id="freehandBtn">
          <span>‚úèÔ∏è</span> –†–∏—Å–æ–≤–∞–Ω–∏–µ
        </button>
        <button onclick="addRectangle()">
          <span>‚¨ú</span> –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫
        </button>
        <button onclick="addCircle()">
          <span>‚≠ï</span> –ö—Ä—É–≥
        </button>
        <button onclick="toggleContinuousMode()" id="continuousModeBtn">
          <span>üîó</span> –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π
        </button>
        <button onclick="showLinePropertiesModal()">
          <span>‚öôÔ∏è</span> –°–≤–æ–π—Å—Ç–≤–∞ –ª–∏–Ω–∏–∏
        </button>
        <button onclick="saveDrawing()">
          <span>üíæ</span> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        </button>
        <button onclick="loadDrawing()">
          <span>üìÇ</span> –ó–∞–≥—Ä—É–∑–∏—Ç—å
        </button>
        <button onclick="clearCanvas()">
          <span>üóëÔ∏è</span> –û—á–∏—Å—Ç–∏—Ç—å
        </button>
        <button onclick="exportToConsole()">
          <span>üìä</span> –≠–∫—Å–ø–æ—Ä—Ç
        </button>
      </div>

      <div class="properties-panel">
        <h3>–°–≤–æ–π—Å—Ç–≤–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞</h3>
        <div id="props-content">
          <p style="color: #7f8c8d; font-style: italic; text-align: center; padding: 20px;">
            –í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç –Ω–∞ —á–µ—Ä—Ç–µ–∂–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤
          </p>
        </div>
      </div>

      <div id="status">
        –ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ. –û–±—ä–µ–∫—Ç–æ–≤ –Ω–∞ —á–µ—Ä—Ç–µ–∂–µ: 0
      </div>

      <div class="instructions">
        <h4>üìã –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏:</h4>
        <ul>
          <li><strong>ESC</strong> - –æ—Ç–º–µ–Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è</li>
          <li><strong>Delete</strong> - —É–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç</li>
          <li><strong>Ctrl+S</strong> - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä—Ç–µ–∂</li>
          <li><strong>Ctrl+O</strong> - –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–µ—Ä—Ç–µ–∂</li>
          <li><strong>Ctrl+Z</strong> - –æ—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ</li>
          <li><strong>Alt + –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ</strong> - –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Ö–æ–ª—Å—Ç–∞</li>
          <li><strong>I</strong> - –Ω–∞–π—Ç–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è</li>
          <li><strong>Ctrl+Shift+S</strong> - —Ä–∞–∑–±–∏—Ç—å –ª–∏–Ω–∏–∏</li>
        </ul>
      </div>
    </div>

    <div class="canvas-container">
      <div id="canvas-container">
        <canvas id="fabric-canvas" width="1200" height="600"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤ –ª–∏–Ω–∏–∏ -->
<div id="linePropertiesModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">‚öôÔ∏è –°–≤–æ–π—Å—Ç–≤–∞ –ª–∏–Ω–∏–∏</h2>
      <button class="close-modal" onclick="closeLinePropertiesModal()">√ó</button>
    </div>
    <form id="linePropertiesForm" class="modal-form">
      <div class="form-group">
        <label class="form-label">1. –î–ª–∏–Ω–∞ (L, –º¬≤):</label>
        <input type="number" id="propertyL" step="0.001" min="0" placeholder="0.5237" required>
      </div>
      <div class="form-group">
        <label class="form-label">2. –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (I):</label>
        <input type="number" id="propertyI" step="0.000001" min="0" placeholder="0.015327" required>
      </div>
      <div class="form-group">
        <label class="form-label">3. –ü–∞—Ä–∞–º–µ—Ç—Ä (K, –º):</label>
        <input type="number" id="propertyK" step="0.001" min="0" placeholder="10.235" required>
      </div>
      <div class="form-group">
        <label class="form-label">4. –í–µ—Å (W, –∫–≥/–º):</label>
        <input type="number" id="propertyW" step="0.01" min="0" placeholder="1.0" required>
      </div>
      <div class="form-group">
        <label class="form-label">5. –ù–∞–∑–≤–∞–Ω–∏–µ –ª–∏–Ω–∏–∏:</label>
        <input type="text" id="propertyName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ì–ª–∞–≤–Ω–∞—è –±–∞–ª–∫–∞" required>
      </div>
      <div class="form-group">
        <label class="form-label">–¶–≤–µ—Ç –ª–∏–Ω–∏–∏:</label>
        <input type="color" id="propertyColor" value="#2a9d8f">
      </div>
      <div class="form-group">
        <label class="form-label">–¢–æ–ª—â–∏–Ω–∞ –ª–∏–Ω–∏–∏:</label>
        <select id="propertyWidth">
          <option value="1">1 px</option>
          <option value="2" selected>2 px</option>
          <option value="3">3 px</option>
          <option value="4">4 px</option>
          <option value="5">5 px</option>
        </select>
      </div>
      <div class="modal-buttons">
        <button type="button" class="btn btn-secondary" onclick="closeLinePropertiesModal()">
          –û—Ç–º–µ–Ω–∞
        </button>
        <button type="submit" class="btn btn-primary">
          –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–≤–æ–π—Å—Ç–≤–∞
        </button>
      </div>
    </form>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
<div id="imagePropertiesModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">üñºÔ∏è –°–≤–æ–π—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–∞</h2>
      <button class="close-modal" onclick="closeImagePropertiesModal()">√ó</button>
    </div>
    <form id="imagePropertiesForm" class="modal-form">
      <div class="form-group">
        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞:</label>
        <input type="text" id="imgPropertyName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö—Ä–µ–ø–ª–µ–Ω–∏–µ" required>
      </div>
      <div class="form-group">
        <label class="form-label">–ü–∞—Ä–∞–º–µ—Ç—Ä A:</label>
        <input type="number" id="imgPropertyA" step="0.001" placeholder="0" required>
      </div>
      <div class="form-group">
        <label class="form-label">–ü–∞—Ä–∞–º–µ—Ç—Ä B:</label>
        <input type="number" id="imgPropertyB" step="0.001" placeholder="0" required>
      </div>
      <div class="form-group">
        <label class="form-label">–ü–∞—Ä–∞–º–µ—Ç—Ä C:</label>
        <input type="number" id="imgPropertyC" step="0.001" placeholder="0" required>
      </div>
      <div class="form-group">
        <label class="form-label">–ü–∞—Ä–∞–º–µ—Ç—Ä D:</label>
        <input type="number" id="imgPropertyD" step="0.001" placeholder="0" required>
      </div>
      <div class="form-group">
        <label class="form-label">–ü–∞—Ä–∞–º–µ—Ç—Ä E:</label>
        <input type="number" id="imgPropertyE" step="0.001" placeholder="0" required>
      </div>
      <div class="form-group">
        <label class="form-label">–ü–∞—Ä–∞–º–µ—Ç—Ä F:</label>
        <input type="number" id="imgPropertyF" step="0.001" placeholder="0" required>
      </div>
      <div class="form-group">
        <label class="form-label">–ú–∞—Å—à—Ç–∞–±:</label>
        <select id="imgPropertyScale">
          <option value="0.5">50%</option>
          <option value="0.75">75%</option>
          <option value="1" selected>100%</option>
          <option value="1.25">125%</option>
          <option value="1.5">150%</option>
        </select>
      </div>
      <div class="modal-buttons">
        <button type="button" class="btn btn-secondary" onclick="closeImagePropertiesModal()">
          –û—Ç–º–µ–Ω–∞
        </button>
        <button type="submit" class="btn btn-primary">
          –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–≤–æ–π—Å—Ç–≤–∞
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  // 1. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –•–û–õ–°–¢–ê
  const canvas = new fabric.Canvas('fabric-canvas', {
    backgroundColor: '#f8f9fa',
    preserveObjectStacking: true,
    selection: true,
    selectionColor: 'rgba(79, 195, 247, 0.3)',
    selectionBorderColor: '#4fc3f7',
    selectionLineWidth: 2
  });

  // 2. –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
  let isDrawingLine = false;
  let isDrawingFreehand = false;
  let isContinuousLineMode = false;
  let lineStartPoint = null;
  let previewLine = null;
  let freehandPath = null;
  let isDragging = false;
  let lastPosX, lastPosY;
  let lastLineEndPoint = null;
  const SNAP_RADIUS = 15;
  let currentEditingLine = null;
  let currentEditingImage = null;

  // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
  let selectedImageType = null;
  let isAddingImage = false;

  // –ú–∞—Å—Å–∏–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ (20 —à—Ç—É–∫)
  const imageData = [
    { id: 1, name: '–ë–æ–ª—Ç', url: './img/dvercloses.png' },
    { id: 2, name: '–ì–∞–π–∫–∞', url: './img/dveropenmetall.png' },
    { id: 3, name: '–®–∞–π–±–∞', url: './img/dverventrech.png' },
    { id: 4, name: '–®–ø–∏–ª—å–∫–∞', url: './img/dverwentoknowood.png' },
    { id: 5, name: '–í–∏–Ω—Ç', url: './img/fan.png' },
    { id: 6, name: '–®–ø–æ–Ω–∫–∞', url: './img/fan2.png' },
    { id: 7, name: '–ü–æ–¥—à–∏–ø–Ω–∏–∫', url: './img/fire.png' },
    { id: 8, name: '–í—Ç—É–ª–∫–∞', url: './img/massovievzivniepaboti.png' },
    { id: 9, name: '–®–∫–∏–≤', url: './img/medpunkt.png' },
    { id: 10, name: '–ó—É–±—á–∞—Ç–æ–µ –∫–æ–ª–µ—Å–æ', url: './img/nadshahtnoe.png' },
    { id: 11, name: '–ü—Ä—É–∂–∏–Ω–∞', url: './img/nanospogruznoi.png' },
    { id: 12, name: '–ö–ª–∞–ø–∞–Ω', url: './img/nasosnayastancia.png' },
    { id: 13, name: '–§–ª–∞–Ω–µ—Ü', url: './img/people.png' },
    { id: 14, name: '–ú—É—Ñ—Ç–∞', url: './img/petemichkabeton.png' },
    { id: 15, name: '–û–ø–æ—Ä–∞', url: './img/petemichkakirpich.png' },
    { id: 16, name: '–ö—Ä–æ–Ω—à—Ç–µ–π–Ω', url: './img/petemichkametall.png' },
    { id: 17, name: '–ö—Ä–µ—Å—Ç–æ–≤–∏–Ω–∞', url: './img/petemichkawood.png' },
    { id: 18, name: '–°–∞–ª—å–Ω–∏–∫', url: './img/phone.png' },
    { id: 19, name: '–ü—Ä–æ–∫–ª–∞–¥–∫–∞', url: './img/pozarniigidrant.png' },
    { id: 20, name: '–ó–∞–≥–ª—É—à–∫–∞', url: './img/prohod.png' },
    { id: 21, name: '–û–ø–æ—Ä–∞', url: './img/samohodnoe.png' },
    { id: 22, name: '–ö—Ä–æ–Ω—à—Ç–µ–π–Ω', url: './img/scladprotivopozar.png' },
    { id: 23, name: '–ö—Ä–µ—Å—Ç–æ–≤–∏–Ω–∞', url: './img/separation.webp' },
    { id: 24, name: '–°–∞–ª—å–Ω–∏–∫', url: './img/vzrivnieraboti.png' },
    { id: 25, name: '–ü—Ä–æ–∫–ª–∞–¥–∫–∞', url: './img/zapasvhod.png' },
  ];

  // 3. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ù–û–ü–û–ö –° –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø–ú–ò
  function initializeImageButtons() {
    const container = document.getElementById('image-buttons');

    imageData.forEach((img, index) => {
      const button = document.createElement('div');
      button.className = 'image-button';
      button.id = `image-btn-${img.id}`;
      button.innerHTML = `
        <img src="${img.url}" alt="${img.name}">
        <span>${img.name}</span>
      `;

      button.onclick = () => selectImageType(img.id, img.url, img.name);
      container.appendChild(button);
    });
  }

  // 4. –í–´–ë–û–† –¢–ò–ü–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø
  function selectImageType(id, url, name) {
    // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
    document.querySelectorAll('.image-button').forEach(btn => {
      btn.classList.remove('active');
    });

    // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É
    const selectedBtn = document.getElementById(`image-btn-${id}`);
    selectedBtn.classList.add('active');

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    selectedImageType = { id, url, name };
    isAddingImage = true;

    // –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –¥—Ä—É–≥–∏–µ —Ä–µ–∂–∏–º—ã
    deactivateAllModes();

    document.getElementById('status').innerHTML =
      `–†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞: <strong>${name}</strong>. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ —Ö–æ–ª—Å—Ç –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è.`;
  }

  // 5. –î–û–ë–ê–í–õ–ï–ù–ò–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø –ù–ê –•–û–õ–°–¢
  function addImageToCanvas(x, y) {
    if (!selectedImageType) return;

    fabric.Image.fromURL(selectedImageType.url, function(img) {
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–≤–æ–π—Å—Ç–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      img.set({
        left: x,
        top: y,
        originX: 'center',
        originY: 'center',
        scaleX: 0.5,
        scaleY: 0.5,
        hasControls: true,
        hasBorders: true,
        selectable: true,
        imageType: selectedImageType.id,
        imageName: selectedImageType.name,
        imageUrl: selectedImageType.url,
        // 6 —Å–≤–æ–π—Å—Ç–≤ –æ–±—ä–µ–∫—Ç–∞
        properties: {
          name: selectedImageType.name,
          paramA: 0,
          paramB: 0,
          paramC: 0,
          paramD: 0,
          paramE: 0,
          paramF: 0,
          scale: 1
        }
      });

      canvas.add(img);
      canvas.setActiveObject(img);
      updatePropertiesPanel();
      updateStatus();

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–æ–ø–∞–ª –ª–∏ –æ–±—ä–µ–∫—Ç –Ω–∞ –ª–∏–Ω–∏—é
      checkAndSplitLineAtPoint(img, x, y);
    });
  }

  // 6. –ü–†–û–í–ï–†–ö–ê –ò –†–ê–ó–ë–ò–ï–ù–ò–ï –õ–ò–ù–ò–ò –í –¢–û–ß–ö–ï
  function checkAndSplitLineAtPoint(imageObj, x, y) {
    const lines = canvas.getObjects().filter(obj =>
      obj.type === 'line' && obj.id !== 'grid-line' && obj !== previewLine
    );

    let lineToSplit = null;
    let splitPoint = null;
    let minDistance = Infinity;

    // –ò—â–µ–º –±–ª–∏–∂–∞–π—à—É—é –ª–∏–Ω–∏—é –∫ —Ç–æ—á–∫–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    lines.forEach(line => {
      const pointOnLine = getClosestPointOnLine(line, x, y);
      const distance = Math.sqrt(Math.pow(pointOnLine.x - x, 2) + Math.pow(pointOnLine.y - y, 2));

      if (distance < 20 && distance < minDistance) {
        minDistance = distance;
        lineToSplit = line;
        splitPoint = pointOnLine;
      }
    });

    // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –ª–∏–Ω–∏—é –¥–ª—è —Ä–∞–∑–±–∏–µ–Ω–∏—è
    if (lineToSplit && splitPoint) {
      splitLineAtPoint(lineToSplit, splitPoint, imageObj);

      // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ—á–Ω–æ –≤ —Ç–æ—á–∫—É —Ä–∞–∑–±–∏–µ–Ω–∏—è
      imageObj.set({
        left: splitPoint.x,
        top: splitPoint.y
      });
      canvas.renderAll();
    }
  }

  // 7. –§–£–ù–ö–¶–ò–Ø –†–ê–ó–ë–ò–ï–ù–ò–Ø –õ–ò–ù–ò–ò –í –¢–û–ß–ö–ï
  function splitLineAtPoint(line, point, imageObj) {
    const length1 = Math.sqrt(Math.pow(point.x - line.x1, 2) + Math.pow(point.y - line.y1, 2));
    const length2 = Math.sqrt(Math.pow(line.x2 - point.x, 2) + Math.pow(line.y2 - point.y, 2));
    const totalLength = length1 + length2;
    const ratio1 = length1 / totalLength;
    const ratio2 = length2 / totalLength;

    // –°–æ–∑–¥–∞–µ–º –¥–≤–µ –Ω–æ–≤—ã–µ –ª–∏–Ω–∏–∏
    const line1 = new fabric.Line([line.x1, line.y1, point.x, point.y], {
      stroke: line.stroke,
      strokeWidth: line.strokeWidth,
      strokeDashArray: line.strokeDashArray,
      hasControls: true,
      hasBorders: true,
      lockRotation: false,
      properties: line.properties ? {
        name: line.properties.name + ' (—á–∞—Å—Ç—å 1)',
        L: line.properties.L * ratio1,
        I: line.properties.I * ratio1,
        K: line.properties.K * ratio1,
        W: line.properties.W * ratio1,
        length: length1
      } : null
    });

    const line2 = new fabric.Line([point.x, point.y, line.x2, line.y2], {
      stroke: line.stroke,
      strokeWidth: line.strokeWidth,
      strokeDashArray: line.strokeDashArray,
      hasControls: true,
      hasBorders: true,
      lockRotation: false,
      properties: line.properties ? {
        name: line.properties.name + ' (—á–∞—Å—Ç—å 2)',
        L: line.properties.L * ratio2,
        I: line.properties.I * ratio2,
        K: line.properties.K * ratio2,
        W: line.properties.W * ratio2,
        length: length2
      } : null
    });

    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –ª–∏–Ω–∏—é –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
    canvas.remove(line);
    canvas.add(line1);
    canvas.add(line2);

    // –°–≤—è–∑—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –ª–∏–Ω–∏—è–º–∏ (–¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
    if (imageObj) {
      imageObj.connectedLines = [line1, line2];
    }

    document.getElementById('status').innerHTML +=
      ` | –õ–∏–Ω–∏—è —Ä–∞–∑–±–∏—Ç–∞ –Ω–∞ 2 —á–∞—Å—Ç–∏ (${Math.round(length1)}px + ${Math.round(length2)}px)`;
  }

  // 8. –§–£–ù–ö–¶–ò–Ø –ü–û–ò–°–ö–ê –ë–õ–ò–ñ–ê–ô–®–ï–ô –¢–û–ß–ö–ò –ù–ê –õ–ò–ù–ò–ò
  function getClosestPointOnLine(line, x, y) {
    const A = x - line.x1;
    const B = y - line.y1;
    const C = line.x2 - line.x1;
    const D = line.y2 - line.y1;

    const dot = A * C + B * D;
    const lenSq = C * C + D * D;
    let param = -1;

    if (lenSq !== 0) {
      param = dot / lenSq;
    }

    let xx, yy;

    if (param < 0) {
      xx = line.x1;
      yy = line.y1;
    } else if (param > 1) {
      xx = line.x2;
      yy = line.y2;
    } else {
      xx = line.x1 + param * C;
      yy = line.y1 + param * D;
    }

    return { x: xx, y: yy };
  }

  // 9. –û–¢–†–ò–°–û–í–ö–ê –°–ï–¢–ö–ò
  function drawGrid(gridSize = 20) {
    const width = canvas.width, height = canvas.height;
    const gridLines = [];

    for (let x = 0; x <= width; x += gridSize) {
      gridLines.push(new fabric.Line([x, 0, x, height], {
        stroke: 'rgba(224, 224, 224, 0.7)',
        strokeWidth: 1,
        selectable: false,
        evented: false,
        id: 'grid-line'
      }));
    }

    for (let y = 0; y <= height; y += gridSize) {
      gridLines.push(new fabric.Line([0, y, width, y], {
        stroke: 'rgba(224, 224, 224, 0.7)',
        strokeWidth: 1,
        selectable: false,
        evented: false,
        id: 'grid-line'
      }));
    }

    const gridGroup = new fabric.Group(gridLines, {
      selectable: false,
      evented: false,
      hoverCursor: 'default',
      id: 'grid-group'
    });
    canvas.add(gridGroup);
    canvas.sendToBack(gridGroup);
  }
  drawGrid(20);

  // 10. –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ü–ï–†–ï–°–ï–ß–ï–ù–ò–Ø–ú–ò –õ–ò–ù–ò–ô
  function lineIntersection(line1, line2) {
    const x1 = line1.x1, y1 = line1.y1;
    const x2 = line1.x2, y2 = line1.y2;
    const x3 = line2.x1, y3 = line2.y1;
    const x4 = line2.x2, y4 = line2.y2;

    if (line1 === line2) return null;

    const denominator = (y4 - y3) * (x2 - x1) - (x4 - x3) * (y2 - y1);

    if (Math.abs(denominator) < 0.000001) {
      return null;
    }

    const t = ((x4 - x3) * (y1 - y3) - (y4 - y3) * (x1 - x3)) / denominator;
    const u = ((x2 - x1) * (y1 - y3) - (y2 - y1) * (x1 - x3)) / denominator;

    if (t >= 0 && t <= 1 && u >= 0 && u <= 1) {
      const x = x1 + t * (x2 - x1);
      const y = y1 + t * (y2 - y1);

      const epsilon = 0.05;
      if (t < epsilon || t > 1 - epsilon || u < epsilon || u > 1 - epsilon) {
        return null;
      }

      return {
        x: Math.round(x * 100) / 100,
        y: Math.round(y * 100) / 100,
        t: t,
        line1: line1,
        line2: line2
      };
    }

    return null;
  }

  function findAllIntersections() {
    const lines = canvas.getObjects().filter(obj =>
      obj.type === 'line' && obj.id !== 'grid-line' && obj !== previewLine
    );

    const intersections = [];

    for (let i = 0; i < lines.length; i++) {
      for (let j = i + 1; j < lines.length; j++) {
        const intersection = lineIntersection(lines[i], lines[j]);
        if (intersection) {
          intersections.push(intersection);
        }
      }
    }

    return intersections;
  }

  function showIntersectionPoints() {
    clearIntersectionPoints();
    const intersections = findAllIntersections();

    intersections.forEach((inter, index) => {
      const circle = new fabric.Circle({
        left: inter.x - 8,
        top: inter.y - 8,
        radius: 8,
        fill: '#e74c3c',
        stroke: '#c0392b',
        strokeWidth: 2,
        selectable: false,
        hasControls: false,
        hasBorders: false,
        evented: false,
        originX: 'center',
        originY: 'center',
        id: 'intersection-point'
      });

      const text = new fabric.Text((index + 1).toString(), {
        left: inter.x + 12,
        top: inter.y - 12,
        fontSize: 14,
        fill: '#2c3e50',
        fontWeight: 'bold',
        selectable: false,
        evented: false,
        id: 'intersection-point',
        textBackgroundColor: 'rgba(255, 255, 255, 0.8)',
        padding: 3
      });

      canvas.add(circle);
      canvas.add(text);
      canvas.sendToBack(circle);
      canvas.sendToBack(text);
    });

    canvas.renderAll();
    return intersections;
  }

  function splitLinesAtIntersections() {
    console.log("–ù–∞—á–∏–Ω–∞—é –ø–æ–∏—Å–∫ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π –¥–ª—è —Ä–∞–∑–±–∏–µ–Ω–∏—è –ª–∏–Ω–∏–π...");
    const intersections = findAllIntersections();

    if (intersections.length === 0) {
      document.getElementById('status').innerHTML = '–ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.';
      return;
    }

    console.log(`–ù–∞–π–¥–µ–Ω–æ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π: ${intersections.length}`);
    showIntersectionPoints();

    const linesToSplit = new Map();
    intersections.forEach(inter => {
      if (!linesToSplit.has(inter.line1)) {
        linesToSplit.set(inter.line1, []);
      }
      const existingPoint = linesToSplit.get(inter.line1).find(p =>
        Math.abs(p.x - inter.x) < 1 && Math.abs(p.y - inter.y) < 1
      );
      if (!existingPoint) {
        linesToSplit.get(inter.line1).push({x: inter.x, y: inter.y, t: inter.t});
      }

      if (!linesToSplit.has(inter.line2)) {
        linesToSplit.set(inter.line2, []);
      }
      const existingPoint2 = linesToSplit.get(inter.line2).find(p =>
        Math.abs(p.x - inter.x) < 1 && Math.abs(p.y - inter.y) < 1
      );
      if (!existingPoint2) {
        linesToSplit.get(inter.line2).push({x: inter.x, y: inter.y, t: inter.t});
      }
    });

    console.log(`–õ–∏–Ω–∏–π –¥–ª—è —Ä–∞–∑–±–∏–µ–Ω–∏—è: ${linesToSplit.size}`);
    const newLines = [];

    linesToSplit.forEach((points, line) => {
      const startPoint = { x: line.x1, y: line.y1, t: 0 };
      const endPoint = { x: line.x2, y: line.y2, t: 1 };
      const allPoints = [startPoint, ...points, endPoint];
      allPoints.sort((a, b) => a.t - b.t);

      for (let i = 0; i < allPoints.length - 1; i++) {
        const p1 = allPoints[i];
        const p2 = allPoints[i + 1];
        const dx = p2.x - p1.x;
        const dy = p2.y - p1.y;
        const length = Math.sqrt(dx * dx + dy * dy);

        if (length > 2) {
          const totalLength = Math.sqrt(
            Math.pow(line.x2 - line.x1, 2) +
            Math.pow(line.y2 - line.y1, 2)
          );
          const lengthRatio = length / totalLength;

          const segment = new fabric.Line([
            p1.x, p1.y,
            p2.x, p2.y
          ], {
            stroke: line.stroke || '#2a9d8f',
            strokeWidth: line.strokeWidth || 3,
            strokeDashArray: line.strokeDashArray,
            fill: false,
            strokeLineCap: 'round',
            hasControls: true,
            hasBorders: true,
            lockRotation: false,
            selectable: true,
            properties: line.properties ? {
              name: `${line.properties.name || '–õ–∏–Ω–∏—è'} (—Å–µ–≥–º–µ–Ω—Ç ${i+1})`,
              L: line.properties.L ? line.properties.L * lengthRatio : 0.5 * lengthRatio,
              I: line.properties.I ? line.properties.I * lengthRatio : 0.015 * lengthRatio,
              K: line.properties.K ? line.properties.K * lengthRatio : 10 * lengthRatio,
              W: line.properties.W ? line.properties.W * lengthRatio : 1.0 * lengthRatio,
              length: length
            } : {
              name: `–°–µ–≥–º–µ–Ω—Ç ${i+1}`,
              L: 0.5 * lengthRatio,
              I: 0.015 * lengthRatio,
              K: 10 * lengthRatio,
              W: 1.0 * lengthRatio,
              length: length
            }
          });

          newLines.push(segment);
        }
      }
    });

    linesToSplit.forEach((points, line) => {
      canvas.remove(line);
    });

    newLines.forEach(segment => {
      canvas.add(segment);
    });

    clearIntersectionPoints();
    document.getElementById('status').innerHTML =
      `–†–∞–∑–±–∏—Ç–æ ${linesToSplit.size} –ª–∏–Ω–∏–π –Ω–∞ ${newLines.length} —Å–µ–≥–º–µ–Ω—Ç–æ–≤. –ù–∞–π–¥–µ–Ω–æ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π: ${intersections.length}`;

    canvas.renderAll();
    updatePropertiesPanel();
  }

  function clearIntersectionPoints() {
    const objects = canvas.getObjects();
    for (let i = objects.length - 1; i >= 0; i--) {
      if (objects[i].id === 'intersection-point') {
        canvas.remove(objects[i]);
      }
    }
    canvas.renderAll();
  }

  function findIntersectionsOnly() {
    clearIntersectionPoints();
    const intersections = showIntersectionPoints();

    if (intersections.length === 0) {
      document.getElementById('status').innerHTML = '–ü–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.';
    } else {
      document.getElementById('status').innerHTML =
        `–ù–∞–π–¥–µ–Ω–æ ${intersections.length} –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π. –¢–æ—á–∫–∏ –æ—Ç–º–µ—á–µ–Ω—ã –∫—Ä–∞—Å–Ω—ã–º–∏ –∫—Ä—É–≥–∞–º–∏.`;
    }

    return intersections;
  }

  // 11. –§–£–ù–ö–¶–ò–ò –î–û–ë–ê–í–õ–ï–ù–ò–Ø –û–ë–™–ï–ö–¢–û–í
  function addRectangle() {
    const rect = new fabric.Rect({
      left: 100,
      top: 100,
      width: 120,
      height: 40,
      fill: 'rgba(74, 111, 165, 0.7)',
      stroke: '#1d3557',
      strokeWidth: 2,
      rx: 3,
      ry: 3,
      hasControls: true,
      hasBorders: true,
      lockRotation: false
    });
    canvas.add(rect);
    canvas.setActiveObject(rect);
    updatePropertiesPanel();
    updateStatus();
  }

  function addCircle() {
    const circle = new fabric.Circle({
      left: 200,
      top: 200,
      radius: 25,
      fill: 'rgba(230, 57, 70, 0.7)',
      stroke: '#a4131e',
      strokeWidth: 2,
      hasControls: true
    });
    canvas.add(circle);
    canvas.setActiveObject(circle);
    updatePropertiesPanel();
    updateStatus();
  }

  // 12. –ò–ù–°–¢–†–£–ú–ï–ù–¢ –†–ò–°–û–í–ê–ù–ò–Ø –õ–ò–ù–ò–ô
  function activateLineDrawing() {
    deactivateAllModes();
    isDrawingLine = true;
    canvas.defaultCursor = 'crosshair';
    canvas.selection = false;
    canvas.forEachObject(obj => obj.selectable = false);

    document.getElementById('lineDrawingBtn').classList.add('active-mode');

    let modeText = '–†–µ–∂–∏–º —Ä–∏—Å–æ–≤–∞–Ω–∏—è –ª–∏–Ω–∏–∏: –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –Ω–∞—á–∞–ª–∞, –∑–∞—Ç–µ–º –¥–ª—è –∫–æ–Ω—Ü–∞.';
    if (isContinuousLineMode) {
      modeText += ' –†–µ–∂–∏–º –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–≥–æ —Ä–∏—Å–æ–≤–∞–Ω–∏—è –í–ö–õ–Æ–ß–ï–ù.';
    }
    document.getElementById('status').innerHTML = modeText + ' ESC –¥–ª—è –æ—Ç–º–µ–Ω—ã.';
  }

  // 13. –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ù–ï–ü–†–ï–†–´–í–ù–û–ì–û –†–ï–ñ–ò–ú–ê
  function toggleContinuousMode() {
    isContinuousLineMode = !isContinuousLineMode;
    const btn = document.getElementById('continuousModeBtn');
    if (isContinuousLineMode) {
      btn.innerHTML = '<span>üîó</span> –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π (–í–ö–õ)';
      btn.style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
      document.getElementById('status').innerHTML =
        '–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π —Ä–µ–∂–∏–º –í–ö–õ–Æ–ß–ï–ù. –ù–æ–≤—ã–µ –ª–∏–Ω–∏–∏ –±—É–¥—É—Ç –ø—Ä–∏–≤—è–∑—ã–≤–∞—Ç—å—Å—è –∫ –∫–æ–Ω—Ü—É –ø—Ä–µ–¥—ã–¥—É—â–µ–π.';
    } else {
      btn.innerHTML = '<span>üîó</span> –ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π (–í–´–ö–õ)';
      btn.style.background = 'linear-gradient(135deg, #6a11cb 0%, #2575fc 100%)';
      document.getElementById('status').innerHTML =
        '–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π —Ä–µ–∂–∏–º –í–´–ö–õ–Æ–ß–ï–ù.';
    }
  }

  // 14. –ò–ù–°–¢–†–£–ú–ï–ù–¢ –°–í–û–ë–û–î–ù–û–ì–û –†–ò–°–û–í–ê–ù–ò–Ø
  function activateFreehandDrawing() {
    deactivateAllModes();
    isDrawingFreehand = true;
    canvas.defaultCursor = 'crosshair';
    canvas.selection = false;
    canvas.forEachObject(obj => obj.selectable = false);

    document.getElementById('freehandBtn').classList.add('active-mode');
    document.getElementById('status').innerHTML =
      '–†–µ–∂–∏–º —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ —Ä–∏—Å–æ–≤–∞–Ω–∏—è: —É–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –õ–ö–ú –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è. ESC –¥–ª—è –æ—Ç–º–µ–Ω—ã.';
  }

  // 15. –î–ï–ê–ö–¢–ò–í–ê–¶–ò–Ø –í–°–ï–• –†–ï–ñ–ò–ú–û–í
  function deactivateAllModes() {
    if (isDrawingLine) {
      isDrawingLine = false;
      document.getElementById('lineDrawingBtn').classList.remove('active-mode');
      if (previewLine) {
        canvas.remove(previewLine);
        previewLine = null;
      }
      lineStartPoint = null;
    }

    if (isDrawingFreehand) {
      isDrawingFreehand = false;
      document.getElementById('freehandBtn').classList.remove('active-mode');
      if (freehandPath) {
        finalizeFreehandPath();
      }
    }

    if (isAddingImage) {
      isAddingImage = false;
      document.querySelectorAll('.image-button').forEach(btn => {
        btn.classList.remove('active');
      });
      selectedImageType = null;
    }

    canvas.defaultCursor = 'default';
    canvas.selection = true;
    canvas.forEachObject(obj => {
      if (obj.id !== 'grid-group') {
        obj.selectable = true;
      }
    });

    updateStatus();
  }

  // 16. –§–£–ù–ö–¶–ò–ò –ü–†–ò–í–Ø–ó–ö–ò –ö –°–ï–¢–ö–ï
  function snapToGrid(value, gridSize = 20) {
    return Math.round(value / gridSize) * gridSize;
  }

  // 17. –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô –ú–´–®–ò
  canvas.on('mouse:down', function(options) {
    const pointer = canvas.getPointer(options.e);
    const gridSize = 20;

    // –†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    if (isAddingImage && selectedImageType) {
      let snappedX = snapToGrid(pointer.x, gridSize);
      let snappedY = snapToGrid(pointer.y, gridSize);

      addImageToCanvas(snappedX, snappedY);
      return;
    }

    if (isDrawingLine) {
      let snappedX, snappedY;

      if (isContinuousLineMode && lastLineEndPoint) {
        const distanceToLastPoint = Math.sqrt(
          Math.pow(pointer.x - lastLineEndPoint.x, 2) +
          Math.pow(pointer.y - lastLineEndPoint.y, 2)
        );

        if (distanceToLastPoint < SNAP_RADIUS) {
          snappedX = lastLineEndPoint.x;
          snappedY = lastLineEndPoint.y;
        } else {
          snappedX = snapToGrid(pointer.x, gridSize);
          snappedY = snapToGrid(pointer.y, gridSize);
        }
      } else {
        snappedX = snapToGrid(pointer.x, gridSize);
        snappedY = snapToGrid(pointer.y, gridSize);
      }

      if (!lineStartPoint) {
        lineStartPoint = { x: snappedX, y: snappedY };

        previewLine = new fabric.Line([
          lineStartPoint.x, lineStartPoint.y,
          snappedX, snappedY
        ], {
          stroke: '#2a9d8f',
          strokeWidth: 3,
          strokeDashArray: [5, 5],
          selectable: false,
          evented: false
        });
        canvas.add(previewLine);

        document.getElementById('status').innerHTML =
          `–ù–∞—á–∞–ª–æ –ª–∏–Ω–∏–∏: ${lineStartPoint.x},${lineStartPoint.y}px ‚Üí –ø–µ—Ä–µ–º–µ—â–∞–π—Ç–µ –º—ã—à—å. –ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –∫–æ–Ω—Ü–∞.`;
      } else {
        const length = Math.sqrt(
          Math.pow(snappedX - lineStartPoint.x, 2) +
          Math.pow(snappedY - lineStartPoint.y, 2)
        );

        const finalLine = new fabric.Line([
          lineStartPoint.x, lineStartPoint.y,
          snappedX, snappedY
        ], {
          stroke: '#2a9d8f',
          strokeWidth: 3,
          fill: false,
          strokeLineCap: 'round',
          hasControls: true,
          hasBorders: true,
          lockRotation: false,
          properties: {
            name: '–õ–∏–Ω–∏—è ' + (canvas.getObjects().filter(o => o.type === 'line' && o.id !== 'grid-line').length + 1),
            L: 0.5,
            I: 0.015,
            K: 10,
            W: 1.0,
            length: length
          }
        });

        canvas.add(finalLine);
        canvas.setActiveObject(finalLine);
        updatePropertiesPanel();

        lastLineEndPoint = { x: snappedX, y: snappedY };

        if (isContinuousLineMode) {
          lineStartPoint = { x: snappedX, y: snappedY };
          previewLine.set({
            x1: lineStartPoint.x,
            y1: lineStartPoint.y,
            x2: snappedX,
            y2: snappedY
          });

          document.getElementById('status').innerHTML =
            `–õ–∏–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∞. –ù–∞—á–∞–ª–æ –Ω–æ–≤–æ–π –ª–∏–Ω–∏–∏: ${lineStartPoint.x},${lineStartPoint.y}px`;
        } else {
          deactivateAllModes();
        }
      }
      return;
    }

    if (isDrawingFreehand) {
      freehandPath = new fabric.Path(`M ${pointer.x} ${pointer.y}`, {
        stroke: '#333333',
        strokeWidth: 3,
        fill: 'transparent',
        strokeLineCap: 'round',
        strokeLineJoin: 'round',
        selectable: true,
        evented: true,
        properties: {
          name: '–°–≤–æ–±–æ–¥–Ω–∞—è –ª–∏–Ω–∏—è',
          L: 0,
          I: 0,
          K: 0,
          W: 0,
          length: 0
        }
      });

      freehandPath.lastX = pointer.x;
      freehandPath.lastY = pointer.y;
      freehandPath.minDistance = 2;

      canvas.add(freehandPath);
      canvas.setActiveObject(freehandPath);
      return;
    }

    if (options.e.altKey || options.e.spaceKey) {
      isDragging = true;
      lastPosX = pointer.x;
      lastPosY = pointer.y;
      canvas.defaultCursor = 'grabbing';
      return;
    }
  });

  canvas.on('mouse:move', function(options) {
    const pointer = canvas.getPointer(options.e);
    const gridSize = 20;

    let snappedX, snappedY;
    if (isDrawingLine || isAddingImage) {
      snappedX = snapToGrid(pointer.x, gridSize);
      snappedY = snapToGrid(pointer.y, gridSize);
    } else {
      snappedX = pointer.x;
      snappedY = pointer.y;
    }

    updateStatus(snappedX, snappedY, isDrawingLine || isAddingImage);

    if (isDrawingLine && lineStartPoint && previewLine) {
      previewLine.set({ x2: snappedX, y2: snappedY });
      previewLine.setCoords();
      canvas.requestRenderAll();

      const dx = snappedX - lineStartPoint.x;
      const dy = snappedY - lineStartPoint.y;
      const length = Math.sqrt(dx * dx + dy * dy);
      const angle = Math.round(Math.atan2(dy, dx) * 180 / Math.PI);

      let statusAddition = ` | –î–ª–∏–Ω–∞: ${Math.round(length)}px | –£–≥–æ–ª: ${angle}¬∞`;

      if (isContinuousLineMode && lastLineEndPoint) {
        const distanceToLast = Math.sqrt(
          Math.pow(pointer.x - lastLineEndPoint.x, 2) +
          Math.pow(pointer.y - lastLineEndPoint.y, 2)
        );

        if (distanceToLast < SNAP_RADIUS) {
          statusAddition += ' | üìç –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –ª–∏–Ω–∏–∏';
        }
      }

      document.getElementById('status').innerHTML += statusAddition;
    }

    if (isDrawingFreehand && freehandPath && options.e.buttons === 1) {
      const dx = pointer.x - freehandPath.lastX;
      const dy = pointer.y - freehandPath.lastY;
      const distance = Math.sqrt(dx * dx + dy * dy);

      if (distance >= freehandPath.minDistance) {
        freehandPath.path.push(['L', pointer.x, pointer.y]);
        freehandPath.lastX = pointer.x;
        freehandPath.lastY = pointer.y;
        freehandPath.set({ dirty: true });
        canvas.requestRenderAll();

        const pointCount = freehandPath.path.length;
        document.getElementById('status').innerHTML =
          `–°–≤–æ–±–æ–¥–Ω–æ–µ —Ä–∏—Å–æ–≤–∞–Ω–∏–µ. –¢–æ—á–µ–∫: ${pointCount} | X: ${Math.round(pointer.x)}, Y: ${Math.round(pointer.y)}`;
      }
    }

    if (isDragging && (options.e.altKey || options.e.spaceKey)) {
      const deltaX = pointer.x - lastPosX;
      const deltaY = pointer.y - lastPosY;

      canvas.relativePan(new fabric.Point(deltaX, deltaY));
      lastPosX = pointer.x;
      lastPosY = pointer.y;
    }
  });

  canvas.on('mouse:up', function() {
    if (isDragging) {
      isDragging = false;
      canvas.defaultCursor = 'default';
    }

    if (isDrawingFreehand && freehandPath) {
      finalizeFreehandPath();
    }
  });

  // 18. –§–ò–ù–ê–õ–ò–ó–ê–¶–ò–Ø –ü–£–¢–ò
  function finalizeFreehandPath() {
    if (freehandPath && freehandPath.path.length > 2) {
      if (freehandPath.path.length > 10) {
        freehandPath.set({
          path: simplifyPath(freehandPath.path, 2),
          selectable: true,
          hasControls: true,
          hasBorders: true,
          stroke: '#333333',
          strokeWidth: 3,
          fill: 'transparent'
        });
      }

      canvas.setActiveObject(freehandPath);
      updatePropertiesPanel();
      updateStatus();
    } else if (freehandPath) {
      canvas.remove(freehandPath);
      updateStatus();
    }
    freehandPath = null;
  }

  // 19. –ê–õ–ì–û–†–ò–¢–ú –£–ü–†–û–©–ï–ù–ò–Ø –ü–£–¢–ò
  function simplifyPath(path, tolerance = 1.5) {
    if (path.length < 3) return path;

    const points = [];
    for (let i = 0; i < path.length; i++) {
      if (path[i][0] === 'M' || path[i][0] === 'L') {
        points.push({x: path[i][1], y: path[i][2]});
      }
    }

    function douglasPecker(points, tolerance) {
      if (points.length <= 2) return points;

      let maxDistance = 0;
      let index = 0;
      const start = points[0];
      const end = points[points.length - 1];

      for (let i = 1; i < points.length - 1; i++) {
        const distance = perpendicularDistance(points[i], start, end);
        if (distance > maxDistance) {
          index = i;
          maxDistance = distance;
        }
      }

      if (maxDistance > tolerance) {
        const left = douglasPecker(points.slice(0, index + 1), tolerance);
        const right = douglasPecker(points.slice(index), tolerance);
        return left.slice(0, -1).concat(right);
      } else {
        return [start, end];
      }
    }

    function perpendicularDistance(point, lineStart, lineEnd) {
      const area = Math.abs(
        (lineEnd.x - lineStart.x) * (lineStart.y - point.y) -
        (lineStart.x - point.x) * (lineEnd.y - lineStart.y)
      );
      const lineLength = Math.sqrt(
        Math.pow(lineEnd.x - lineStart.x, 2) +
        Math.pow(lineEnd.y - lineStart.y, 2)
      );
      return lineLength > 0 ? area / lineLength : 0;
    }

    const simplifiedPoints = douglasPecker(points, tolerance);
    const simplifiedPath = [];
    simplifiedPoints.forEach((point, i) => {
      simplifiedPath.push([i === 0 ? 'M' : 'L', point.x, point.y]);
    });

    return simplifiedPath;
  }

  // 20. –ü–†–ò–í–Ø–ó–ö–ê –û–ë–™–ï–ö–¢–û–í –ö –°–ï–¢–ö–ï
  canvas.on('object:moving', function(options) {
    const obj = options.target;
    const gridSize = 20;

    obj.set({
      left: snapToGrid(obj.left, gridSize),
      top: snapToGrid(obj.top, gridSize)
    });
    obj.setCoords();
  });

  // 21. –í–´–ë–û–† –û–ë–™–ï–ö–¢–ê –ò –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–ê–ù–ï–õ–ò –°–í–û–ô–°–¢–í
  canvas.on('selection:created', function() {
    updatePropertiesPanel();
  });

  canvas.on('selection:updated', function() {
    updatePropertiesPanel();
  });

  canvas.on('selection:cleared', function() {
    updatePropertiesPanel();
  });

  // 22. –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –°–í–û–ô–°–¢–í –õ–ò–ù–ò–ò
  function showLinePropertiesModal() {
    const activeObject = canvas.getActiveObject();
    if (!activeObject || activeObject.type !== 'line') {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –ª–∏–Ω–∏—é –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤.');
      return;
    }

    currentEditingLine = activeObject;
    const props = activeObject.properties || {
      name: '–õ–∏–Ω–∏—è',
      L: 0.5,
      I: 0.015,
      K: 10,
      W: 1.0,
      length: 0
    };

    document.getElementById('propertyL').value = props.L;
    document.getElementById('propertyI').value = props.I;
    document.getElementById('propertyK').value = props.K;
    document.getElementById('propertyW').value = props.W;
    document.getElementById('propertyName').value = props.name;
    document.getElementById('propertyColor').value = activeObject.stroke || '#2a9d8f';
    document.getElementById('propertyWidth').value = activeObject.strokeWidth || 2;

    document.getElementById('linePropertiesModal').style.display = 'flex';
  }

  function closeLinePropertiesModal() {
    document.getElementById('linePropertiesModal').style.display = 'none';
    currentEditingLine = null;
  }

  document.getElementById('linePropertiesForm').onsubmit = function(e) {
    e.preventDefault();

    if (!currentEditingLine) return false;

    const newProperties = {
      name: document.getElementById('propertyName').value,
      L: parseFloat(document.getElementById('propertyL').value),
      I: parseFloat(document.getElementById('propertyI').value),
      K: parseFloat(document.getElementById('propertyK').value),
      W: parseFloat(document.getElementById('propertyW').value),
      length: currentEditingLine.properties?.length ||
        Math.sqrt(
          Math.pow(currentEditingLine.x2 - currentEditingLine.x1, 2) +
          Math.pow(currentEditingLine.y2 - currentEditingLine.y1, 2)
        )
    };

    currentEditingLine.set({
      stroke: document.getElementById('propertyColor').value,
      strokeWidth: parseInt(document.getElementById('propertyWidth').value),
      properties: newProperties
    });

    canvas.renderAll();
    updatePropertiesPanel();
    closeLinePropertiesModal();

    console.log('–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –ª–∏–Ω–∏–∏:', newProperties);
    return false;
  };

  // 23. –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –°–í–û–ô–°–¢–í –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø
  function showImagePropertiesModal() {
    const activeObject = canvas.getActiveObject();
    if (!activeObject || activeObject.type !== 'image') {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤.');
      return;
    }

    currentEditingImage = activeObject;
    const props = activeObject.properties || {
      name: activeObject.imageName || '–û–±—ä–µ–∫—Ç',
      paramA: 0,
      paramB: 0,
      paramC: 0,
      paramD: 0,
      paramE: 0,
      paramF: 0,
      scale: 1
    };

    document.getElementById('imgPropertyName').value = props.name;
    document.getElementById('imgPropertyA').value = props.paramA;
    document.getElementById('imgPropertyB').value = props.paramB;
    document.getElementById('imgPropertyC').value = props.paramC;
    document.getElementById('imgPropertyD').value = props.paramD;
    document.getElementById('imgPropertyE').value = props.paramE;
    document.getElementById('imgPropertyF').value = props.paramF;
    document.getElementById('imgPropertyScale').value = props.scale || 1;

    document.getElementById('imagePropertiesModal').style.display = 'flex';
  }

  function closeImagePropertiesModal() {
    document.getElementById('imagePropertiesModal').style.display = 'none';
    currentEditingImage = null;
  }

  document.getElementById('imagePropertiesForm').onsubmit = function(e) {
    e.preventDefault();

    if (!currentEditingImage) return false;

    const newProperties = {
      name: document.getElementById('imgPropertyName').value,
      paramA: parseFloat(document.getElementById('imgPropertyA').value) || 0,
      paramB: parseFloat(document.getElementById('imgPropertyB').value) || 0,
      paramC: parseFloat(document.getElementById('imgPropertyC').value) || 0,
      paramD: parseFloat(document.getElementById('imgPropertyD').value) || 0,
      paramE: parseFloat(document.getElementById('imgPropertyE').value) || 0,
      paramF: parseFloat(document.getElementById('imgPropertyF').value) || 0,
      scale: parseFloat(document.getElementById('imgPropertyScale').value) || 1
    };

    currentEditingImage.set({
      properties: newProperties,
      scaleX: newProperties.scale * 0.5,
      scaleY: newProperties.scale * 0.5
    });

    canvas.renderAll();
    updatePropertiesPanel();
    closeImagePropertiesModal();

    console.log('–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', newProperties);
    return false;
  };

  // 24. –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–ê–ù–ï–õ–ò –°–í–û–ô–°–¢–í
  function updatePropertiesPanel() {
    const activeObj = canvas.getActiveObject();
    const propsContent = document.getElementById('props-content');

    if (!activeObj) {
      propsContent.innerHTML = `
        <p style="color: #7f8c8d; font-style: italic; text-align: center; padding: 20px;">
          –í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç –Ω–∞ —á–µ—Ä—Ç–µ–∂–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤
        </p>
      `;
      return;
    }

    let content = `
      <div class="property-group">
        <h4>üìÑ –û—Å–Ω–æ–≤–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞</h4>
        <div class="property-row">
          <div class="property-label">–¢–∏–ø:</div>
          <div class="property-value"><strong>${activeObj.type}</strong></div>
        </div>
        <div class="property-row">
          <div class="property-label">–ü–æ–∑–∏—Ü–∏—è X:</div>
          <div class="property-value">${Math.round(activeObj.left || activeObj.x1 || 0)}px</div>
        </div>
        <div class="property-row">
          <div class="property-label">–ü–æ–∑–∏—Ü–∏—è Y:</div>
          <div class="property-value">${Math.round(activeObj.top || activeObj.y1 || 0)}px</div>
        </div>
    `;

    if (activeObj.type === 'rect') {
      content += `
        <div class="property-row">
          <div class="property-label">–®–∏—Ä–∏–Ω–∞:</div>
          <div class="property-value">${Math.round(activeObj.width)}px</div>
        </div>
        <div class="property-row">
          <div class="property-label">–í—ã—Å–æ—Ç–∞:</div>
          <div class="property-value">${Math.round(activeObj.height)}px</div>
        </div>
      `;
    } else if (activeObj.type === 'circle') {
      content += `
        <div class="property-row">
          <div class="property-label">–†–∞–¥–∏—É—Å:</div>
          <div class="property-value">${Math.round(activeObj.radius)}px</div>
        </div>
      `;
    } else if (activeObj.type === 'line') {
      const length = Math.sqrt(
        Math.pow(activeObj.x2 - activeObj.x1, 2) +
        Math.pow(activeObj.y2 - activeObj.y1, 2)
      );
      content += `
        <div class="property-row">
          <div class="property-label">–î–ª–∏–Ω–∞:</div>
          <div class="property-value">${Math.round(length)}px</div>
        </div>
      `;

      if (activeObj.properties) {
        content += `
          <div class="property-group" style="border-left-color: #2a9d8f;">
            <h4>üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h4>
            <div class="property-row">
              <div class="property-label">–ù–∞–∑–≤–∞–Ω–∏–µ:</div>
              <div class="property-value">${activeObj.properties.name}</div>
            </div>
            <div class="property-row">
              <div class="property-label">L (–º¬≤):</div>
              <div class="property-value">${activeObj.properties.L.toFixed(4)}</div>
            </div>
            <div class="property-row">
              <div class="property-label">I:</div>
              <div class="property-value">${activeObj.properties.I.toFixed(6)}</div>
            </div>
            <div class="property-row">
              <div class="property-label">K (–º):</div>
              <div class="property-value">${activeObj.properties.K.toFixed(3)}</div>
            </div>
            <div class="property-row">
              <div class="property-label">W (–∫–≥/–º):</div>
              <div class="property-value">${activeObj.properties.W.toFixed(2)}</div>
            </div>
          </div>
        `;
      }
    } else if (activeObj.type === 'image') {
      content += `
        <div class="property-row">
          <div class="property-label">–ù–∞–∑–≤–∞–Ω–∏–µ:</div>
          <div class="property-value">${activeObj.imageName || '–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'}</div>
        </div>
        <div class="property-row">
          <div class="property-label">–†–∞–∑–º–µ—Ä:</div>
          <div class="property-value">${Math.round((activeObj.width * activeObj.scaleX) || 0)}√ó${Math.round((activeObj.height * activeObj.scaleY) || 0)}px</div>
        </div>
      `;

      if (activeObj.properties) {
        content += `
          <div class="property-group" style="border-left-color: #9b59b6;">
            <h4>üìä –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—ä–µ–∫—Ç–∞</h4>
            <div class="property-row">
              <div class="property-label">–ù–∞–∑–≤–∞–Ω–∏–µ:</div>
              <div class="property-value">${activeObj.properties.name}</div>
            </div>
            <div class="property-row">
              <div class="property-label">–ü–∞—Ä–∞–º–µ—Ç—Ä A:</div>
              <div class="property-value">${activeObj.properties.paramA}</div>
            </div>
            <div class="property-row">
              <div class="property-label">–ü–∞—Ä–∞–º–µ—Ç—Ä B:</div>
              <div class="property-value">${activeObj.properties.paramB}</div>
            </div>
            <div class="property-row">
              <div class="property-label">–ü–∞—Ä–∞–º–µ—Ç—Ä C:</div>
              <div class="property-value">${activeObj.properties.paramC}</div>
            </div>
            <div class="property-row">
              <div class="property-label">–ü–∞—Ä–∞–º–µ—Ç—Ä D:</div>
              <div class="property-value">${activeObj.properties.paramD}</div>
            </div>
            <div class="property-row">
              <div class="property-label">–ü–∞—Ä–∞–º–µ—Ç—Ä E:</div>
              <div class="property-value">${activeObj.properties.paramE}</div>
            </div>
            <div class="property-row">
              <div class="property-label">–ü–∞—Ä–∞–º–µ—Ç—Ä F:</div>
              <div class="property-value">${activeObj.properties.paramF}</div>
            </div>
            <div class="property-row">
              <div class="property-label">–ú–∞—Å—à—Ç–∞–±:</div>
              <div class="property-value">${(activeObj.properties.scale * 100).toFixed(0)}%</div>
            </div>
          </div>
        `;
      }
    }

    content += `
      <div style="margin-top: 15px; text-align: center;">
        <button onclick="${activeObj.type === 'line' ? 'showLinePropertiesModal()' : activeObj.type === 'image' ? 'showImagePropertiesModal()' : 'alert(\'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤ –¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–∏–Ω–∏–π –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π\')'}"
                style="padding: 8px 16px; font-size: 13px;">
          ${activeObj.type === 'line' ? '‚öôÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ª–∏–Ω–∏–∏' :
      activeObj.type === 'image' ? 'üñºÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±—ä–µ–∫—Ç–∞' :
        '–¢–æ–ª—å–∫–æ –¥–ª—è –ª–∏–Ω–∏–π –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π'}
        </button>
      </div>
    `;

    propsContent.innerHTML = content;
  }

  // 25. –ì–û–†–Ø–ß–ò–ï –ö–õ–ê–í–ò–®–ò
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      if (isContinuousLineMode && isDrawingLine) {
        lineStartPoint = lastLineEndPoint ? { ...lastLineEndPoint } : null;
        if (previewLine && lineStartPoint) {
          previewLine.set({
            x1: lineStartPoint.x,
            y1: lineStartPoint.y,
            x2: lineStartPoint.x,
            y2: lineStartPoint.y
          });
          document.getElementById('status').innerHTML =
            '–¢–µ–∫—É—â–∞—è –ª–∏–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞. –ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—É—é –æ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ç–æ—á–∫–∏.';
        }
      } else {
        deactivateAllModes();
        document.getElementById('status').innerHTML = '–†–µ–∂–∏–º –æ—Ç–º–µ–Ω–µ–Ω.';
      }
    }

    if (event.key === 'Delete' || event.key === 'Backspace') {
      const activeObject = canvas.getActiveObject();
      if (activeObject && activeObject.id !== 'grid-group') {
        canvas.remove(activeObject);
        updateStatus();
        updatePropertiesPanel();
      }
    }

    if (event.ctrlKey && event.key === 's') {
      event.preventDefault();
      saveDrawing();
    }

    if (event.ctrlKey && event.shiftKey && event.key === 'S') {
      event.preventDefault();
      splitLinesAtIntersections();
    }

    if (event.ctrlKey && event.key === 'o') {
      event.preventDefault();
      loadDrawing();
    }

    if (event.key === 'i' || event.key === 'I') {
      event.preventDefault();
      findIntersectionsOnly();
    }

    if (event.ctrlKey && event.key === 'z') {
      event.preventDefault();
      const objects = canvas.getObjects().filter(obj => obj.id !== 'grid-group');
      if (objects.length > 0) {
        const lastObj = objects[objects.length - 1];
        if (lastObj.type === 'line') {
          const lines = objects.filter(obj => obj.type === 'line' && obj.id !== 'grid-line');
          if (lines.length > 1) {
            const prevLine = lines[lines.length - 2];
            lastLineEndPoint = { x: prevLine.x2, y: prevLine.y2 };
          } else {
            lastLineEndPoint = null;
          }
        }
        canvas.remove(lastObj);
        updateStatus();
        updatePropertiesPanel();
      }
    }

    if (event.key === 'c' || event.key === 'C') {
      event.preventDefault();
      toggleContinuousMode();
    }

    if (event.key === 'p' || event.key === 'P') {
      event.preventDefault();
      const activeObj = canvas.getActiveObject();
      if (activeObj && activeObj.type === 'line') {
        showLinePropertiesModal();
      } else if (activeObj && activeObj.type === 'image') {
        showImagePropertiesModal();
      }
    }

    // –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (1-9)
    if (event.key >= '1' && event.key <= '9' && !event.ctrlKey && !event.shiftKey) {
      const index = parseInt(event.key) - 1;
      if (index < imageData.length) {
        const img = imageData[index];
        selectImageType(img.id, img.url, img.name);
      }
    }
  });

  // 26. –≠–ö–°–ü–û–†–¢ –í –ö–û–ù–°–û–õ–¨
  function exportToConsole() {
    const objects = canvas.getObjects().filter(obj => obj.id !== 'grid-group' && obj.id !== 'grid-line');
    const exportData = {
      timestamp: new Date().toISOString(),
      totalObjects: objects.length,
      objects: []
    };

    objects.forEach((obj, index) => {
      const objData = {
        id: index + 1,
        type: obj.type,
        position: {
          x: obj.left || obj.x1,
          y: obj.top || obj.y1
        },
        properties: obj.properties || {}
      };

      if (obj.type === 'rect') {
        objData.dimensions = {
          width: obj.width,
          height: obj.height
        };
      } else if (obj.type === 'circle') {
        objData.dimensions = {
          radius: obj.radius
        };
      } else if (obj.type === 'line') {
        objData.dimensions = {
          x1: obj.x1,
          y1: obj.y1,
          x2: obj.x2,
          y2: obj.y2,
          length: Math.sqrt(Math.pow(obj.x2 - obj.x1, 2) + Math.pow(obj.y2 - obj.y1, 2))
        };
      } else if (obj.type === 'image') {
        objData.imageType = obj.imageType;
        objData.imageName = obj.imageName;
      }

      exportData.objects.push(objData);
    });

    console.log('üìä –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä—Ç–µ–∂–∞:', exportData);
    console.table(exportData.objects.map(obj => ({
      'ID': obj.id,
      '–¢–∏–ø': obj.type,
      'X': Math.round(obj.position.x),
      'Y': Math.round(obj.position.y),
      '–ü–∞—Ä–∞–º–µ—Ç—Ä—ã': obj.properties.name || '–ù–µ—Ç'
    })));

    document.getElementById('status').innerHTML =
      `–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ –∫–æ–Ω—Å–æ–ª—å. –í—Å–µ–≥–æ –æ–±—ä–µ–∫—Ç–æ–≤: ${objects.length}`;
  }

  // 27. –°–û–•–†–ê–ù–ï–ù–ò–ï –ò –ó–ê–ì–†–£–ó–ö–ê
  function saveDrawing() {
    const json = JSON.stringify(canvas.toJSON(['id', 'properties', 'imageType', 'imageName', 'imageUrl']));
    localStorage.setItem('fabricDrawing', json);

    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `—á–µ—Ä—Ç–µ–∂-${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    document.getElementById('status').innerHTML =
      `‚úÖ –ß–µ—Ä—Ç–µ–∂ —Å–æ—Ö—Ä–∞–Ω–µ–Ω! (${canvas.getObjects().filter(obj => obj.id !== 'grid-group' && obj.id !== 'grid-line').length} –æ–±—ä–µ–∫—Ç–æ–≤)`;
  }

  function loadDrawing() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';

    input.onchange = function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const json = event.target.result;
          deactivateAllModes();
          canvas.clear();
          drawGrid(20);

          // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
          canvas.loadFromJSON(json, function() {
            canvas.renderAll.bind(canvas);

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –∏—Ö —Å–≤–æ–π—Å—Ç–≤–∞–º–∏
            canvas.getObjects().forEach(obj => {
              if (obj.type === 'image' && obj.imageUrl) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å
                if (!obj._element) {
                  fabric.Image.fromURL(obj.imageUrl, function(img) {
                    img.set({
                      left: obj.left,
                      top: obj.top,
                      scaleX: obj.scaleX,
                      scaleY: obj.scaleY,
                      angle: obj.angle,
                      originX: 'center',
                      originY: 'center',
                      hasControls: true,
                      hasBorders: true,
                      selectable: true,
                      properties: obj.properties,
                      imageType: obj.imageType,
                      imageName: obj.imageName,
                      imageUrl: obj.imageUrl
                    });

                    canvas.remove(obj);
                    canvas.add(img);
                    canvas.renderAll();
                  });
                }
              }
            });

            const lines = canvas.getObjects().filter(obj =>
              obj.type === 'line' && obj.id !== 'grid-line'
            );

            if (lines.length > 0) {
              const lastLine = lines[lines.length - 1];
              lastLineEndPoint = { x: lastLine.x2, y: lastLine.y2 };
            }

            canvas.renderAll();
            updateStatus();
            updatePropertiesPanel();
            document.getElementById('status').innerHTML += ' | –ß–µ—Ä—Ç–µ–∂ –∑–∞–≥—Ä—É–∂–µ–Ω.';
          });
        } catch (error) {
          alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + error.message);
        }
      };
      reader.readAsText(file);
    };

    input.click();
  }

  function clearCanvas() {
    if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã —Å —á–µ—Ä—Ç–µ–∂–∞?')) {
      deactivateAllModes();
      lastLineEndPoint = null;
      selectedImageType = null;
      document.querySelectorAll('.image-button').forEach(btn => {
        btn.classList.remove('active');
      });

      canvas.getObjects().forEach(obj => {
        if (obj.id !== 'grid-group') {
          canvas.remove(obj);
        }
      });
      canvas.renderAll();
      updateStatus();
      updatePropertiesPanel();
    }
  }

  // 28. –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–£–°–ê
  function updateStatus(x, y, isDrawing = false) {
    const count = canvas.getObjects().filter(obj =>
      obj.id !== 'grid-group' && obj.id !== 'grid-line'
    ).length;
    const activeObj = canvas.getActiveObject();
    let statusText = `<strong>–û–±—ä–µ–∫—Ç–æ–≤:</strong> ${count}`;

    if (x !== undefined && y !== undefined) {
      statusText += ` | <strong>–ö—É—Ä—Å–æ—Ä:</strong> ${Math.round(x)}, ${Math.round(y)}px`;
    }

    if (activeObj) {
      statusText += ` | <strong>–í—ã–±—Ä–∞–Ω:</strong> ${activeObj.type}`;
      if (activeObj.type === 'rect') {
        statusText += ` ${Math.round(activeObj.width)}√ó${Math.round(activeObj.height)}px`;
      } else if (activeObj.type === 'image') {
        statusText += ` ${activeObj.imageName || ''}`;
      }
    }

    if (isContinuousLineMode) {
      statusText += ' | üîó <strong>–ù–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π —Ä–µ–∂–∏–º</strong>';
    }

    if (selectedImageType) {
      statusText += ` | üñºÔ∏è <strong>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ: ${selectedImageType.name}</strong>`;
    }

    if (!isDrawing) {
      document.getElementById('status').innerHTML = statusText;
    }
  }

  // 29. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
  document.addEventListener('DOMContentLoaded', function() {
    initializeImageButtons();
    updatePropertiesPanel();
    updateStatus();

    console.log('üöÄ –†–µ–¥–∞–∫—Ç–æ—Ä —á–µ—Ä—Ç–µ–∂–µ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!');
    console.log('–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏: ESC, Delete, Ctrl+S, Ctrl+O, Ctrl+Z, C, P, I, Ctrl+Shift+S');
    console.log('–ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä –æ–±—ä–µ–∫—Ç–æ–≤: —Ü–∏—Ñ—Ä—ã 1-9');
  });

  window.addEventListener('resize', function() {
    const container = document.getElementById('canvas-container');
    canvas.setDimensions({
      width: container.clientWidth,
      height: container.clientHeight
    });
    canvas.renderAll();
  });
</script>
</body>
</html>